<!DOCTYPE html>
<!--
Template Name: NobleUI - HTML Bootstrap 5 Admin Dashboard Template
Author: NobleUI
Website: https://nobleui.com
Contact: nobleui.team@gmail.com
Purchase: https://1.envato.market/nobleui_html
License: You must have a valid license to legally use this template for your project.
-->
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="Responsive HTML Admin Dashboard Template based on Bootstrap 5">
	<meta name="author" content="NobleUI">
	<meta name="keywords" content="nobleui, bootstrap, bootstrap 5, bootstrap5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web">

	<title>NobleUI - HTML Bootstrap 5 Admin Dashboard Template</title>

  <!-- color-modes:js -->
  <script src="./assets/js/color-modes.js"></script>
  <!-- endinject -->

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <!-- End fonts -->

	<!-- core:css -->
	<link rel="stylesheet" href="./assets/vendors/core/core.css">
	<!-- endinject -->

 <!-- Plugin css for this page -->
  <link rel="stylesheet" href="./assets/vendors/flatpickr/flatpickr.min.css">
  <link rel="stylesheet" href="./assets/vendors/datatables.net-bs5/dataTables.bootstrap5.css">
  <link rel="stylesheet" href="./assets/vendors/select2/select2.min.css">
 <!-- End plugin css for this page -->

	<!-- inject:css -->
	<!-- endinject -->

 <!-- Layout styles -->  
 <link rel="stylesheet" href="./assets/css/style.css">
  <!-- End layout styles -->

  <style>
    #clientesTable tbody tr {
      cursor: pointer;
    }

    .resizable-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      height: calc(100vh - 280px);
      min-height: 360px;
    }

    .resizable-panel {
      flex: 1 1 0;
      min-height: 140px;
      overflow: auto;
      background-color: transparent;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE y Edge */
    }

    .resizable-panel::-webkit-scrollbar {
      display: none; /* Chrome, Safari y Opera */
    }

    .resizable-panel[data-resizable-bottom] {
      min-height: 0;
      background-color: transparent;
    }

    .resizable-panel[data-resizable-bottom].is-collapsed {
      flex: 0 0 0 !important;
      height: 0 !important;
      min-height: 0 !important;
      width: 0 !important;
      overflow: hidden;
    }

    .resizable-panel[data-resizable-bottom].is-collapsed .card {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .resizable-panel .card-body {
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      background-color: var(--bs-card-bg);
    }

    .resizable-panel .table-responsive {
      flex: 1 1 auto;
      overflow: auto;
    }

    .column-picker-list {
      display: flex;
      flex-direction: column;
      max-height: 320px;
      overflow: hidden;
      gap: 0.5rem;
      padding-right: 0.25rem;
    }

    .column-picker-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.35rem 0;
      padding-left: 0;
    }

    .column-picker-item .form-check-input {
      margin: 0;
      flex-shrink: 0;
    }

    .column-picker-item .form-check-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      cursor: pointer;
    }

    .column-picker-item .badge {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    [data-clientes-columns-empty] {
      color: var(--bs-secondary-color);
    }

    [data-table-responsive="clientes"] th.table-column,
    [data-table-responsive="clientes"] td.table-column {
      vertical-align: middle;
      white-space: nowrap;
    }

    [data-table-responsive="clientes"] th.table-column {
      position: relative;
      cursor: grab;
      user-select: none;
    }

    [data-table-responsive="clientes"] th.table-column:active {
      cursor: grabbing;
    }

    [data-table-responsive="clientes"] th.table-column.table-column--dragging {
      opacity: 0.55;
    }

    [data-table-responsive="clientes"] th.table-column.table-column--drop-target::after {
      content: "";
      position: absolute;
      inset: 4px;
      border: 2px dashed var(--bs-primary);
      border-radius: inherit;
      pointer-events: none;
    }

    @media (max-width: 1399.98px) {
      [data-table-responsive="clientes"] th.table-column--secondary,
      [data-table-responsive="clientes"] td.table-column--secondary {
        display: none !important;
      }
    }

    @media (max-width: 991.98px) {
      [data-table-responsive="clientes"] th.table-column--collapse-md,
      [data-table-responsive="clientes"] td.table-column--collapse-md {
        display: none !important;
      }
    }

    @media (max-width: 767.98px) {
      [data-table-responsive="clientes"] th.table-column--collapse-sm,
      [data-table-responsive="clientes"] td.table-column--collapse-sm {
        display: none !important;
      }
    }

    .resizable-panel[data-resizable-bottom] .card {
      background-color: var(--bs-card-bg);
      overflow: hidden;
    }

    [data-clientes-detail-tabs-wrapper] {
      background-color: var(--bs-card-bg);
      border-radius: inherit;
      padding-bottom: 0.75rem;
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
    }

    [data-clientes-detail-container] {
      position: relative;
      padding: 0 0.75rem 0.75rem;
      background-color: var(--bs-card-bg);
      border-radius: inherit;
      background-clip: padding-box;
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      gap: 0.75rem;
    }

    [data-clientes-detail-container] .tab-pane {
      background-color: inherit;
      padding-top: 0.75rem;
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
    }

    [data-clientes-detail-layout] {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      min-height: 0;
      flex: 1 1 auto;
    }

    [data-clientes-detail-content] {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
      min-width: 0;
      overflow: hidden;
      padding-right: 0.25rem;
      scroll-behavior: smooth;
    }

    [data-clientes-detail-form] {
      padding-right: 0;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      min-height: 0;
      overflow-y: auto;
    }

    .detail-category-tools {
      display: none;
      flex-direction: column;
      gap: 0.75rem;
    }

    .detail-field-search {
      margin-bottom: 1rem;
    }

    .detail-field-search-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .detail-category-nav {
      display: none;
      overflow-y: auto;
      max-height: 100%;
    }

    .detail-category-nav-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      flex: 1 1 auto;
    }

    .detail-category-nav-button {
      width: 100%;
      border: 0;
      background: transparent;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: var(--bs-border-radius);
      color: var(--bs-secondary-color);
      font-size: 0.875rem;
      text-align: left;
      transition: background-color 0.2s ease, color 0.2s ease;
      cursor: pointer;
    }

    .detail-category-nav-button:hover,
    .detail-category-nav-button:focus-visible {
      background-color: rgba(var(--bs-primary-rgb, 99, 102, 241), 0.12);
      color: var(--bs-body-color);
      outline: none;
    }

    .detail-category-nav-button.active {
      background-color: rgba(var(--bs-primary-rgb, 99, 102, 241), 0.18);
      color: var(--bs-primary);
      font-weight: 600;
    }

    .detail-category-nav-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      color: inherit;
    }

    .detail-category-nav-icon .lucide {
      width: 18px;
      height: 18px;
    }

    .detail-category-nav-label {
      flex: 1 1 auto;
      line-height: 1.2;
    }

    .detail-category-nav-heading {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      margin-bottom: 0.25rem;
    }

    .detail-field-highlight {
      animation: detail-field-flash 2.4s ease-out;
      border-radius: 0.375rem;
    }

    .form-control.is-field-invalid,
    .form-select.is-field-invalid {
      border-color: rgba(var(--bs-warning-rgb, 251, 188, 6), 1) !important;
      box-shadow: 0 0 0 0 rgba(var(--bs-warning-rgb, 251, 188, 6), 0.4) !important;
    }

    .modal-shake {
      animation: modal-shake 0.45s ease;
    }

    @keyframes modal-shake {
      0%, 100% {
        transform: translate3d(0, 0, 0);
      }
      20%, 60% {
        transform: translate3d(-8px, 0, 0);
      }
      40%, 80% {
        transform: translate3d(8px, 0, 0);
      }
    }

    @keyframes detail-field-flash {
      0% {
        box-shadow: 0 0 0 0 rgba(var(--bs-warning-rgb, 251, 188, 6), 0.8);
        background-color: rgba(var(--bs-warning-rgb, 251, 188, 6), 0.3);
      }
      20% {
        box-shadow: 0 0 0 9px rgba(var(--bs-warning-rgb, 251, 188, 6), 0.38);
        background-color: rgba(var(--bs-warning-rgb, 251, 188, 6), 0.24);
      }
      45% {
        box-shadow: 0 0 0 14px rgba(var(--bs-warning-rgb, 251, 188, 6), 0.2);
        background-color: rgba(var(--bs-warning-rgb, 251, 188, 6), 0.16);
      }
      75% {
        box-shadow: 0 0 0 18px rgba(var(--bs-warning-rgb, 251, 188, 6), 0.1);
        background-color: rgba(var(--bs-warning-rgb, 251, 188, 6), 0.08);
      }
      100% {
        box-shadow: none;
        background-color: transparent;
      }
    }

    .table-search-highlight {
      color: rgba(var(--bs-warning-rgb, 251, 188, 6), 1);
      font-weight: 700;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 1.25rem;
    }

    .proceso-split-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      height: 100%;
      min-height: 320px;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE y Edge */
    }

    .proceso-split-wrapper::-webkit-scrollbar {
      display: none; /* Chrome, Safari y Opera */
    }

    [data-proceso-form-card] .card-body {
      display: flex;
      flex-direction: column;
      height: 100%;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE y Edge */
    }

    [data-proceso-form-card] .card-body::-webkit-scrollbar {
      display: none; /* Chrome, Safari y Opera */
    }

    [data-proceso-form-card] .proceso-split-wrapper {
      flex: 1 1 auto;
    }

    .proceso-split-panel {
      flex: 1 1 0;
      min-height: 140px;
      border-radius: var(--bs-border-radius);
      background-color: transparent;
      overflow: auto;
    }

    /* Campos vacíos en formulario de proceso - Modo claro */
    /* Usando color Primary de FleetPilot (#6571ff) con opacidad sutil */
    :root:not([data-bs-theme='dark']) [data-proceso-conductor-form] .form-control.field-empty,
    :root:not([data-bs-theme='dark']) [data-proceso-conductor-form] .form-select.field-empty,
    [data-bs-theme='light'] [data-proceso-conductor-form] .form-control.field-empty,
    [data-bs-theme='light'] [data-proceso-conductor-form] .form-select.field-empty {
      background-color: rgba(101, 113, 255, 0.06);
      border-color: rgba(101, 113, 255, 0.3);
    }

    :root:not([data-bs-theme='dark']) [data-proceso-conductor-form] .form-control.field-empty:focus,
    :root:not([data-bs-theme='dark']) [data-proceso-conductor-form] .form-select.field-empty:focus,
    [data-bs-theme='light'] [data-proceso-conductor-form] .form-control.field-empty:focus,
    [data-bs-theme='light'] [data-proceso-conductor-form] .form-select.field-empty:focus {
      background-color: rgba(101, 113, 255, 0.1);
      border-color: rgba(101, 113, 255, 0.45);
      box-shadow: 0 0 0 0.2rem rgba(101, 113, 255, 0.12);
    }

    /* Campos vacíos en formulario de proceso - Modo oscuro */
    /* Usando color Info (#66d1d1) con mayor opacidad para visibilidad en fondo oscuro */
    [data-bs-theme='dark'] [data-proceso-conductor-form] .form-control.field-empty,
    [data-bs-theme='dark'] [data-proceso-conductor-form] .form-select.field-empty {
      background-color: rgba(102, 209, 209, 0.06);
      border-color: rgba(102, 209, 209, 0.22);
    }

    [data-bs-theme='dark'] [data-proceso-conductor-form] .form-control.field-empty:focus,
    [data-bs-theme='dark'] [data-proceso-conductor-form] .form-select.field-empty:focus {
      background-color: rgba(102, 209, 209, 0.1);
      border-color: rgba(102, 209, 209, 0.35);
      box-shadow: 0 0 0 0.2rem rgba(102, 209, 209, 0.12);
    }

    /* Campos Select2 vacíos en formulario de proceso - Modo claro */
    :root:not([data-bs-theme='dark']) [data-proceso-conductor-form] .select2-container.field-empty .select2-selection,
    [data-bs-theme='light'] [data-proceso-conductor-form] .select2-container.field-empty .select2-selection {
      background-color: rgba(101, 113, 255, 0.06) !important;
      border-color: rgba(101, 113, 255, 0.3) !important;
    }

    :root:not([data-bs-theme='dark']) [data-proceso-conductor-form] .select2-container.field-empty.select2-container--focus .select2-selection,
    :root:not([data-bs-theme='dark']) [data-proceso-conductor-form] .select2-container.field-empty.select2-container--open .select2-selection,
    [data-bs-theme='light'] [data-proceso-conductor-form] .select2-container.field-empty.select2-container--focus .select2-selection,
    [data-bs-theme='light'] [data-proceso-conductor-form] .select2-container.field-empty.select2-container--open .select2-selection {
      background-color: rgba(101, 113, 255, 0.1) !important;
      border-color: rgba(101, 113, 255, 0.45) !important;
      box-shadow: 0 0 0 0.2rem rgba(101, 113, 255, 0.12) !important;
    }

    /* Campos Select2 vacíos en formulario de proceso - Modo oscuro */
    [data-bs-theme='dark'] [data-proceso-conductor-form] .select2-container.field-empty .select2-selection {
      background-color: rgba(102, 209, 209, 0.06) !important;
      border-color: rgba(102, 209, 209, 0.22) !important;
    }

    [data-bs-theme='dark'] [data-proceso-conductor-form] .select2-container.field-empty.select2-container--focus .select2-selection,
    [data-bs-theme='dark'] [data-proceso-conductor-form] .select2-container.field-empty.select2-container--open .select2-selection {
      background-color: rgba(102, 209, 209, 0.1) !important;
      border-color: rgba(102, 209, 209, 0.35) !important;
      box-shadow: 0 0 0 0.2rem rgba(102, 209, 209, 0.12) !important;
    }

.proceso-split-panel--top {
  border: 0;
  background-color: rgba(var(--bs-body-bg-rgb, 255, 255, 255), 0.65);
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE y Edge */
}

.proceso-split-panel--top::-webkit-scrollbar {
  display: none; /* Chrome, Safari y Opera */
}

.proceso-split-panel--bottom {
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 1rem;
}

.proceso-split-handle {
      position: relative;
      border: 0;
      background: transparent;
      padding: 0;
      margin: -0.25rem 0;
      height: 10px;
      cursor: row-resize;
      flex: 0 0 auto;
    }

    .proceso-split-handle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(99,102,241,0.35), rgba(14,165,233,0.35));
      transition: background-color 0.2s ease;
    }

    .proceso-split-handle:focus-visible {
      outline: none;
    }

    .proceso-split-handle:focus-visible::before,
    .proceso-split-handle:hover::before {
      background: linear-gradient(90deg, rgba(99,102,241,0.65), rgba(14,165,233,0.65));
    }

    @media (max-width: 1399.98px) {
      .detail-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 991.98px) {
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }

    .detail-grid[data-layout-columns='2'] {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .detail-grid[data-layout-columns='1'] {
      grid-template-columns: 1fr;
    }

    :root:not([data-bs-theme='dark']) .detail-card.card,
    [data-bs-theme='light'] .detail-card.card {
      border: 1px solid rgba(17, 24, 39, 0.08);
      border-radius: var(--bs-border-radius-lg, 0.5rem);
      background-color: #f7f8fa;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    :root:not([data-bs-theme='dark']) .detail-card .card-header,
    :root:not([data-bs-theme='dark']) .detail-card .card-body,
    [data-bs-theme='light'] .detail-card .card-header,
    [data-bs-theme='light'] .detail-card .card-body {
      background-color: transparent;
    }

    [data-bs-theme='dark'] .detail-card.card {
      border: 1px solid var(--bs-border-color);
      background-color: var(--bs-card-bg);
      box-shadow: var(--bs-box-shadow);
    }

    .detail-card .card-header {
      border-bottom: 0;
      padding: 1rem 1rem 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .detail-card .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .detail-card .card-body {
      padding: 1rem;
    }

    .detail-card .card-header + .card-body {
      padding-top: 0.75rem;
    }

    .detail-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(var(--bs-primary-rgb, 99, 102, 241), 0.12);
      color: var(--bs-primary);
      flex-shrink: 0;
    }

    .detail-card-icon .lucide {
      width: 20px;
      height: 20px;
    }

    .detail-group-grid {
      display: grid;
      gap: 1.25rem;
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .detail-group-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .detail-grid-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    :root:not([data-bs-theme='dark']) .detail-grid-item .form-control,
    [data-bs-theme='light'] .detail-grid-item .form-control {
      background-color: #ffffff;
      color: inherit;
      border-color: rgba(15, 23, 42, 0.12);
    }

    :root:not([data-bs-theme='dark']) .detail-grid-item .form-control:focus,
    [data-bs-theme='light'] .detail-grid-item .form-control:focus {
      background-color: #f7f9fc;
      border-color: rgba(99, 102, 241, 0.35);
      box-shadow: 0 0 0 0.15rem rgba(99, 102, 241, 0.08);
    }

    [data-clientes-detail-empty] {
      background-color: var(--bs-card-bg);
      border-radius: inherit;
    }

    .form-check-input:disabled + .form-check-label {
      opacity: 0.55;
    }

    body.user-select-none {
      user-select: none;
    }

    .resizable-handle {
      position: relative;
      flex: 0 0 10px;
      margin: -0.375rem 0;
      width: 100%;
      padding: 0;
      border: 0;
      background: transparent;
      cursor: row-resize;
    }

    .resizable-handle::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(99,102,241,0.35), rgba(14,165,233,0.35));
      transition: background-color 0.2s ease;
    }

    .resizable-handle:focus-visible::before,
    .resizable-handle:hover::before {
      background: linear-gradient(90deg, rgba(99,102,241,0.65), rgba(14,165,233,0.65));
    }

    .resizable-wrapper.view-split-vertical {
      flex-direction: row;
    }

    .resizable-wrapper.view-split-vertical .resizable-panel {
      min-height: 0;
    }

    .resizable-wrapper.view-split-vertical [data-resizable-top] {
      min-width: 280px;
    }

    .resizable-wrapper.view-split-vertical [data-resizable-bottom] {
      min-width: 0;
    }

    .resizable-wrapper.view-split-vertical .resizable-handle {
      width: 12px;
      height: auto;
      min-height: 0;
      margin: 0 -0.375rem;
      cursor: col-resize;
    }

    .resizable-wrapper.view-split-vertical .resizable-handle::before {
      background: linear-gradient(180deg, rgba(99,102,241,0.35), rgba(14,165,233,0.35));
    }

    .resizable-wrapper.view-split-vertical .resizable-handle:focus-visible::before,
    .resizable-wrapper.view-split-vertical .resizable-handle:hover::before {
      background: linear-gradient(180deg, rgba(99,102,241,0.65), rgba(14,165,233,0.65));
    }

    .resizable-wrapper.view-split-vertical [data-clientes-detail-container] {
      overflow: hidden;
    }

    .resizable-wrapper.view-split-vertical [data-clientes-detail-layout] {
      flex-direction: row;
      align-items: stretch;
      gap: 1.5rem;
    }

    .resizable-wrapper.view-split-vertical [data-clientes-detail-content] {
      flex: 1 1 auto;
      min-width: 0;
    }

    .resizable-wrapper.view-split-vertical .detail-category-tools {
      display: flex;
      flex-direction: column;
      flex: 0 0 190px;
      max-width: 220px;
      margin-left: 0.5rem;
      padding-left: 1rem;
      padding-top: 0.25rem;
      border-left: 1px solid var(--bs-border-color);
      height: 100%;
      gap: 0.75rem;
    }

    .resizable-wrapper.view-split-vertical .detail-category-nav {
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      overflow-y: auto;
      gap: 0.75rem;
      height: 100%;
    }

    @media (max-width: 1199.98px) {
      .resizable-wrapper.view-split-vertical .detail-category-nav {
        display: none;
      }
    }

    .treeview {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
      border-radius: var(--bs-border-radius-lg, 0.5rem);
      border: 1px solid var(--bs-border-color);
      background-color: var(--bs-card-bg, var(--bs-body-bg));
    }

    .treeview-body {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      min-height: 120px;
    }

    .treeview-status {
      font-size: 0.85rem;
      color: var(--bs-secondary-color);
    }

    .treeview-search {
      position: relative;
    }

    .treeview-search .form-control {
      padding-left: 2.25rem;
    }

    .treeview-search-icon {
      position: absolute;
      top: 50%;
      left: 0.75rem;
      transform: translateY(-50%);
      color: var(--bs-secondary-color);
      pointer-events: none;
    }

    .treeview-header {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .treeview-list {
      list-style: none;
      margin: 0;
      padding-left: 0;
    }

    .treeview-list .treeview-list {
      margin-left: 1rem;
      padding-left: 0.5rem;
      border-left: 1px solid var(--bs-border-color);
    }

    @media (max-width: 575.98px) {
      .treeview-list .treeview-list {
        margin-left: 0.75rem;
        padding-left: 0.5rem;
      }
    }

    .treeview-item {
      margin: 0.125rem 0;
      padding: 0.125rem 0;
    }

    .treeview-node {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      border-radius: var(--bs-border-radius, 0.375rem);
      padding: 0.375rem 0.5rem;
      color: var(--bs-body-color);
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    .treeview-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: var(--bs-border-radius-circle, 999px);
      background-color: rgba(var(--bs-primary-rgb, 101, 113, 255), 0.08);
      color: var(--bs-primary);
      flex-shrink: 0;
    }

    .treeview-icon .lucide {
      width: 1rem;
      height: 1rem;
    }

    .treeview-node:hover,
    .treeview-node:focus-within {
      background-color: rgba(var(--bs-primary-rgb, 101, 113, 255), 0.08);
      color: var(--bs-primary);
    }

    .treeview-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.75rem;
      height: 1.75rem;
      border: 1px solid transparent;
      border-radius: var(--bs-border-radius-circle, 999px);
      background-color: transparent;
      color: var(--bs-secondary-color);
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    .treeview-toggle::after {
      content: '';
      display: inline-block;
      width: 0.45rem;
      height: 0.45rem;
      border: 0.125rem solid currentColor;
      border-left: 0;
      border-top: 0;
      transform: rotate(-45deg);
      transition: transform 0.2s ease;
    }

    .treeview-item[aria-expanded='true'] > .treeview-node .treeview-toggle::after {
      transform: rotate(45deg);
    }

    .treeview-toggle:hover,
    .treeview-toggle:focus-visible {
      background-color: rgba(var(--bs-primary-rgb, 101, 113, 255), 0.12);
      color: var(--bs-primary);
      border-color: rgba(var(--bs-primary-rgb, 101, 113, 255), 0.25);
    }

    .treeview-toggle--placeholder {
      pointer-events: none;
      border: 1px solid transparent;
    }

    .treeview-toggle--placeholder::after {
      display: none;
    }

    .treeview-node--leaf .treeview-label {
      font-weight: 400;
    }

    .treeview-label {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 500;
      line-height: 1.25;
      background-color: transparent;
      border: 0;
      padding: 0;
      color: inherit;
      text-align: left;
      cursor: default;
    }

    .treeview-label[data-tree-action="navigate"] {
      cursor: pointer;
    }

    .treeview-item.is-collapsed > .treeview-node {
      background-color: transparent;
      color: var(--bs-body-color);
    }

    .treeview-item--match > .treeview-node {
      background-color: rgba(var(--bs-success-rgb, 5, 163, 74), 0.1);
      color: var(--bs-success);
    }

    .treeview-item.is-collapsed > .treeview-node .treeview-toggle::after {
      transform: rotate(-45deg);
    }

    .treeview-item[hidden] {
      display: none !important;
    }

    .treeview-list[hidden] {
      display: none !important;
    }

    @media (prefers-reduced-motion: reduce) {
      .treeview-node,
      .treeview-toggle,
      .treeview-toggle::after {
        transition: none;
      }
    }

    @media (min-width: 1400px) {
      .container-xxxl {
        max-width: 1600px;
      }
    }

    @media (min-width: 1800px) {
      .container-xxxl {
        max-width: 1840px;
      }
    }

    @media (max-width: 991.98px) {
      .resizable-wrapper {
        height: auto;
      }

      .resizable-panel {
        min-height: 220px;
      }

      .resizable-handle {
        display: none;
      }
    }

    #procesoLogTable thead th {
      cursor: pointer;
    }
    #procesoLogTable tbody tr,
    #procesoLogTable tbody tr > * {
      cursor: pointer !important;
    }

    /* Ocultar barra de desplazamiento horizontal de la tabla de histórico */
    #procesoLogTable {
      overflow-x: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE y Edge */
    }
    #procesoLogTable::-webkit-scrollbar {
      display: none; /* Chrome, Safari y Opera */
    }

    /* También ocultar del contenedor table-responsive */
    .table-responsive {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE y Edge */
    }
    .table-responsive::-webkit-scrollbar {
      display: none; /* Chrome, Safari y Opera */
    }

    /* Ocultar spinners del campo edad */
    #procesoEdad::-webkit-outer-spin-button,
    #procesoEdad::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #procesoEdad[type=number] {
      -moz-appearance: textfield;
    }

    /* Estilos para Select2 con allowClear */
    .select2-container--default .select2-selection--single {
      padding-right: 65px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
      padding-right: 55px;
    }

    .select2-container--default .select2-selection--single .select2-selection__clear {
      position: absolute;
      right: 45px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      z-index: 2;
      line-height: 1;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      height: auto;
    }

    /* Estilos personalizados para Flatpickr */
    .flatpickr-calendar {
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      border: 1px solid #e9ecef;
      border-radius: 0.375rem;
      font-family: inherit;
    }

    .flatpickr-day.selected,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange {
      background: #6571ff;
      border-color: #6571ff;
    }

    .flatpickr-day.selected:hover,
    .flatpickr-day.startRange:hover,
    .flatpickr-day.endRange:hover {
      background: #4c59e8;
      border-color: #4c59e8;
    }

    .flatpickr-day:hover {
      background: #e9ecef;
      border-color: #e9ecef;
    }

    .flatpickr-clear {
      padding: 8px 12px;
      text-align: center;
      cursor: pointer;
      color: #6571ff;
      font-size: 14px;
      border-top: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .flatpickr-clear:hover {
      background: #f8f9fa;
    }

    .flatpickr-clear i {
      width: 16px;
      height: 16px;
    }

    /* Cabecera blanca y limpia */
    .flatpickr-months {
      background: white;
    }

    .flatpickr-months .flatpickr-month {
      background: white;
      color: #000;
    }

    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
      color: #6c757d;
    }

    .flatpickr-months .flatpickr-prev-month:hover,
    .flatpickr-months .flatpickr-next-month:hover {
      color: #000;
    }

    .flatpickr-current-month {
      color: #000;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months {
      background: white !important;
      background-color: white !important;
      color: #000 !important;
      border: 1px solid #e9ecef;
      border-radius: 0.25rem;
      padding: 4px 8px;
      font-weight: 500;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months:hover {
      background: white !important;
      background-color: white !important;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months option {
      background: white !important;
      background-color: white !important;
      color: #000 !important;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months .flatpickr-monthDropdown-month {
      background: white !important;
      background-color: white !important;
      color: #000 !important;
    }

    .flatpickr-current-month .numInputWrapper {
      background: white !important;
      background-color: white !important;
    }

    .flatpickr-current-month input.cur-year {
      color: #000;
      font-weight: 500;
      background: white !important;
      background-color: white !important;
    }

    .flatpickr-current-month .numInputWrapper span {
      border-color: #e9ecef;
      color: #6c757d;
    }

    .flatpickr-current-month .numInputWrapper span:hover {
      background: white !important;
      background-color: white !important;
      color: #6c757d;
    }

    .flatpickr-current-month .numInputWrapper:hover {
      background: white !important;
      background-color: white !important;
    }

    /* Días de la semana */
    span.flatpickr-weekday {
      color: #6c757d;
      font-weight: 600;
      background: white;
    }

    /* Día actual */
    .flatpickr-day.today {
      border-color: #6571ff;
    }

    .flatpickr-day.today:hover {
      background: #e9ecef;
      border-color: #6571ff;
    }

    /* Fondo blanco del botón limpiar */
    .flatpickr-clear {
      background: white;
    }

    /* Estilos para Flatpickr en modo oscuro */
    [data-bs-theme='dark'] .flatpickr-calendar {
      background: #1a1d29;
      border-color: #2d3142;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.4);
    }

    [data-bs-theme='dark'] .flatpickr-months {
      background: #1a1d29;
    }

    [data-bs-theme='dark'] .flatpickr-months .flatpickr-month {
      background: #1a1d29;
      color: #fff;
    }

    [data-bs-theme='dark'] .flatpickr-months .flatpickr-prev-month,
    [data-bs-theme='dark'] .flatpickr-months .flatpickr-next-month {
      color: #adb5bd;
      fill: #adb5bd;
    }

    [data-bs-theme='dark'] .flatpickr-months .flatpickr-prev-month:hover,
    [data-bs-theme='dark'] .flatpickr-months .flatpickr-next-month:hover {
      color: #fff;
      fill: #fff;
    }

    [data-bs-theme='dark'] .flatpickr-current-month {
      color: #fff;
    }

    [data-bs-theme='dark'] .flatpickr-current-month .flatpickr-monthDropdown-months {
      background: #2d3142 !important;
      background-color: #2d3142 !important;
      color: #fff !important;
      border-color: #404456;
    }

    [data-bs-theme='dark'] .flatpickr-current-month .flatpickr-monthDropdown-months:hover {
      background: #353849 !important;
      background-color: #353849 !important;
    }

    [data-bs-theme='dark'] .flatpickr-current-month .flatpickr-monthDropdown-months option {
      background: #2d3142 !important;
      background-color: #2d3142 !important;
      color: #fff !important;
    }

    [data-bs-theme='dark'] .flatpickr-current-month .numInputWrapper {
      background: #2d3142 !important;
      background-color: #2d3142 !important;
    }

    [data-bs-theme='dark'] .flatpickr-current-month input.cur-year {
      color: #fff;
      background: #2d3142 !important;
      background-color: #2d3142 !important;
    }

    [data-bs-theme='dark'] .flatpickr-current-month .numInputWrapper span {
      border-color: #404456;
      color: #adb5bd;
    }

    [data-bs-theme='dark'] .flatpickr-current-month .numInputWrapper span:hover {
      background: #353849 !important;
      background-color: #353849 !important;
      color: #fff;
    }

    [data-bs-theme='dark'] span.flatpickr-weekday {
      color: #adb5bd;
      background: #1a1d29;
    }

    [data-bs-theme='dark'] .flatpickr-day {
      color: #fff;
    }

    [data-bs-theme='dark'] .flatpickr-day:hover {
      background: #353849;
      border-color: #353849;
      color: #fff;
    }

    [data-bs-theme='dark'] .flatpickr-day.selected,
    [data-bs-theme='dark'] .flatpickr-day.startRange,
    [data-bs-theme='dark'] .flatpickr-day.endRange {
      background: #6571ff;
      border-color: #6571ff;
      color: #fff;
    }

    [data-bs-theme='dark'] .flatpickr-day.selected:hover,
    [data-bs-theme='dark'] .flatpickr-day.startRange:hover,
    [data-bs-theme='dark'] .flatpickr-day.endRange:hover {
      background: #7c86ff;
      border-color: #7c86ff;
    }

    [data-bs-theme='dark'] .flatpickr-day.today {
      border-color: #6571ff;
      color: #fff;
    }

    [data-bs-theme='dark'] .flatpickr-day.today:hover {
      background: #353849;
      border-color: #6571ff;
    }

    [data-bs-theme='dark'] .flatpickr-day.prevMonthDay,
    [data-bs-theme='dark'] .flatpickr-day.nextMonthDay {
      color: #6c757d;
    }

    [data-bs-theme='dark'] .flatpickr-clear {
      background: #1a1d29;
      border-top-color: #2d3142;
      color: #6571ff;
    }

    [data-bs-theme='dark'] .flatpickr-clear:hover {
      background: #2d3142;
    }

    [data-bs-theme='dark'] .flatpickr-innerContainer {
      background: #1a1d29;
    }

    [data-bs-theme='dark'] .flatpickr-rContainer {
      background: #1a1d29;
    }

    [data-bs-theme='dark'] .flatpickr-days {
      background: #1a1d29;
    }

    /* Contenedor de sección del formulario */
    .form-section-container {
      border-radius: var(--bs-border-radius, 0.375rem);
      padding: 1.25rem;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    /* Modo claro */
    :root:not([data-bs-theme='dark']) .form-section-container,
    [data-bs-theme='light'] .form-section-container {
      background-color: rgba(101, 113, 255, 0.03);
      border: 1px solid rgba(101, 113, 255, 0.08);
    }

    /* Modo oscuro */
    [data-bs-theme='dark'] .form-section-container {
      background-color: rgba(101, 113, 255, 0.03);
      border: 1px solid rgba(101, 113, 255, 0.12);
    }

    /* Ajustar el espaciado del contenedor de campos dentro de la sección */
    .form-section-container > .row {
      margin-top: 0;
    }

    /* Estilos para los títulos de sección del formulario */
    .form-section-title {
      font-size: 1.125rem;
      font-weight: 700;
      letter-spacing: 0.025em;
      padding-bottom: 0.75rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid;
      position: relative;
    }

    /* Modo claro */
    :root:not([data-bs-theme='dark']) .form-section-title,
    [data-bs-theme='light'] .form-section-title {
      color: #1f2937;
      border-bottom-color: rgba(101, 113, 255, 0.12);
    }

    :root:not([data-bs-theme='dark']) .form-section-title::after,
    [data-bs-theme='light'] .form-section-title::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 60px;
      height: 2px;
      background: linear-gradient(90deg, #6571ff, #0ea5e9);
      border-radius: 2px;
    }

    /* Modo oscuro */
    [data-bs-theme='dark'] .form-section-title {
      color: #f3f4f6;
      border-bottom-color: rgba(101, 113, 255, 0.2);
    }

    [data-bs-theme='dark'] .form-section-title::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 60px;
      height: 2px;
      background: linear-gradient(90deg, #818cf8, #38bdf8);
      border-radius: 2px;
    }

    /* Estilos del asistente de formulario */
    .wizard-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }

    .wizard-content {
      flex: 1 1 auto;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 1rem;
      padding-bottom: 5rem; /* Espacio para la navegación fija */
    }

    .wizard-page {
      display: none;
      animation-duration: 0.3s;
      animation-fill-mode: both;
    }

    .wizard-page.active {
      display: block;
    }

    /* Animaciones slide */
    @keyframes slideInFromRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOutToLeft {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-100%);
      }
    }

    @keyframes slideOutToRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .wizard-page.slide-in-right {
      animation-name: slideInFromRight;
    }

    .wizard-page.slide-in-left {
      animation-name: slideInFromLeft;
    }

    /* Navegación del asistente */
    .wizard-navigation {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem 1rem 1.5rem 1rem;
      background: var(--bs-body-bg);
      border-top: 1px solid var(--bs-border-color);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      z-index: 10;
    }

    .wizard-step-button {
      min-width: 160px;
      height: 44px;
      border-radius: 22px;
      border: 2px solid #6571ff;
      background: transparent;
      color: #6571ff;
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0.5rem 1.25rem;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .wizard-step-button::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--progress, 0%);
      background: rgba(101, 113, 255, 0.15);
      border-radius: 20px;
      transition: width 0.3s ease;
      z-index: -1;
    }

    .wizard-step-button:hover {
      transform: scale(1.02);
    }

    .wizard-step-button:hover::before {
      background: rgba(101, 113, 255, 0.2);
    }

    .wizard-step-button:focus-visible {
      outline: 2px solid #6571ff;
      outline-offset: 2px;
    }

    /* Botón activo (página actual) - Con texto subrayado y negrita */
    .wizard-step-button.active {
      font-weight: 700;
      position: relative;
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 4px;
    }

    .wizard-step-button.active::before {
      background: rgba(101, 113, 255, 0.3);
    }

    /* Botón activo cuando está completado - color verde */
    .wizard-step-button.active.completed,
    .wizard-step-button.completed.active {
      color: #05a34a !important;
      border-color: #05a34a !important;
    }

    .wizard-step-button.active.completed::before {
      background: rgba(5, 163, 74, 0.3);
    }

    /* Botón activo cuando está publicado (sin 100%) - color verde */
    .wizard-step-button.active.published,
    .wizard-step-button.published.active {
      color: #05a34a !important;
      border-color: #05a34a !important;
    }

    .wizard-step-button.active.published::before {
      background: rgba(5, 163, 74, 0.3);
    }

    /* Estado completado al 100% - Modo claro */
    .wizard-step-button.completed {
      border-color: #05a34a;
      color: #05a34a;
      padding-right: 3rem;
    }

    .wizard-step-button.completed::before {
      background: rgba(5, 163, 74, 0.2);
    }

    .wizard-step-button.completed:hover::before {
      background: rgba(5, 163, 74, 0.25);
    }

    /* Icono de check para botones completados */
    .wizard-step-button.completed::after {
      content: '✓';
      position: absolute;
      right: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.125rem;
      font-weight: 700;
      color: #05a34a;
      z-index: 1;
      box-shadow: none;
    }

    /* Sobrescribir el ::after del botón activo cuando está completado */
    .wizard-step-button.completed.active::after,
    .wizard-step-button.active.completed::after {
      content: '✓';
      position: absolute;
      right: 0.875rem;
      top: 50%;
      left: auto;
      bottom: auto;
      transform: translateY(-50%);
      font-size: 1.125rem;
      font-weight: 700;
      color: #05a34a;
      z-index: 1;
      box-shadow: none;
      border-radius: 0;
      pointer-events: auto;
    }

    /* Estado publicado (sin 100%) - Modo claro */
    .wizard-step-button.published {
      border-color: #05a34a;
      color: #05a34a;
    }

    .wizard-step-button.published::before {
      background: rgba(5, 163, 74, 0.2);
    }

    .wizard-step-button.published:hover::before {
      background: rgba(5, 163, 74, 0.25);
    }

    /* Animación de celebración al completar */
    @keyframes celebration {
      0% {
        transform: scale(1);
      }
      15% {
        transform: scale(1.1);
      }
      30% {
        transform: scale(0.98);
      }
      45% {
        transform: scale(1.05);
      }
      60% {
        transform: scale(1);
      }
    }

    @keyframes checkPop {
      0% {
        transform: translateY(-50%) scale(0);
        opacity: 0;
      }
      50% {
        transform: translateY(-50%) scale(1.3);
      }
      100% {
        transform: translateY(-50%) scale(1);
        opacity: 1;
      }
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 5px rgba(5, 163, 74, 0.4);
      }
      50% {
        box-shadow: 0 0 20px rgba(5, 163, 74, 0.6), 0 0 30px rgba(5, 163, 74, 0.3);
      }
    }

    .wizard-step-button.just-completed {
      animation: celebration 0.6s ease-out, glow 0.6s ease-out;
    }

    .wizard-step-button.just-completed::after {
      animation: checkPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    /* Modo oscuro */
    [data-bs-theme='dark'] .wizard-step-button {
      border-color: #818cf8;
      color: #818cf8;
    }

    [data-bs-theme='dark'] .wizard-step-button::before {
      background: rgba(129, 140, 248, 0.2);
    }

    [data-bs-theme='dark'] .wizard-step-button:hover::before {
      background: rgba(129, 140, 248, 0.25);
    }

    /* Botón activo (página actual) - Modo oscuro */
    [data-bs-theme='dark'] .wizard-step-button.active::before {
      background: rgba(129, 140, 248, 0.35);
    }

    /* Botón activo cuando está completado - Modo oscuro con color verde */
    [data-bs-theme='dark'] .wizard-step-button.active.completed,
    [data-bs-theme='dark'] .wizard-step-button.completed.active {
      color: #10b981 !important;
      border-color: #10b981 !important;
    }

    [data-bs-theme='dark'] .wizard-step-button.active.completed::before {
      background: rgba(16, 185, 129, 0.35);
    }

    /* Botón activo cuando está publicado - Modo oscuro con color verde */
    [data-bs-theme='dark'] .wizard-step-button.active.published,
    [data-bs-theme='dark'] .wizard-step-button.published.active {
      color: #10b981 !important;
      border-color: #10b981 !important;
    }

    [data-bs-theme='dark'] .wizard-step-button.active.published::before {
      background: rgba(16, 185, 129, 0.35);
    }

    /* Estado completado al 100% - Modo oscuro */
    [data-bs-theme='dark'] .wizard-step-button.completed {
      border-color: #10b981;
      color: #10b981;
    }

    [data-bs-theme='dark'] .wizard-step-button.completed::before {
      background: rgba(16, 185, 129, 0.25);
    }

    [data-bs-theme='dark'] .wizard-step-button.completed:hover::before {
      background: rgba(16, 185, 129, 0.3);
    }

    /* Icono de check en modo oscuro */
    [data-bs-theme='dark'] .wizard-step-button.completed::after {
      color: #10b981;
    }

    /* Sobrescribir el ::after del botón activo cuando está completado - Modo oscuro */
    [data-bs-theme='dark'] .wizard-step-button.completed.active::after,
    [data-bs-theme='dark'] .wizard-step-button.active.completed::after {
      content: '✓';
      position: absolute;
      right: 0.875rem;
      top: 50%;
      left: auto;
      bottom: auto;
      transform: translateY(-50%);
      font-size: 1.125rem;
      font-weight: 700;
      color: #10b981;
      z-index: 1;
      box-shadow: none;
      border-radius: 0;
      pointer-events: auto;
    }

    /* Estado publicado (sin 100%) - Modo oscuro */
    [data-bs-theme='dark'] .wizard-step-button.published {
      border-color: #10b981;
      color: #10b981;
    }

    [data-bs-theme='dark'] .wizard-step-button.published::before {
      background: rgba(16, 185, 129, 0.25);
    }

    [data-bs-theme='dark'] .wizard-step-button.published:hover::before {
      background: rgba(16, 185, 129, 0.3);
    }

    /* Animación de glow en modo oscuro */
    @keyframes glowDark {
      0%, 100% {
        box-shadow: 0 0 5px rgba(16, 185, 129, 0.4);
      }
      50% {
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.6), 0 0 30px rgba(16, 185, 129, 0.3);
      }
    }

    [data-bs-theme='dark'] .wizard-step-button.just-completed {
      animation: celebration 0.6s ease-out, glowDark 0.6s ease-out;
    }
  </style>

  <link rel="shortcut icon" href="./assets/images/favicon.png" />
</head>
<body>
	<div class="main-wrapper">

		<!-- partial:partials/_sidebar.html -->
		<nav class="sidebar">
      <div class="sidebar-header">
        <a href="#" class="sidebar-brand">Fleet<span>Pilot</span></a>
        <div class="sidebar-toggler">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      <div class="sidebar-body">
        <ul class="nav" id="sidebarNav">
          <li class="nav-item nav-category" data-i18n="sidebar.category.main">Principal</li>
          <li class="nav-item">
            <a href="dashboard.html" class="nav-link">
              <i class="link-icon" data-lucide="box"></i>
              <span class="link-title" data-i18n="sidebar.link.dashboard">Inicio</span>
            </a>
          </li>
          <li class="nav-item nav-category" data-i18n="sidebar.category.customers">Conductores</li>
          <li class="nav-item">
            <a href="ListaConductores.html" class="nav-link">
              <i class="link-icon" data-lucide="users"></i>
              <span class="link-title" data-i18n="sidebar.category.customersList">Todos los conductores</span>
            </a>
          </li>
          <li class="nav-item nav-category">Inversores</li>
          <li class="nav-item">
            <a href="ListaInversores.html" class="nav-link">
              <i class="link-icon" data-lucide="briefcase"></i>
              <span class="link-title">Todos los inversores</span>
            </a>
          </li>
          <li class="nav-item nav-category">Vehículos</li>
          <li class="nav-item">
            <a href="ListaVehiculos.html" class="nav-link">
              <i class="link-icon" data-lucide="car"></i>
              <span class="link-title">Todos los vehículos</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

		<!-- partial -->
    
    <div class="page-wrapper">
					
			<!-- partial:partials/_navbar.html -->
			<nav class="navbar">
				<div class="navbar-content">

          <div class="logo-mini-wrapper">
            <img src="assets/images/logo-mini-light.png" class="logo-mini logo-mini-light" alt="logo">
            <img src="assets/images/logo-mini-dark.png" class="logo-mini logo-mini-dark" alt="logo">
          </div>

					<form class="search-form" role="search">
						<div class="input-group">
              <div class="input-group-text">
                <i data-lucide="search"></i>
              </div>
							<input type="text" class="form-control" id="navbarForm" placeholder="Search here..." data-i18n-placeholder="navbar.search.placeholder">
						</div>
            <div class="search-panel" role="dialog" aria-modal="false" aria-hidden="true">
              <ul class="nav nav-tabs search-panel-tabs" id="navbarSearchTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="navbar-search-tab-drivers" data-bs-toggle="tab" data-bs-target="#navbar-search-pane-drivers" type="button" role="tab" aria-controls="navbar-search-pane-drivers" aria-selected="true">
                    Conductores
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="navbar-search-tab-investors" data-bs-toggle="tab" data-bs-target="#navbar-search-pane-investors" type="button" role="tab" aria-controls="navbar-search-pane-investors" aria-selected="false">
                    Inversores
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="navbar-search-tab-vehicles" data-bs-toggle="tab" data-bs-target="#navbar-search-pane-vehicles" type="button" role="tab" aria-controls="navbar-search-pane-vehicles" aria-selected="false">
                    Vehículos
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="navbar-search-tab-global" data-bs-toggle="tab" data-bs-target="#navbar-search-pane-global" type="button" role="tab" aria-controls="navbar-search-pane-global" aria-selected="false">
                    En todo FleetPilot
                  </button>
                </li>
              </ul>
              <div class="tab-content search-panel-content">
                <div class="tab-pane fade show active" id="navbar-search-pane-drivers" role="tabpanel" aria-labelledby="navbar-search-tab-drivers">
                  <div class="search-panel-intro">
                    <p class="search-panel-placeholder mb-3">
                      Empieza a escribir para buscar conductores o ordena por columna.
                    </p>
                  </div>
                  <div class="search-panel-table-wrapper">
                    <table class="table table-hover table-striped align-middle mb-0 search-panel-table" data-search-panel-table="drivers">
                      <thead class="bg-body-tertiary">
                        <tr>
                          <th scope="col">NOMBRECOMPLETO</th>
                          <th scope="col">NDOCUMENTOIDENTIDAD</th>
                          <th scope="col">ESTADO</th>
                          <th scope="col">NOMBREINVERSOR</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr data-search-panel-loading class="d-none">
                          <td colspan="4" class="text-secondary text-center py-4">Cargando conductores...</td>
                        </tr>
                        <tr data-search-panel-error class="d-none">
                          <td colspan="4" class="text-danger text-center py-4">No se pudieron cargar los conductores.</td>
                        </tr>
                        <tr data-search-panel-empty>
                          <td colspan="4" class="text-secondary text-center py-4">Sin resultados disponibles.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="tab-pane fade" id="navbar-search-pane-investors" role="tabpanel" aria-labelledby="navbar-search-tab-investors">
                  <p class="search-panel-placeholder">
                    Empieza a escribir para buscar inversores.
                  </p>
                </div>
                <div class="tab-pane fade" id="navbar-search-pane-vehicles" role="tabpanel" aria-labelledby="navbar-search-tab-vehicles">
                  <p class="search-panel-placeholder">
                    Empieza a escribir para buscar vehículos.
                  </p>
                </div>
                <div class="tab-pane fade" id="navbar-search-pane-global" role="tabpanel" aria-labelledby="navbar-search-tab-global">
                  <p class="search-panel-placeholder">
                    Escribe para buscar en todo FleetPilot.
                  </p>
                </div>
              </div>
            </div>
						</form>

					<ul class="navbar-nav">
            <li class="theme-switcher-wrapper nav-item">
              <input type="checkbox" value="" id="theme-switcher">
              <label for="theme-switcher">
                <div class="box">
                  <div class="ball"></div>
                  <div class="icons">
                    <i data-lucide="sun"></i>
                    <i data-lucide="moon"></i>
                  </div>
                </div>
              </label>
            </li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i data-lucide="bell"></i>
                <!--
								<div class="indicator">
									<div class="circle"></div>
								</div>
                 -->
							</a>
							<div class="dropdown-menu p-0" aria-labelledby="notificationDropdown">
								<div class="px-3 py-2 d-flex align-items-center justify-content-between border-bottom">
							<p data-i18n="navbar.dropdown.notifications">Sin notificaciones</p>
              
						</div>
								<div class="px-3 py-2 d-flex align-items-center justify-content-center border-top">
									<a href="javascript:;" class="text-secondary" data-i18n="navbar.dropdown.clear">Clear all</a>
								</div>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<img class="w-30px h-30px ms-1 rounded-circle" data-auth-avatar data-avatar-size="128" src="https://ui-avatars.com/api/?name=User&background=6571ff&color=fff&size=128" alt="profile">
							</a>
							<div class="dropdown-menu p-0" aria-labelledby="profileDropdown">
								<div class="d-flex flex-column align-items-center border-bottom px-5 py-3">
									<div class="mb-3">
										<img class="w-80px h-80px rounded-circle" data-auth-avatar data-avatar-size="256" src="https://ui-avatars.com/api/?name=User&background=6571ff&color=fff&size=256" alt="">
									</div>
									<div class="text-center">
										<p class="fs-16px fw-bolder" data-auth-user data-default-value="Amiah Burton">Amiah Burton</p>
									</div>
								</div>
                <ul class="list-unstyled p-1">
                  <li>
                    <a href="javascript:;" class="dropdown-item py-2 text-body ms-0" data-auth-action="logout">
                      <i class="me-2 icon-md" data-lucide="log-out"></i>
                      <span data-i18n="navbar.user.logout">Log Out</span>
                    </a>
                  </li>
                </ul>
							</div>
						</li>
					</ul>

          <a href="#" class="sidebar-toggler">
            <i data-lucide="menu"></i>
          </a>

				</div>
			</nav>

			<!-- partial -->
	      <div class="page-content container-xxl container-xxxl py-4 py-lg-5">
        <div class="row g-4">
          <div class="col-12">
            <div class="d-flex flex-wrap align-items-center gap-3 mb-4">

              <div>
                <h1 class="h4 mb-0" data-clientes-title>Conductores</h1>
                <p class="text-secondary mb-0" data-clientes-subtitle>Gestiona y analiza la lista de conductores.</p>
              </div>
              <button type="button" class="btn btn-secondary" data-actions-always-visible data-clientes-actions-toggle data-bs-toggle="offcanvas" data-bs-target="#clientesActionsOffcanvas" aria-controls="clientesActionsOffcanvas">
                Otros procesos
              </button>
              <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
                <div class="alert alert-info mb-0 d-none py-2 px-3" role="status" data-clientes-status></div>
              </div>
            </div>

            <div class="resizable-wrapper" data-resizable-wrapper>
              <div class="resizable-panel" data-resizable-top>
                <div class="card border-0 shadow-sm rounded-3 h-100" data-proceso-form-card>
                  <div class="card-body p-3 p-md-4">
                    <div class="proceso-split-wrapper" data-proceso-side-wrapper>
                      <div class="d-flex align-items-center justify-content-end mb-2">
                        <h2 class="h4 mb-0 fw-semibold me-auto d-none" data-proceso-title>Histórico de publicaciones</h2>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                          data-proceso-toggle-top
                          aria-expanded="true"
                          title="Mostrar u ocultar el histórico"
                        >
                          <i data-lucide="chevrons-up"></i>
                          <span data-proceso-toggle-label>Ocultar histórico</span>
                        </button>
                      </div>
                      <div class="proceso-split-panel proceso-split-panel--top d-none" data-proceso-side-top>
                        <div class="card border-0 shadow-sm h-100">
                          <div class="card-body d-flex flex-column p-3 p-md-4">
                            <div class="table-responsive flex-grow-1">
                              <table id="procesoLogTable" class="table table-hover align-middle mb-0">
                                <thead></thead>
                                <tbody></tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                      <button
                        type="button"
                        class="proceso-split-handle d-none"
                        data-proceso-side-handle
                        aria-label="Redimensionar paneles"
                        aria-orientation="horizontal"
                        role="separator"
                        tabindex="0"
                      ></button>
                      <div class="proceso-split-panel proceso-split-panel--bottom" data-proceso-side-bottom>
                        <div class="wizard-container">
                          <div class="wizard-content">
                            <form data-proceso-conductor-form>
                              <!-- Página 1: Datos personales -->
                              <div class="wizard-page active" data-wizard-page="1">
                                <div class="row g-3">
                                  <div class="col-12">
                                    <h5 class="form-section-title">Datos personales</h5>
                                  </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoNombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoNombre"
                              name="nombre"
                              data-field="nombre"
                              autocomplete="given-name"
                              required
                              aria-required="true"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoApellido1" class="form-label">Primer apellido <span class="text-danger">*</span></label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoApellido1"
                              name="apellido1"
                              data-field="apellido1"
                              autocomplete="family-name"
                              required
                              aria-required="true"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoApellido2" class="form-label">Segundo apellido</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoApellido2"
                              name="apellido2"
                              data-field="apellido2"
                              autocomplete="additional-name"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoTipoDocumento" class="form-label">Tipo documento identidad <span class="text-danger">*</span></label>
                            <select
                              class="form-select"
                              id="procesoTipoDocumento"
                              name="tipoDocumentoIdentidad"
                              data-field="tipoDocumentoIdentidad"
                              required
                              aria-required="true"
                            >
                              <option value="">Selecciona un tipo</option>
                              <option value="DNI">DNI</option>
                              <option value="NIE">NIE</option>
                            </select>
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoDocumento" class="form-label">Número documento identidad <span class="text-danger">*</span></label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoDocumento"
                              name="nDocumentoIdentidad"
                              data-field="nDocumentoIdentidad"
                              autocomplete="off"
                              placeholder="Ej: 12345678A"
                              required
                              aria-required="true"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoFechaNacimiento" class="form-label">Fecha de nacimiento</label>
                            <input
                              type="date"
                              class="form-control"
                              id="procesoFechaNacimiento"
                              name="fechaNacimiento"
                              data-field="fechaNacimiento"
                              autocomplete="bday"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoEdad" class="form-label">Edad</label>
                            <input
                              type="number"
                              class="form-control"
                              id="procesoEdad"
                              name="edad"
                              data-field="edad"
                              readonly
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoNAfiliacionSS" class="form-label">Nº Afiliación S.S.</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoNAfiliacionSS"
                              name="nAfiliacionSS"
                              data-field="nAfiliacionSS"
                              placeholder="Ej: 123456789012"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoNacionalidad" class="form-label">Nacionalidad</label>
                            <select
                              class="form-select"
                              id="procesoNacionalidad"
                              name="nacionalidad"
                              data-field="nacionalidad"
                              data-proceso-nacionalidad
                              data-placeholder="Selecciona un país"
                            >
                              <option value="">Selecciona un país</option>
                            </select>
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoNivelFormativo" class="form-label">Nivel formativo</label>
                            <select
                              class="form-select"
                              id="procesoNivelFormativo"
                              name="nivelFormativoTrabajador"
                              data-field="nivelFormativoTrabajador"
                            >
                              <option value="">Selecciona un nivel</option>
                              <option value="Sin estudios">Sin estudios</option>
                              <option value="Estudios primarios">Estudios primarios</option>
                              <option value="Educación secundaria obligatoria">Educación secundaria obligatoria</option>
                              <option value="Bachillerato">Bachillerato</option>
                              <option value="Formación profesional grado medio">Formación profesional grado medio</option>
                              <option value="Formación profesional grado superior">Formación profesional grado superior</option>
                              <option value="Estudios universitarios">Estudios universitarios</option>
                              <option value="Estudios de posgrado">Estudios de posgrado</option>
                            </select>
                          </div>
                                </div>
                              </div>

                              <!-- Página 2: Datos de contacto -->
                              <div class="wizard-page" data-wizard-page="2">
                                <div class="row g-3">
                                  <div class="col-12">
                                    <h5 class="form-section-title">Datos de contacto</h5>
                                  </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoTelefono1" class="form-label">Teléfono 1</label>
                            <input
                              type="tel"
                              class="form-control"
                              id="procesoTelefono1"
                              name="telefono1"
                              data-field="telefono1"
                              inputmode="tel"
                              autocomplete="tel"
                              placeholder="Ej: 612345678"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoTelefono2" class="form-label">Teléfono 2</label>
                            <input
                              type="tel"
                              class="form-control"
                              id="procesoTelefono2"
                              name="telefono2"
                              data-field="telefono2"
                              inputmode="tel"
                              autocomplete="tel"
                              placeholder="Ej: 612345678"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoCorreoPersonal" class="form-label">Correo personal</label>
                            <input
                              type="email"
                              class="form-control"
                              id="procesoCorreoPersonal"
                              name="correoPersonal"
                              data-field="correoPersonal"
                              autocomplete="email"
                              placeholder="ejemplo@correo.com"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoCorreoPlataforma" class="form-label">Correo plataforma</label>
                            <input
                              type="email"
                              class="form-control"
                              id="procesoCorreoPlataforma"
                              name="correoPlataforma"
                              data-field="correoPlataforma"
                              autocomplete="email"
                              placeholder="ejemplo@plataforma.com"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoTelefonoBolt" class="form-label">Teléfono Bolt completo</label>
                            <select
                              class="form-select"
                              id="procesoTelefonoBolt"
                              name="telefonoBoltCompleto"
                              data-field="telefonoBoltCompleto"
                              data-bolt-phone-select
                            >
                              <option value="">Cargando datos...</option>
                            </select>
                          </div>
                                </div>
                              </div>

                              <!-- Página 3: Dirección -->
                              <div class="wizard-page" data-wizard-page="3">
                                <div class="row g-3">
                                  <div class="col-12">
                                    <h5 class="form-section-title">Dirección</h5>
                                  </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoTipoVia" class="form-label">Tipo vía</label>
                            <select
                              class="form-select"
                              id="procesoTipoVia"
                              name="tipoVia"
                              data-field="tipoVia"
                              data-tipo-via-select
                            >
                              <option value="">Selecciona un tipo de vía</option>
                            </select>
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoNombreVia" class="form-label">Nombre vía</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoNombreVia"
                              name="nombreVia"
                              data-field="nombreVia"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoNumero" class="form-label">Número</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoNumero"
                              name="numero"
                              data-field="numero"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoPisoLetra" class="form-label">Piso y letra</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoPisoLetra"
                              name="pisoYLetra"
                              data-field="pisoYLetra"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoCP" class="form-label">Código postal</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoCP"
                              name="cp"
                              data-field="cp"
                              inputmode="numeric"
                              placeholder="Ej: 28001"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoLocalidad" class="form-label">Localidad</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoLocalidad"
                              name="localidad"
                              data-field="localidad"
                            >
                          </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoProvincia" class="form-label">Provincia</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoProvincia"
                              name="provincia"
                              data-field="provincia"
                            >
                          </div>
                                </div>
                              </div>

                              <!-- Página 4: Otros datos -->
                              <div class="wizard-page" data-wizard-page="4">
                                <div class="row g-3">
                                  <div class="col-12">
                                    <h5 class="form-section-title">Otros datos</h5>
                                  </div>
                          <div class="col-12 col-lg-6">
                            <label for="procesoFechaFirma" class="form-label">Fecha de firma</label>
                            <input
                              type="date"
                              class="form-control"
                              id="procesoFechaFirma"
                              name="fechaFirma"
                              data-field="fechaFirma"
                            >
                          </div>
                          <div class="col-12 col-lg-6 d-none">
                            <label for="procesoEstado" class="form-label">Estado</label>
                            <input
                              type="text"
                              class="form-control"
                              id="procesoEstado"
                              name="estado"
                              data-field="estado"
                              readonly
                            >
                          </div>
                                </div>
                              </div>
                            </form>

                            <!-- Botones de acción -->
                            <div class="d-flex justify-content-end gap-2 mt-5">
                              <button type="button" class="btn btn-outline-secondary" data-proceso-cancelar>
                                Cancelar
                              </button>
                              <button type="button" class="btn btn-warning" data-proceso-publicar>
                                Publicar
                              </button>
                            </div>
                          </div>

                          <!-- Navegación del asistente -->
                          <div class="wizard-navigation">
                            <button type="button" class="wizard-step-button active" data-wizard-step="1" aria-label="Ir a Datos personales">
                              Datos personales
                            </button>
                            <button type="button" class="wizard-step-button" data-wizard-step="2" aria-label="Ir a Datos de contacto">
                              Datos de contacto
                            </button>
                            <button type="button" class="wizard-step-button" data-wizard-step="3" aria-label="Ir a Dirección">
                              Dirección
                            </button>
                            <button type="button" class="wizard-step-button" data-wizard-step="4" aria-label="Ir a Otros datos">
                              Otros datos
                            </button>
                          </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-end gap-2 d-none">
                          <button type="button" class="btn btn-outline-secondary">
                            Cancelar (duplicado oculto)
                          </button>
                          <button type="button" class="btn btn-warning">
                            Publicar
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="resizable-handle" data-resizable-handle aria-label="Redimensionar paneles" title="Arrastra para redimensionar los paneles"></button>
              <div class="resizable-panel" data-resizable-bottom>
                <div class="card border-0 shadow-sm rounded-3 h-100">
                  <div class="card-body p-3 p-md-4">
                    <div class="d-flex flex-column h-100">
                      <div class="d-none d-flex flex-column flex-grow-1" data-clientes-detail-tabs-wrapper>
                        <ul class="nav nav-tabs nav-tabs-line" id="clientesDetailTabs" role="tablist">
                          <li class="nav-item">
                            <a class="nav-link active" id="clientes-detail-basicos-tab" data-bs-toggle="tab" href="#clientes-detail-basicos" role="tab" aria-controls="clientes-detail-basicos" aria-selected="true">Datos básicos</a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" id="clientes-detail-historicos-tab" data-bs-toggle="tab" href="#clientes-detail-historicos" role="tab" aria-controls="clientes-detail-historicos" aria-selected="false">Históricos</a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" id="clientes-detail-documentacion-tab" data-bs-toggle="tab" href="#clientes-detail-documentacion" role="tab" aria-controls="clientes-detail-documentacion" aria-selected="false">Documentación</a>
                          </li>
                        </ul>
                    <div class="tab-content flex-grow-1 mt-4 position-relative" id="clientesDetailTabsContent" data-clientes-detail-container>
                          <div class="tab-pane fade show active" id="clientes-detail-basicos" role="tabpanel" aria-labelledby="clientes-detail-basicos-tab">
                            <div class="detail-layout" data-clientes-detail-layout>
                              <div class="detail-layout-content" data-clientes-detail-content>
                                <div class="detail-field-search d-none" data-clientes-detail-search>
                                  <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-transparent border-end-0 text-secondary detail-field-search-icon">
                                      <i data-lucide="search"></i>
                                    </span>
                                    <input type="search" class="form-control border-start-0 ps-0" placeholder="Buscar campos..." aria-label="Buscar campos" data-clientes-detail-search-input>
                                  </div>
                                </div>
                                <form class="pb-2 d-none" data-clientes-detail-form novalidate>
                                  <div class="detail-grid" data-clientes-detail-grid></div>
                                </form>
                              </div>
                              <div class="detail-category-tools">
                                <nav class="detail-category-nav" data-clientes-detail-category-nav aria-label="Secciones del detalle"></nav>
                              </div>
                            </div>
                          </div>
                          <div class="tab-pane fade" id="clientes-detail-historicos" role="tabpanel" aria-labelledby="clientes-detail-historicos-tab">
                            <div class="text-secondary" data-clientes-detail-historicos>Sin datos históricos disponibles.</div>
                          </div>
                          <div class="tab-pane fade" id="clientes-detail-documentacion" role="tabpanel" aria-labelledby="clientes-detail-documentacion-tab">
                            <div class="text-secondary" data-clientes-detail-documentacion>Sin documentación disponible.</div>
                          </div>
                        </div>
                      </div>
                      <div class="flex-grow-1 d-flex align-items-center justify-content-center text-secondary text-center px-3" data-clientes-detail-empty>
                        Selecciona un conductor de la lista superior para ver su información aquí.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

        <div class="modal fade" id="nuevoConductorModal" tabindex="-1" aria-labelledby="nuevoConductorModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0">
              <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title text-white" id="nuevoConductorModalLabel">Nuevo conductor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body pb-4">
                <form data-conductor-form>
                  <p class="text-secondary small mb-4">Los campos marcados con <span class="text-danger">*</span> son obligatorios.</p>
                  <div class="row g-3 mb-4">
                    <div class="col-md-6">
                      <label for="conductorNombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="conductorNombre" name="nombre" autocomplete="given-name" required aria-required="true">
                    </div>
                    <div class="col-md-6">
                      <label for="conductorApellido1" class="form-label">Primer apellido <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="conductorApellido1" name="apellido1" autocomplete="family-name" required aria-required="true">
                    </div>
                    <div class="col-md-6">
                      <label for="conductorApellido2" class="form-label">Segundo apellido <span class="text-secondary small ms-1">(opcional)</span></label>
                      <input type="text" class="form-control" id="conductorApellido2" name="apellido2" autocomplete="additional-name">
                    </div>
                    <div class="col-md-6">
                      <label for="conductorDocumento" class="form-label">Documento de identidad <span class="text-danger">*</span></label>
                      <input
                        type="text"
                        class="form-control"
                        id="conductorDocumento"
                        name="ndocumentoidentidad"
                        autocomplete="off"
                        required
                        aria-required="true"
                        data-validate="documento"
                      >
                    </div>
                    <div class="col-md-6">
                      <label for="conductorTelefono1" class="form-label">Teléfono principal <span class="text-danger">*</span></label>
                      <input
                        type="tel"
                        class="form-control"
                        id="conductorTelefono1"
                        name="telefono1"
                        inputmode="tel"
                        autocomplete="tel"
                        required
                        aria-required="true"
                        data-validate="telefono"
                      >
                    </div>
                    <div class="col-md-6">
                      <label for="conductorTelefono2" class="form-label">Teléfono alternativo <span class="text-secondary small ms-1">(opcional)</span></label>
                      <input type="tel" class="form-control" id="conductorTelefono2" name="telefono2" inputmode="tel" autocomplete="tel">
                    </div>
                    <div class="col-md-6">
                      <label for="conductorFechaNacimiento" class="form-label">Fecha de nacimiento <span class="text-secondary small ms-1">(opcional)</span></label>
                      <input type="text" class="form-control" id="conductorFechaNacimiento" name="fechaNacimiento" data-conductor-fecha autocomplete="bday" placeholder="Selecciona una fecha">
                    </div>
                    <div class="col-md-6">
                      <label for="conductorNacionalidad" class="form-label">Nacionalidad <span class="text-secondary small ms-1">(opcional)</span></label>
                      <select class="form-select" id="conductorNacionalidad" name="nacionalidad" data-conductor-nacionalidad data-placeholder="Selecciona un país">
                        <option value="" selected>Selecciona un país</option>
                      </select>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" data-role="conductor-guardar">Guardar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal de confirmación para publicar -->
        <div class="modal fade" id="publicarConfirmModal" tabindex="-1" aria-labelledby="publicarConfirmModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
              <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title fw-semibold" id="publicarConfirmModalLabel">
                  <i class="me-2" data-lucide="alert-triangle"></i>
                  Atención, Vas a publicar un registro
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body pb-4">
                <p class="mb-0">
                  Esto hará que pueda estar disponible para su utilización en otros procesos y otros usuarios, además esta acción no se puede deshacer, ¿estás seguro?
                </p>
              </div>
              <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" data-publicar-confirmar>Confirmar publicación</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal para ver datos del histórico -->
        <div class="modal fade" id="historicoDatosModal" tabindex="-1" aria-labelledby="historicoDatosModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0">
              <div class="modal-header bg-secondary text-white border-0">
                <div class="d-flex align-items-center gap-2">
                  <button type="button" class="btn btn-sm" id="historicoPinButton" title="Fijar modal" style="border: none; padding: 0.25rem 0.5rem; background: none; color: white;">
                    <i data-lucide="pin" style="width: 18px; height: 18px;"></i>
                  </button>
                  <h5 class="modal-title text-white mb-0" id="historicoDatosModalLabel">
                    <i class="me-2" data-lucide="file-text"></i>
                    Datos del registro histórico
                  </h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body pb-4">
                <form id="historicoDatosForm">
                  <div id="historicoDatosContainer" class="row g-3">
                    <!-- Los campos se generarán dinámicamente aquí -->
                  </div>
                </form>
              </div>
              <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
              <!-- Toast para feedback de copiado -->
              <div class="toast-container position-absolute bottom-0 start-50 translate-middle-x p-3" style="z-index: 1060;">
                <div id="historicoCopyToast" class="toast text-bg-success border-0 shadow-sm" role="status" aria-live="polite" aria-atomic="true" data-bs-delay="1500">
                  <div class="d-flex align-items-center">
                    <div class="toast-body">
                      <i class="me-2" data-lucide="check-circle"></i>
                      Copiado al portapapeles
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-2 me-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="offcanvas offcanvas-end" tabindex="-1" id="clientesActionsOffcanvas" aria-labelledby="clientesActionsOffcanvasLabel" aria-hidden="true">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="clientesActionsOffcanvasLabel">Acciones del conductor</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
          </div>
          <div class="offcanvas-body">
            <p class="text-secondary small mb-4">
              Gestiona las operaciones del conductor <strong data-clientes-actions-name>seleccionado</strong>.
            </p>
            <div class="treeview" data-clientes-treeview data-treeview-role="procesos">
              <div class="treeview-header text-secondary">Procesos disponibles</div>
              <div class="treeview-search mb-2">
                <span class="treeview-search-icon">
                  <i class="text-secondary" data-lucide="search"></i>
                </span>
                <input type="search" class="form-control form-control-sm" placeholder="Buscar proceso…" aria-label="Buscar proceso" data-treeview-search>
              </div>
              <div class="treeview-body" data-treeview-body>
                <div class="treeview-status" data-treeview-status>Cargando menú…</div>
              </div>
            </div>
          </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3" data-clientes-toast-container>
          <div id="clientesCopyToast" class="toast text-bg-success border-0 shadow-sm" role="status" aria-live="polite" aria-atomic="true" data-bs-delay="2200">
            <div class="d-flex align-items-center">
              <div class="toast-body">
                Datos copiados al portapapeles.
              </div>
              <button type="button" class="btn-close btn-close-white ms-2 me-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
          </div>
        </div>

        <!-- Toast para notificaciones de publicación -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
          <div id="publicarSuccessToast" class="toast text-bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
            <div class="d-flex align-items-center">
              <div class="toast-body">
                <i class="me-2" data-lucide="check-circle"></i>
                <span id="publicarSuccessMessage">Conductor publicado exitosamente</span>
              </div>
              <button type="button" class="btn-close btn-close-white ms-2 me-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
          </div>
          <div id="publicarErrorToast" class="toast text-bg-danger border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="d-flex align-items-center">
              <div class="toast-body">
                <i class="me-2" data-lucide="alert-circle"></i>
                <span id="publicarErrorMessage">Error al publicar</span>
              </div>
              <button type="button" class="btn-close btn-close-white ms-2 me-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
          </div>
        </div>

      <!-- partial:partials/_footer.html -->

      <footer class="footer d-flex flex-row align-items-center justify-content-between px-4 py-3 border-top small">
				<p class="text-secondary mb-1 mb-md-0"><span data-i18n="footer.copyright">Copyright © 2025</span> <a href="https://fmprosoft.com" target="_blank">FleetPilot</a>.</p>
				<p class="text-secondary"><span data-i18n="footer.handcrafted">Handcrafted with</span> <i class="mb-1 text-primary ms-1 icon-sm" data-lucide="heart"></i></p>
			</footer>

      <!-- partial -->

    </div>
  </div>

	<!-- core:js -->
	<script src="./assets/vendors/core/core.js"></script>
	<!-- endinject -->

	<!-- Plugin js for this page -->
  <script src="./assets/vendors/jquery/jquery.min.js"></script>
  <script src="./assets/vendors/flatpickr/flatpickr.min.js"></script>
  <script src="./assets/vendors/flatpickr/es.js"></script>
  <script src="./assets/vendors/apexcharts/apexcharts.min.js"></script>
  <script src="./assets/vendors/select2/select2.min.js"></script>
 <!-- End plugin js for this page -->

	<!-- inject:js -->
	<script src="./assets/js/authStorage.js"></script>
	<script src="./assets/js/apiClient.js"></script>
	<script src="./assets/js/init-auth.js"></script>
	<script src="./assets/js/i18n.js"></script>
 <script src="./assets/js/app.js"></script>
 <!-- endinject -->

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ========================================
      // WIZARD / ASISTENTE DE FORMULARIO
      // ========================================
      let currentWizardStep = 1;
      let currentWizardPage = 1;

      const WIZARD_PAGE_FIELDS = {
        1: ['nombre', 'apellido1', 'apellido2', 'tipoDocumentoIdentidad', 'nDocumentoIdentidad', 'fechaNacimiento', 'edad', 'nAfiliacionSS', 'nacionalidad', 'nivelFormativoTrabajador'],
        2: ['telefono1', 'telefono2', 'correoPersonal', 'correoPlataforma', 'telefonoBoltCompleto'],
        3: ['tipoVia', 'nombreVia', 'numero', 'pisoYLetra', 'cp', 'localidad', 'provincia'],
        4: ['fechaFirma']
      };

      function initializeWizard() {
        const wizardButtons = document.querySelectorAll('[data-wizard-step]');
        const wizardPages = document.querySelectorAll('[data-wizard-page]');

        wizardButtons.forEach(button => {
          button.addEventListener('click', function() {
            const targetStep = parseInt(this.getAttribute('data-wizard-step'));
            navigateToStep(targetStep);
          });
        });

        // Mostrar la primera página al cargar
        showWizardPage(1);
      }

      function navigateToStep(targetStep) {
        if (targetStep === currentWizardStep) return;

        const direction = targetStep > currentWizardStep ? 'forward' : 'backward';
        currentWizardStep = targetStep;
        showWizardPage(targetStep, direction);
      }

      function showWizardPage(step, direction = 'forward') {
        const numericStep = typeof step === 'number' ? step : parseInt(step, 10) || 1;
        currentWizardPage = numericStep;
        const pages = document.querySelectorAll('[data-wizard-page]');
        const buttons = document.querySelectorAll('[data-wizard-step]');

        // Actualizar botones
        buttons.forEach(button => {
          const buttonStep = parseInt(button.getAttribute('data-wizard-step'));
          if (buttonStep === numericStep) {
            button.classList.add('active');
          } else {
            button.classList.remove('active');
          }
        });

        // Actualizar páginas con animación
        pages.forEach(page => {
          const pageStep = parseInt(page.getAttribute('data-wizard-page'));

          if (pageStep === numericStep) {
            // Mostrar la página nueva con animación
            page.classList.remove('slide-in-left', 'slide-in-right');
            page.classList.add('active');

            // Añadir la animación según la dirección
            if (direction === 'forward') {
              page.classList.add('slide-in-right');
            } else {
              page.classList.add('slide-in-left');
            }

            // Hacer scroll al inicio de la página
            const wizardContent = document.querySelector('.wizard-content');
            if (wizardContent) {
              wizardContent.scrollTop = 0;
            }
          } else if (page.classList.contains('active')) {
            // Ocultar la página actual
            page.classList.remove('active', 'slide-in-left', 'slide-in-right');
          }
        });
      }

      // Inicializar el wizard
      initializeWizard();

      // Inicializar el progreso del wizard (se actualizará al cargar datos)
      setTimeout(() => {
        if (typeof updateWizardProgress === 'function') {
          updateWizardProgress();
        }
      }, 500);

      // ========================================
      // FIN WIZARD
      // ========================================

      const COUNTRIES = [
        'Afganistán',
        'Albania',
        'Alemania',
        'Andorra',
        'Angola',
        'Antigua y Barbuda',
        'Arabia Saudita',
        'Argelia',
        'Argentina',
        'Armenia',
        'Australia',
        'Austria',
        'Azerbaiyán',
        'Bahamas',
        'Bangladés',
        'Barbados',
        'Baréin',
        'Bélgica',
        'Belice',
        'Benín',
        'Bielorrusia',
        'Birmania',
        'Bolivia',
        'Bosnia y Herzegovina',
        'Botsuana',
        'Brasil',
        'Brunéi',
        'Bulgaria',
        'Burkina Faso',
        'Burundi',
        'Bután',
        'Cabo Verde',
        'Camboya',
        'Camerún',
        'Canadá',
        'Catar',
        'Chad',
        'Chile',
        'China',
        'Chipre',
        'Colombia',
        'Comoras',
        'Corea del Norte',
        'Corea del Sur',
        'Costa de Marfil',
        'Costa Rica',
        'Croacia',
        'Cuba',
        'Dinamarca',
        'Dominica',
        'Ecuador',
        'Egipto',
        'El Salvador',
        'Emiratos Árabes Unidos',
        'Eritrea',
        'Eslovaquia',
        'Eslovenia',
        'España',
        'Estados Unidos',
        'Estonia',
        'Etiopía',
        'Fiyi',
        'Filipinas',
        'Finlandia',
        'Francia',
        'Gabón',
        'Gambia',
        'Georgia',
        'Ghana',
        'Granada',
        'Grecia',
        'Guatemala',
        'Guinea',
        'Guinea-Bisáu',
        'Guinea Ecuatorial',
        'Guyana',
        'Haití',
        'Honduras',
        'Hungría',
        'India',
        'Indonesia',
        'Irak',
        'Irán',
        'Irlanda',
        'Islandia',
        'Islas Marshall',
        'Islas Salomón',
        'Israel',
        'Italia',
        'Jamaica',
        'Japón',
        'Jordania',
        'Kazajistán',
        'Kenia',
        'Kirguistán',
        'Kiribati',
        'Kuwait',
        'Laos',
        'Lesoto',
        'Letonia',
        'Líbano',
        'Liberia',
        'Libia',
        'Liechtenstein',
        'Lituania',
        'Luxemburgo',
        'Macedonia del Norte',
        'Madagascar',
        'Malasia',
        'Malaui',
        'Maldivas',
        'Malí',
        'Malta',
        'Marruecos',
        'Mauricio',
        'Mauritania',
        'México',
        'Micronesia',
        'Moldavia',
        'Mónaco',
        'Mongolia',
        'Montenegro',
        'Mozambique',
        'Namibia',
        'Nauru',
        'Nepal',
        'Nicaragua',
        'Níger',
        'Nigeria',
        'Noruega',
        'Nueva Zelanda',
        'Omán',
        'Países Bajos',
        'Pakistán',
        'Palaos',
        'Panamá',
        'Papúa Nueva Guinea',
        'Paraguay',
        'Perú',
        'Polonia',
        'Portugal',
        'Reino Unido',
        'República Centroafricana',
        'República Checa',
        'República del Congo',
        'República Democrática del Congo',
        'República Dominicana',
        'Ruanda',
        'Rumanía',
        'Rusia',
        'Samoa',
        'San Cristóbal y Nieves',
        'San Marino',
        'San Vicente y las Granadinas',
        'Santa Lucía',
        'Santo Tomé y Príncipe',
        'Senegal',
        'Serbia',
        'Seychelles',
        'Sierra Leona',
        'Singapur',
        'Siria',
        'Somalia',
        'Sri Lanka',
        'Sudáfrica',
        'Sudán',
        'Sudán del Sur',
        'Suecia',
        'Suiza',
        'Surinam',
        'Tailandia',
        'Tanzania',
        'Tayikistán',
        'Timor Oriental',
        'Togo',
        'Tonga',
        'Trinidad y Tobago',
        'Túnez',
        'Turkmenistán',
        'Turquía',
        'Tuvalu',
        'Ucrania',
        'Uganda',
        'Uruguay',
        'Uzbekistán',
        'Vanuatu',
        'Venezuela',
        'Vietnam',
        'Yemen',
        'Yibuti',
        'Zambia',
        'Zimbabue'
      ];

      const isDocumentoValido = (value = '') => {
        const normalized = String(value ?? '').toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (/^\d{8}[A-Z]$/.test(normalized)) {
          return true;
        }
        if (/^[XYZ]\d{8}$/.test(normalized)) {
          return true;
        }
        return false;
      };

      const isTelefonoValido = (value = '') => {
        const digitsOnly = String(value ?? '').replace(/\D/g, '');
        if (!/^\d{9}$/.test(digitsOnly)) {
          return false;
        }
        return /^[6789]\d{8}$/.test(digitsOnly);
      };

      const triggerHighlight = (element) => {
        if (!element) {
          return;
        }
        element.classList.remove('detail-field-highlight');
        void element.offsetWidth;
        element.classList.add('detail-field-highlight');
      };

      const clearHighlight = (element) => {
        if (!element) {
          return;
        }
        element.classList.remove('detail-field-highlight');
      };

      const getFieldLabel = (form, field) => {
        if (!form || !field?.id) {
          return null;
        }
        return form.querySelector(`label[for="${field.id}"]`);
      };

      const markFieldInvalid = (form, field) => {
        if (!field) {
          return;
        }
        field.setAttribute('aria-invalid', 'true');
        field.classList.add('is-field-invalid');
        triggerHighlight(field);
      };

      const resetFieldState = (form, field) => {
        if (!field) {
          return;
        }
        field.removeAttribute('aria-invalid');
        field.classList.remove('is-field-invalid');
        clearHighlight(field);
      };

      const validateField = (form, field, { silent = false, skipEmpty = false } = {}) => {
        if (!field) {
          return true;
        }
        const rawValue = field.value ?? '';
        const value = rawValue.trim();
        if (!value) {
          if (skipEmpty) {
            resetFieldState(form, field);
            return true;
          }
          if (!silent) {
            markFieldInvalid(form, field);
          }
          return false;
        }
        const validationType = field.dataset.validate;
        if (validationType === 'documento' && !isDocumentoValido(value)) {
          if (!silent) {
            markFieldInvalid(form, field);
          }
          return false;
        }
        if (validationType === 'telefono' && !isTelefonoValido(value)) {
          if (!silent) {
            markFieldInvalid(form, field);
          }
          return false;
        }
        resetFieldState(form, field);
        return true;
      };

      const createConductorFormValidator = (form) => {
        if (!form) {
          return null;
        }
        const requiredFields = Array.from(form.querySelectorAll('[required]'));
        requiredFields.forEach((field) => {
          field.addEventListener('input', () => validateField(form, field, { silent: true, skipEmpty: true }));
          field.addEventListener('blur', () => validateField(form, field, { skipEmpty: true }));
        });
        return {
          validateAll() {
            const invalidFields = [];
            requiredFields.forEach((field) => {
              if (!validateField(form, field)) {
                invalidFields.push(field);
              }
            });
            return invalidFields;
          },
          resetValidation() {
            requiredFields.forEach((field) => resetFieldState(form, field));
          },
        };
      };

      const conductorModal = document.getElementById('nuevoConductorModal');
      if (conductorModal) {
        const conductorForm = conductorModal.querySelector('[data-conductor-form]');
        const birthDateInput = conductorModal.querySelector('[data-conductor-fecha]');
        const nationalitySelect = conductorModal.querySelector('[data-conductor-nacionalidad]');
        const saveButton = conductorModal.querySelector('[data-role="conductor-guardar"]');
        const modalContent = conductorModal.querySelector('.modal-content');
        let birthDatePicker = null;
        let $nationalitySelect = null;
        const conductorFormValidator = createConductorFormValidator(conductorForm);

        if (nationalitySelect && !nationalitySelect.dataset.optionsLoaded) {
          const existingValues = new Set(Array.from(nationalitySelect.options).map((option) => option.value));
          COUNTRIES.forEach((country) => {
            if (!existingValues.has(country)) {
              const option = document.createElement('option');
              option.value = country;
              option.textContent = country;
              nationalitySelect.appendChild(option);
            }
          });
          nationalitySelect.dataset.optionsLoaded = 'true';
        }

        if (birthDateInput && window.flatpickr) {
          birthDatePicker = window.flatpickr(birthDateInput, {
            dateFormat: 'Y-m-d',
            altInput: true,
            altFormat: 'd/m/Y',
            allowInput: true,
            locale: window.flatpickr?.l10ns?.es ?? 'es'
          });
        }

        if (nationalitySelect && window.jQuery?.fn?.select2) {
          $nationalitySelect = window.jQuery(nationalitySelect);
          $nationalitySelect.select2({
            dropdownParent: window.jQuery(conductorModal),
            width: '100%',
            placeholder: nationalitySelect.dataset.placeholder || 'Selecciona un país',
            allowClear: true,
            language: {
              noResults: () => 'Sin resultados',
              searching: () => 'Buscando...',
              removeAllItems: () => 'Eliminar selección'
            }
          });
          $nationalitySelect.val('').trigger('change');
        }

        conductorModal.addEventListener('shown.bs.modal', () => {
          conductorForm?.querySelector('#conductorNombre')?.focus();
        });

        conductorModal.addEventListener('hidden.bs.modal', () => {
          conductorForm?.reset();
          birthDatePicker?.clear();
          conductorFormValidator?.resetValidation();
          if ($nationalitySelect) {
            $nationalitySelect.val(null).trigger('change');
          } else if (nationalitySelect) {
            nationalitySelect.value = '';
          }
          modalContent?.classList.remove('modal-shake');
        });

        if (saveButton && conductorForm) {
          saveButton.addEventListener('click', (event) => {
            event.preventDefault();
            const invalidFields = conductorFormValidator ? conductorFormValidator.validateAll() : [];
            if (invalidFields.length) {
              invalidFields[0]?.focus({ preventScroll: false });
              if (modalContent) {
                modalContent.classList.remove('modal-shake');
                void modalContent.offsetWidth;
                modalContent.classList.add('modal-shake');
              }
              return;
            }

            const formData = Object.fromEntries(new FormData(conductorForm).entries());
            console.log('Nuevo conductor (prototipo):', formData);

            const modalInstance = window.bootstrap?.Modal.getInstance(conductorModal)
              ?? new window.bootstrap.Modal(conductorModal);
            modalInstance.hide();
          });
        }

        if (modalContent) {
          modalContent.addEventListener('animationend', (event) => {
            if (event.animationName === 'modal-shake') {
              modalContent.classList.remove('modal-shake');
            }
          });
        }
      }

      const TREEVIEW_DATA_URL = './assets/data/procesos-conductor.json';
      const TREEVIEW_PROCESS_ROUTES = new Map([
        ['DC36C24D-29FF-435C-A7E9-ED1D31A25450', 'proceso.html']
      ]);
      const PROCESS_SELECTION_STORAGE_KEY = 'clientes.process-selection';

      let procesoLogDataCache = [];
      let currentConductorId = null; // UUID del conductor actual
      let currentConductorRecordId = null; // recordId de FileMaker del conductor actual
      let currentProcesoId = null; // ID del proceso actual (desde URL)
      let originalConductorData = null; // Datos originales del conductor para comparación
      const PROCESO_DEFAULT_TOP_RATIO = 0.6;

      const procesoForm = document.querySelector('[data-proceso-conductor-form]');
      const procesoPublishButton = document.querySelector('[data-proceso-publicar]');
      const procesoCancelButton = document.querySelector('[data-proceso-cancelar]');
      const procesoToggleTopButton = document.querySelector('[data-proceso-toggle-top]');
      const procesoFormCard = document.querySelector('[data-proceso-form-card]');
      const procesoFormValidator = createConductorFormValidator(procesoForm);
      const procesoSplitHandle = document.querySelector('[data-proceso-side-handle]');
      const procesoSplitWrapper = document.querySelector('[data-proceso-side-wrapper]');
      const procesoSplitTop = document.querySelector('[data-proceso-side-top]');
      const procesoSplitBottom = document.querySelector('[data-proceso-side-bottom]');
      const procesoTitle = document.querySelector('[data-proceso-title]');

      const fillProcesoForm = (record = null) => {
        if (!procesoForm) {
          return;
        }
        const fields = {
          nombre: procesoForm.querySelector('#procesoNombre'),
          apellido1: procesoForm.querySelector('#procesoApellido1'),
          apellido2: procesoForm.querySelector('#procesoApellido2'),
          ndocumentoidentidad: procesoForm.querySelector('#procesoDocumento'),
          telefono1: procesoForm.querySelector('#procesoTelefono1')
        };
        Object.entries(fields).forEach(([key, field]) => {
          if (!field) {
            return;
          }
          const value = record ? record[key] ?? '' : '';
          field.value = value;
          resetFieldState(procesoForm, field);
        });
      };

      // Función para actualizar el estado visual de campos vacíos
      const updateEmptyFieldsHighlight = () => {
        if (!procesoForm) return;

        // Obtener todos los inputs y selects del formulario
        const fields = procesoForm.querySelectorAll('.form-control, .form-select');

        fields.forEach(field => {
          // Ignorar campos readonly (como edad que se calcula automáticamente)
          if (field.hasAttribute('readonly')) {
            return;
          }

          const isEmpty = !field.value || field.value.trim() === '';

          // Para campos con Select2, necesitamos trabajar con el contenedor de Select2
          if (field.classList.contains('select2-hidden-accessible')) {
            // El select original está oculto, buscar el contenedor de Select2
            const select2Container = field.parentElement.querySelector('.select2-container');
            if (select2Container) {
              if (isEmpty) {
                select2Container.classList.add('field-empty');
              } else {
                select2Container.classList.remove('field-empty');
              }
            }
          } else {
            // Para campos normales
            if (isEmpty) {
              field.classList.add('field-empty');
            } else {
              field.classList.remove('field-empty');
            }
          }
        });
      };

      // Función auxiliar para verificar si una página está publicada
      // Revisa si existe algún registro en el histórico que contenga al menos uno de los campos de la página
      const isPagePublished = (pageNumber) => {
        // Obtener los nombres de campos de esta página
        const pageFieldNames = WIZARD_PAGE_FIELDS[pageNumber] || [];

        if (pageFieldNames.length === 0) {
          console.log(`⚠️ Página ${pageNumber} no tiene campos definidos`);
          return false;
        }

        // Si no hay registros de histórico, la página no está publicada
        if (!procesoLogDataCache || procesoLogDataCache.length === 0) {
          console.log(`📋 Página ${pageNumber}: Sin registros de histórico`);
          return false;
        }

        // Buscar en los registros del histórico si alguno contiene datos de esta página
        const hasPublishedData = procesoLogDataCache.some(record => {
          // El campo 'datos' contiene un JSON string con los campos publicados
          let datos = {};

          if (record.datos) {
            try {
              // Si es string, parsear el JSON
              if (typeof record.datos === 'string') {
                datos = JSON.parse(record.datos);
              } else if (typeof record.datos === 'object') {
                datos = record.datos;
              }
            } catch (error) {
              console.warn(`⚠️ Error al parsear datos del histórico:`, error);
              return false;
            }
          }

          // Verificar si algún campo de la página está en los datos publicados
          const hasFieldFromPage = pageFieldNames.some(fieldName => {
            return datos.hasOwnProperty(fieldName);
          });

          return hasFieldFromPage;
        });

        console.log(`${hasPublishedData ? '✅' : '❌'} Página ${pageNumber}: ${hasPublishedData ? 'PUBLICADA' : 'NO PUBLICADA'} (${procesoLogDataCache.length} registros histórico)`);
        return hasPublishedData;
      };

      // Función auxiliar para verificar si TODOS los campos de una página están publicados
      // Necesario para mostrar el tick verde (✓) solo cuando la página está 100% publicada
      const areAllPageFieldsPublished = (pageNumber) => {
        // Obtener los nombres de campos de esta página
        const pageFieldNames = WIZARD_PAGE_FIELDS[pageNumber] || [];

        if (pageFieldNames.length === 0) {
          return false;
        }

        // Si no hay registros de histórico, ningún campo está publicado
        if (!procesoLogDataCache || procesoLogDataCache.length === 0) {
          return false;
        }

        // Recolectar todos los campos publicados de todos los registros del histórico
        const allPublishedFields = new Set();

        procesoLogDataCache.forEach(record => {
          let datos = {};

          if (record.datos) {
            try {
              if (typeof record.datos === 'string') {
                datos = JSON.parse(record.datos);
              } else if (typeof record.datos === 'object') {
                datos = record.datos;
              }
            } catch (error) {
              return; // Continuar con el siguiente registro
            }
          }

          // Añadir los campos de este registro al set
          Object.keys(datos).forEach(fieldName => {
            allPublishedFields.add(fieldName);
          });
        });

        // Verificar si TODOS los campos de la página están en el set de campos publicados
        const allFieldsPublished = pageFieldNames.every(fieldName => {
          return allPublishedFields.has(fieldName);
        });

        console.log(`${allFieldsPublished ? '✅✅' : '⚠️'} Página ${pageNumber}: ${allFieldsPublished ? 'TODOS LOS CAMPOS PUBLICADOS' : 'FALTAN CAMPOS POR PUBLICAR'} (${allPublishedFields.size} campos únicos en histórico)`);
        return allFieldsPublished;
      };

      // Función para calcular y actualizar el progreso de cada página del wizard
      const updateWizardProgress = () => {
        const wizardPages = document.querySelectorAll('[data-wizard-page]');

        // Si no hay páginas del wizard, salir
        if (!wizardPages || wizardPages.length === 0) {
          return;
        }

        wizardPages.forEach(page => {
          const pageNumber = parseInt(page.getAttribute('data-wizard-page'));
          const button = document.querySelector(`[data-wizard-step="${pageNumber}"]`);

          if (!button) return;

          // Obtener todos los campos de esta página (inputs y selects)
          const fields = page.querySelectorAll('.form-control, .form-select');

          let totalFields = 0;
          let completedFields = 0;
          let requiredFields = 0;
          let completedRequiredFields = 0;

          fields.forEach(field => {
            // Ignorar campos sin id y sin nombre (campos generados por Select2, etc.)
            if (!field.id && !field.name) {
              return;
            }

            // Ignorar campos readonly
            if (field.hasAttribute('readonly')) {
              return;
            }

            // Ignorar solo campos que están explícitamente ocultos con d-none en su contenedor directo
            const fieldContainer = field.closest('.col-12, .col-lg-6');
            if (fieldContainer && fieldContainer.classList.contains('d-none')) {
              return;
            }

            const isRequired = field.hasAttribute('required');

            totalFields++;
            if (isRequired) requiredFields++;

            // Verificar si el campo está completado y es válido
            const hasValue = field.value && field.value.trim() !== '';
            const isValid = field.checkValidity ? field.checkValidity() : true;

            if (hasValue && isValid) {
              completedFields++;
              if (isRequired) completedRequiredFields++;
            }
          });

          // Calcular porcentaje
          const percentage = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;

          // Actualizar la variable CSS --progress
          button.style.setProperty('--progress', `${percentage}%`);

          // Verificar si la página está publicada (al menos un campo publicado)
          const pageIsPublished = isPagePublished(pageNumber);

          // Verificar si TODOS los campos de la página están publicados (para el tick verde)
          const allFieldsPublished = areAllPageFieldsPublished(pageNumber);

          // Determinar si todos los campos requeridos están completos
          const allRequiredComplete = requiredFields === 0 || completedRequiredFields === requiredFields;

          // APLICAR ESTADOS SEGÚN LA LÓGICA DE 3 ESTADOS
          const wasCompleted = button.classList.contains('completed');

          // Limpiar todas las clases de estado antes de aplicar el nuevo estado
          button.classList.remove('completed', 'published', 'just-completed');

          if (percentage === 100 && allFieldsPublished) {
            // Estado 1: Verde con ✓ (100% completado Y TODOS los campos publicados)
            button.classList.add('completed');

            // Si acaba de completarse, añadir animación
            if (!wasCompleted) {
              button.classList.add('just-completed');
              setTimeout(() => {
                button.classList.remove('just-completed');
              }, 600);
            }
          } else if (allRequiredComplete && pageIsPublished && percentage < 100) {
            // Estado 2: Verde sin ✓ (campos requeridos completos Y publicado, pero no 100%)
            button.classList.add('published');
          }
          // Estado 3: Azul con progreso (sin clases especiales, estado por defecto)
          // No se necesita añadir ninguna clase, el CSS base se aplica automáticamente

          // Debug: log del estado de cada botón
          console.log(`Botón página ${pageNumber}:`, {
            percentage,
            pageIsPublished,
            allFieldsPublished,
            allRequiredComplete,
            classes: button.className,
            isActive: button.classList.contains('active')
          });
        });
      };

      const loadHistoricoFromFileMaker = async (conductorId = null, procesoId = null) => {
        try {
          console.log('📚 Cargando histórico desde FileMaker');
          console.log('  - Filtrar por conductorId:', conductorId || 'Sin filtro');
          console.log('  - Filtrar por procesoId:', procesoId || 'Sin filtro (incluye vacíos)');

          let url = 'layouts/historico/records';

          // Si hay conductorId, usar _find para filtrar
          if (conductorId) {
            url = 'layouts/historico/_find';
          }

          // Construir el query de filtrado
          // Si hay procesoId, necesitamos: (idEntidad = conductorId) AND (idProceso = procesoId OR idProceso está vacío)
          // Esto se hace con dos queries en el array: el primero con idProceso = procesoId, el segundo con idProceso vacío (omit=false)
          let query = [];

          if (conductorId && procesoId) {
            // Query 1: idEntidad = conductorId AND idProceso = procesoId
            query.push({
              idEntidad: conductorId,
              idProceso: procesoId
            });
            // Query 2: idEntidad = conductorId AND idProceso = "" (vacío)
            query.push({
              idEntidad: conductorId,
              idProceso: '='  // El operador "=" sin valor busca campos vacíos en FileMaker
            });
          } else if (conductorId) {
            // Solo filtrar por conductorId
            query.push({
              idEntidad: conductorId
            });
          }

          const response = conductorId
            ? await window.ApiClient.post(url, {
                query: query
              })
            : await window.ApiClient.get(url);

          if (!response.ok) {
            console.error('Error al cargar histórico desde FileMaker:', response.status, response.statusText);
            return [];
          }

          const data = await response.json();

          // FileMaker Data API devuelve los registros en response.data
          const records = data.response?.data || data.data || [];

          console.log(`  ✅ ${records.length} registros de histórico encontrados`);

          // Transformar los registros de FileMaker al formato necesario
          const transformedRecords = records.map(record => {
            // fieldData contiene los campos del layout
            const fieldData = record.fieldData || {};
            return fieldData;
          });

          procesoLogDataCache = transformedRecords;
          return transformedRecords;
        } catch (error) {
          console.error('Error al cargar histórico desde FileMaker:', error);
          return [];
        }
      };

      const showHistoricoDatosModal = (datosJson) => {
        try {
          console.log('📋 Mostrando modal con datos (raw):', datosJson);
          console.log('📋 Tipo de datos:', typeof datosJson);

          // Parsear el JSON
          let datos = {};
          if (typeof datosJson === 'string') {
            console.log('  → Parseando string JSON...');
            datos = JSON.parse(datosJson);
          } else if (typeof datosJson === 'object') {
            console.log('  → Ya es un objeto, usando directamente');
            datos = datosJson;
          }

          console.log('✅ Datos parseados:', datos);
          console.log('📊 Número de campos:', Object.keys(datos).length);
          console.log('🔑 Campos:', Object.keys(datos));

          const container = document.getElementById('historicoDatosContainer');
          if (!container) {
            console.error('No se encontró el contenedor del modal');
            return;
          }

          // Limpiar el contenedor
          container.innerHTML = '';

          // Mapeo de nombres de campo más legibles
          const fieldLabels = {
            nombre: 'Nombre',
            apellido1: 'Primer apellido',
            apellido2: 'Segundo apellido',
            tipoDocumentoIdentidad: 'Tipo de documento',
            nDocumentoIdentidad: 'Número de documento',
            fechaNacimiento: 'Fecha de nacimiento',
            edad: 'Edad',
            nAfiliacionSS: 'Nº Afiliación S.S.',
            telefono1: 'Teléfono 1',
            telefono2: 'Teléfono 2',
            correoPersonal: 'Correo personal',
            correoPlataforma: 'Correo plataforma',
            telefonoBoltCompleto: 'Teléfono Bolt',
            tipoVia: 'Tipo de vía',
            nombreVia: 'Nombre de vía',
            numero: 'Número',
            pisoYLetra: 'Piso y letra',
            cp: 'Código postal',
            localidad: 'Localidad',
            provincia: 'Provincia',
            fechaFirma: 'Fecha de firma',
            estado: 'Estado'
          };

          // Generar campos dinámicamente
          Object.entries(datos).forEach(([key, value]) => {
            if (value === null || value === undefined) return;

            const label = fieldLabels[key] || key;
            const displayValue = value === '' ? '(vacío)' : value;

            const fieldHtml = `
              <div class="col-md-6">
                <label class="form-label fw-semibold">${label}</label>
                <input type="text" class="form-control historico-field-copy" value="${displayValue}" readonly title="Doble clic para copiar" style="cursor: pointer;">
              </div>
            `;

            container.insertAdjacentHTML('beforeend', fieldHtml);
          });

          // Agregar evento de doble clic a todos los campos
          container.querySelectorAll('.historico-field-copy').forEach(field => {
            field.addEventListener('dblclick', async function() {
              const value = this.value;

              try {
                // Copiar al portapapeles
                await navigator.clipboard.writeText(value);

                // Feedback visual: seleccionar el texto
                this.select();

                // Feedback visual: cambiar color temporalmente
                const originalBg = this.style.backgroundColor;
                this.style.backgroundColor = '#d1e7dd'; // Verde claro

                // Mostrar toast
                const toastElement = document.getElementById('historicoCopyToast');
                if (toastElement) {
                  const toast = bootstrap.Toast.getOrCreateInstance(toastElement);
                  toast.show();

                  // Actualizar iconos de Lucide
                  window.lucide?.createIcons?.();
                }

                console.log('✓ Copiado al portapapeles:', value);

                // Restaurar color después de 300ms
                setTimeout(() => {
                  this.style.backgroundColor = originalBg;
                  this.blur(); // Quitar el foco
                }, 300);

              } catch (error) {
                console.error('Error al copiar al portapapeles:', error);

                // Fallback: seleccionar el texto manualmente
                this.select();
                try {
                  document.execCommand('copy');

                  // Mostrar toast también en fallback
                  const toastElement = document.getElementById('historicoCopyToast');
                  if (toastElement) {
                    const toast = bootstrap.Toast.getOrCreateInstance(toastElement);
                    toast.show();

                    window.lucide?.createIcons?.();
                  }

                  console.log('✓ Copiado al portapapeles (fallback):', value);
                } catch (fallbackError) {
                  console.error('Error en fallback:', fallbackError);
                }
              }
            });
          });

          // Mostrar el modal
          const modalElement = document.getElementById('historicoDatosModal');
          const modal = new bootstrap.Modal(modalElement);

          // Resetear posición al centro cuando se abre
          const resetModalPosition = () => {
            const dialog = modalElement.querySelector('.modal-dialog');
            if (dialog) {
              dialog.style.transform = '';
              dialog.style.transition = '';
            }
          };

          // Resetear al abrir
          modalElement.addEventListener('shown.bs.modal', resetModalPosition, { once: true });

          // Resetear también al cerrar (para la próxima vez)
          modalElement.addEventListener('hidden.bs.modal', resetModalPosition, { once: true });

          modal.show();

          // Actualizar los iconos de Lucide
          window.lucide?.createIcons?.();

        } catch (error) {
          console.error('Error al mostrar modal de datos:', error);
        }
      };

      // Hacer el modal draggable (arrastrable)
      const initDraggableModal = () => {
        const modalElement = document.getElementById('historicoDatosModal');
        if (!modalElement) return;

        const modalDialog = modalElement.querySelector('.modal-dialog');
        const modalHeader = modalElement.querySelector('.modal-header');

        if (!modalDialog || !modalHeader) return;

        let isDragging = false;
        let currentX = 0;
        let currentY = 0;
        let initialX = 0;
        let initialY = 0;

        // Cambiar cursor cuando está sobre la cabecera
        modalHeader.style.cursor = 'move';

        // Resetear variables cuando el modal se cierra
        modalElement.addEventListener('hidden.bs.modal', () => {
          currentX = 0;
          currentY = 0;
          initialX = 0;
          initialY = 0;
          isDragging = false;
        });

        const dragStart = (e) => {
          // Ignorar si se hace clic en el botón de cerrar
          if (e.target.closest('.btn-close')) return;

          isDragging = true;

          // Obtener la posición actual del modal
          const transform = window.getComputedStyle(modalDialog).transform;
          if (transform && transform !== 'none') {
            const matrix = transform.match(/matrix.*\((.+)\)/);
            if (matrix) {
              const values = matrix[1].split(', ');
              currentX = parseFloat(values[4]) || 0;
              currentY = parseFloat(values[5]) || 0;
            }
          } else {
            // Si no hay transform, resetear a 0
            currentX = 0;
            currentY = 0;
          }

          // Obtener posición inicial del mouse
          initialX = e.clientX - currentX;
          initialY = e.clientY - currentY;

          modalDialog.style.transition = 'none';
          e.preventDefault();
        };

        const drag = (e) => {
          if (!isDragging) return;

          e.preventDefault();

          // Calcular nueva posición
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;

          // Aplicar transformación
          modalDialog.style.transform = `translate(${currentX}px, ${currentY}px)`;
        };

        const dragEnd = () => {
          isDragging = false;
        };

        // Event listeners para mouse
        modalHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        // Event listeners para touch (móviles/tablets)
        modalHeader.addEventListener('touchstart', (e) => {
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
          });
          dragStart(mouseEvent);
        });

        document.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
          });
          drag(mouseEvent);
        });

        document.addEventListener('touchend', dragEnd);
      };

      // Funcionalidad de Pin (Fijar modal)
      const initPinnableModal = () => {
        const modalElement = document.getElementById('historicoDatosModal');
        const pinButton = document.getElementById('historicoPinButton');

        if (!modalElement || !pinButton) return;

        let isPinned = false;

        pinButton.addEventListener('click', () => {
          isPinned = !isPinned;

          if (isPinned) {
            // Fijar el modal
            console.log('📌 Modal fijado');

            // Quitar el backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.style.display = 'none';
            }

            // Cambiar el modal para que no sea bloqueante
            modalElement.style.pointerEvents = 'none'; // El modal no bloquea
            const modalContent = modalElement.querySelector('.modal-content');
            if (modalContent) {
              modalContent.style.pointerEvents = 'all'; // Pero el contenido sí es clickeable

              // Agregar borde y sombra más pronunciada para que destaque
              modalContent.style.boxShadow = '0 0 0 3px rgba(108, 117, 125, 0.5), 0 1rem 3rem rgba(0, 0, 0, 0.5)';
              modalContent.style.border = '2px solid rgba(108, 117, 125, 0.8)';
            }

            // Cambiar z-index para que esté visible pero no bloquee
            modalElement.style.zIndex = '1050';

            // Cambiar icono a pin "off" (para indicar que está fijado)
            const icon = pinButton.querySelector('i');
            if (icon) {
              icon.setAttribute('data-lucide', 'pin-off');
              window.lucide?.createIcons?.();
            }

            // Cambiar título del botón
            pinButton.setAttribute('title', 'Desfijar modal');

            // Cambiar estilo del botón para indicar que está activo
            pinButton.classList.add('active');
            pinButton.style.opacity = '0.7';

          } else {
            // Desfijar el modal
            console.log('📍 Modal desfijado');

            // Restaurar el backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.style.display = 'block';
            }

            // Restaurar comportamiento bloqueante
            modalElement.style.pointerEvents = '';
            const modalContent = modalElement.querySelector('.modal-content');
            if (modalContent) {
              modalContent.style.pointerEvents = '';

              // Restaurar borde y sombra originales
              modalContent.style.boxShadow = '';
              modalContent.style.border = '';
            }

            // Restaurar z-index
            modalElement.style.zIndex = '';

            // Cambiar icono a pin normal
            const icon = pinButton.querySelector('i');
            if (icon) {
              icon.setAttribute('data-lucide', 'pin');
              window.lucide?.createIcons?.();
            }

            // Restaurar título del botón
            pinButton.setAttribute('title', 'Fijar modal');

            // Quitar estilo activo
            pinButton.classList.remove('active');
            pinButton.style.opacity = '';
          }
        });

        // Resetear el estado del pin cuando se cierra el modal
        modalElement.addEventListener('hidden.bs.modal', () => {
          if (isPinned) {
            // Si estaba fijado, resetear
            isPinned = false;

            // Restaurar icono
            const icon = pinButton.querySelector('i');
            if (icon) {
              icon.setAttribute('data-lucide', 'pin');
              window.lucide?.createIcons?.();
            }

            // Restaurar título y estilo
            pinButton.setAttribute('title', 'Fijar modal');
            pinButton.classList.remove('active');
            pinButton.style.opacity = '';

            // Limpiar estilos del modal
            modalElement.style.pointerEvents = '';
            modalElement.style.zIndex = '';
            const modalContent = modalElement.querySelector('.modal-content');
            if (modalContent) {
              modalContent.style.pointerEvents = '';
              modalContent.style.boxShadow = '';
              modalContent.style.border = '';
            }
          }
        });
      };

      const initProcesoLogTable = async (data = null, conductorId = null, procesoId = null) => {
        if (!window.jQuery?.fn?.DataTable) {
          return;
        }
        const $table = window.jQuery('#procesoLogTable');
        if (!$table.length) {
          return;
        }

        // Si no se proporciona data, cargar desde FileMaker con filtro opcional
        if (!data) {
          const idConductorToFilter = conductorId || currentConductorId;
          const idProcesoToFilter = procesoId || currentProcesoId;
          data = await loadHistoricoFromFileMaker(idConductorToFilter, idProcesoToFilter);
        }

        // Definir columnas de forma estática basadas en el layout 'historico' de FileMaker
        // Excluimos: idProceso, idEntidad, datos, modificadoEl, modificadoPor
        const columns = [
          { data: 'creadoEl', title: 'Creado el', defaultContent: '' },
          { data: 'creadoPor', title: 'Creado por', defaultContent: '' },
          { data: 'accion', title: 'Acción', defaultContent: '' },
          {
            data: 'datos',
            title: 'Datos',
            orderable: false,
            render: function(data, type, row) {
              return '<button type="button" class="btn btn-secondary btn-sm btn-ver-datos">Ver datos</button>';
            }
          },
          {
            data: 'resumen',
            title: 'Resumen',
            defaultContent: '—',
            render: function(data, type, row) {
              if (type === 'display') {
                return data || '—';
              }
              return data;
            }
          }
        ];

        if ($table.hasClass('dataTable')) {
          const instance = $table.DataTable();
          instance.destroy();
          $table.empty();
        }

        const instance = $table.DataTable({
          data: data,
          columns: columns,
          dom: 't',
          paging: false,
          searching: false,
          info: false,
          ordering: true,
          order: [[0, 'desc']], // Ordenar por la primera columna (creadoEl) de forma descendente
          autoWidth: false,
          language: {
            emptyTable: 'No hay registros disponibles.',
            zeroRecords: 'No hay registros que coincidan con la búsqueda.'
          }
        });

        // Agregar evento click a los botones "Ver datos"
        $table.on('click', '.btn-ver-datos', function(e) {
          e.stopPropagation(); // Evitar que se propague al tr
          const row = instance.row($(this).closest('tr'));
          if (row && row.data()) {
            const rowData = row.data();
            console.log('Click en Ver datos, fila:', rowData);
            showHistoricoDatosModal(rowData.datos);
          }
        });

        window.requestAnimationFrame(() => setProcesoSplitTopRows(3));
      };

      const initProcesoSplit = () => {
        if (!procesoSplitWrapper || !procesoSplitTop || !procesoSplitBottom || !procesoSplitHandle) {
          return;
        }

        let isResizing = false;
        let startY = 0;
        let startTopHeight = 0;
        const defaultTopRatio = 0.6;
        let storedRatio = PROCESO_DEFAULT_TOP_RATIO;
        let storedTopHeight = null;
        const minTop = 120;
        const minBottom = 140;

        const applyRatio = (ratio) => {
          const rect = procesoSplitWrapper.getBoundingClientRect();
          const totalHeight = rect.height > 0 ? rect.height : procesoSplitWrapper.clientHeight;
          if (!totalHeight) {
            return;
          }
          const clampedRatio = Math.min(Math.max(ratio, minTop / totalHeight), 1 - minBottom / totalHeight);
          const topHeight = clampedRatio * totalHeight;
          procesoSplitTop.style.flexBasis = `${topHeight}px`;
          procesoSplitTop.style.maxHeight = `${totalHeight - minBottom}px`;
          procesoSplitBottom.style.flexBasis = `${totalHeight - topHeight - procesoSplitHandle.offsetHeight}px`;
          storedRatio = clampedRatio;
          storedTopHeight = topHeight;
        };

        const applyHeight = (height) => {
          const rect = procesoSplitWrapper.getBoundingClientRect();
          const totalHeight = rect.height > 0 ? rect.height : procesoSplitWrapper.clientHeight;
          if (!totalHeight) {
            return;
          }
          const maxTop = totalHeight - minBottom;
          const clampedHeight = Math.min(Math.max(height, minTop), maxTop);
          procesoSplitTop.style.flexBasis = `${clampedHeight}px`;
          procesoSplitTop.style.maxHeight = `${maxTop}px`;
          procesoSplitBottom.style.flexBasis = `${totalHeight - clampedHeight - procesoSplitHandle.offsetHeight}px`;
          storedTopHeight = clampedHeight;
          storedRatio = clampedHeight / totalHeight;
        };

        const getClientY = (event) => {
          if (event.touches && event.touches.length) {
            return event.touches[0].clientY;
          }
          if (event.changedTouches && event.changedTouches.length) {
            return event.changedTouches[0].clientY;
          }
          return event.clientY;
        };

        const updateFromPointer = (clientY) => {
          const rect = procesoSplitWrapper.getBoundingClientRect();
          const delta = clientY - startY;
          let newTop = startTopHeight + delta;
          const maxTop = rect.height - minBottom;
          if (newTop < minTop) newTop = minTop;
          if (newTop > maxTop) newTop = maxTop;
          const ratio = newTop / rect.height;
          applyRatio(ratio);
        };

        const onPointerMove = (event) => {
          if (!isResizing) {
            return;
          }
          event.preventDefault();
          const clientY = getClientY(event);
          if (clientY == null) {
            return;
          }
          updateFromPointer(clientY);
        };

        const stopResize = () => {
          if (!isResizing) {
            return;
          }
          isResizing = false;
          document.removeEventListener('pointermove', onPointerMove);
          document.removeEventListener('pointerup', stopResize);
          document.removeEventListener('pointercancel', stopResize);
          document.removeEventListener('mousemove', onPointerMove);
          document.removeEventListener('mouseup', stopResize);
          document.removeEventListener('touchmove', onPointerMove);
          document.removeEventListener('touchend', stopResize);
          document.removeEventListener('touchcancel', stopResize);
          procesoSplitHandle.classList.remove('is-dragging');
        };

        const startResize = (event) => {
          event.preventDefault();
          const clientY = getClientY(event);
          if (clientY == null) {
            return;
          }
          const rect = procesoSplitWrapper.getBoundingClientRect();
          startY = clientY;
          startTopHeight = procesoSplitTop.getBoundingClientRect().height || (storedRatio * rect.height);
          isResizing = true;
          procesoSplitHandle.classList.add('is-dragging');
          if ('PointerEvent' in window && event.type === 'pointerdown') {
            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerup', stopResize);
            document.addEventListener('pointercancel', stopResize);
          } else {
            document.addEventListener('mousemove', onPointerMove);
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchmove', onPointerMove, { passive: false });
            document.addEventListener('touchend', stopResize);
            document.addEventListener('touchcancel', stopResize);
          }
        };

        if ('PointerEvent' in window) {
          procesoSplitHandle.addEventListener('pointerdown', startResize);
        } else {
          procesoSplitHandle.addEventListener('mousedown', startResize);
          procesoSplitHandle.addEventListener('touchstart', (event) => {
            event.preventDefault();
            startResize(event);
          }, { passive: false });
        }

        procesoSplitHandle.addEventListener('keydown', (event) => {
          const step = 24;
          const rect = procesoSplitWrapper.getBoundingClientRect();
          if (event.key === 'ArrowUp') {
            event.preventDefault();
            const topHeight = procesoSplitTop.getBoundingClientRect().height;
            applyRatio((topHeight - step) / rect.height);
          } else if (event.key === 'ArrowDown') {
            event.preventDefault();
            const topHeight = procesoSplitTop.getBoundingClientRect().height;
            applyRatio((topHeight + step) / rect.height);
          } else if (event.key === 'Home') {
            event.preventDefault();
            applyRatio(minTop / rect.height);
          } else if (event.key === 'End') {
            event.preventDefault();
            applyRatio((rect.height - minBottom) / rect.height);
          }
        });

        const resizeObserver = typeof ResizeObserver === 'function'
          ? new ResizeObserver(() => {
              if (storedTopHeight !== null) {
                applyHeight(storedTopHeight);
              } else {
                applyRatio(storedRatio);
              }
            })
          : null;
        resizeObserver?.observe(procesoSplitWrapper);

        procesoSplitWrapper.dataset.splitMinTop = String(minTop);
        procesoSplitWrapper.dataset.splitMinBottom = String(minBottom);
        procesoSplitWrapper.__applySplitRatio = (ratio) => applyRatio(ratio);
        applyRatio(PROCESO_DEFAULT_TOP_RATIO);
      };

      const setProcesoSplitTopRows = (rows = 3) => {
        if (!procesoSplitWrapper || typeof procesoSplitWrapper.__applySplitRatio !== 'function') {
          return;
        }
        const table = document.getElementById('procesoLogTable');
        if (!table) {
          procesoSplitWrapper.__applySplitRatio(PROCESO_DEFAULT_TOP_RATIO);
          return;
        }
        const thead = table.tHead;
        const headerHeight = thead ? (thead.getBoundingClientRect().height || thead.offsetHeight || 0) : 0;
        const tbody = table.tBodies?.[0];
        const allRows = tbody ? Array.from(tbody.rows).filter((row) => row.offsetParent !== null) : [];
        if (!allRows.length) {
          procesoSplitWrapper.__applySplitRatio(PROCESO_DEFAULT_TOP_RATIO);
          return;
        }
        const selectedRows = allRows.slice(0, Math.max(rows, 1));
        let desiredHeight = headerHeight;
        selectedRows.forEach((row) => {
          desiredHeight += row.getBoundingClientRect().height || row.offsetHeight || 0;
        });
        desiredHeight += 24;
        const totalHeight = procesoSplitWrapper.getBoundingClientRect().height || procesoSplitWrapper.clientHeight || 0;
        if (!totalHeight) {
          procesoSplitWrapper.__applySplitRatio(PROCESO_DEFAULT_TOP_RATIO);
          return;
        }
        const minTop = Number(procesoSplitWrapper.dataset.splitMinTop) || 0;
        const minBottom = Number(procesoSplitWrapper.dataset.splitMinBottom) || 0;
        const handleHeight = procesoSplitHandle?.offsetHeight ?? 0;
        const availableMax = totalHeight - minBottom - handleHeight;
        if (desiredHeight > availableMax) {
          desiredHeight = availableMax;
        }
        if (desiredHeight < minTop) {
          desiredHeight = minTop;
        }
        const ratio = desiredHeight / totalHeight;
        procesoSplitWrapper.__applySplitRatio(ratio);
      };

      initProcesoSplit();
      // initProcesoLogTable se llamará después de cargar los datos del conductor
      initDraggableModal();
      initPinnableModal();
      window.lucide?.createIcons?.();

      const collapseTopPanel = (focusButton = false) => {
        if (!procesoSplitTop || !procesoSplitHandle) {
          return;
        }
        procesoSplitTop.classList.add('d-none');
        procesoSplitHandle.classList.add('d-none');
        if (procesoTitle) {
          procesoTitle.classList.add('d-none');
        }
        if (procesoToggleTopButton) {
          procesoToggleTopButton.setAttribute('aria-expanded', 'false');
          const icon = procesoToggleTopButton.querySelector('[data-lucide]');
          if (icon) {
            icon.setAttribute('data-lucide', 'chevrons-down');
            window.lucide?.createIcons?.();
          }
          const label = procesoToggleTopButton.querySelector('[data-proceso-toggle-label]');
          if (label) {
            label.textContent = 'Mostrar histórico';
          }
          if (focusButton) {
            procesoToggleTopButton.focus();
          }
        }
        if (procesoSplitBottom) {
          procesoSplitBottom.style.flexBasis = '100%';
        }
      };

      collapseTopPanel();

      if (procesoToggleTopButton) {
        const toggleLabel = procesoToggleTopButton.querySelector('[data-proceso-toggle-label]');
        procesoToggleTopButton.addEventListener('click', () => {
          const isCurrentlyCollapsed = procesoSplitTop.classList.contains('d-none');
          if (isCurrentlyCollapsed) {
            procesoSplitTop.classList.remove('d-none');
            procesoSplitHandle.classList.remove('d-none');
            if (procesoTitle) {
              procesoTitle.classList.remove('d-none');
            }
            procesoToggleTopButton.setAttribute('aria-expanded', 'true');
            const icon = procesoToggleTopButton.querySelector('[data-lucide]');
            if (icon) {
              icon.setAttribute('data-lucide', 'chevrons-up');
              window.lucide?.createIcons?.();
            }
            if (toggleLabel) {
              toggleLabel.textContent = 'Ocultar histórico';
            }
            procesoSplitBottom.style.flexBasis = '';
            window.requestAnimationFrame(() => {
              if (procesoSplitWrapper && typeof procesoSplitWrapper.__applySplitRatio === 'function') {
                procesoSplitWrapper.__applySplitRatio(0.5);
              }
            });
          } else {
            collapseTopPanel();
          }
        });
      }

      if (procesoFormCard) {
        procesoFormCard.addEventListener('animationend', (event) => {
          if (event.animationName === 'modal-shake') {
            procesoFormCard.classList.remove('modal-shake');
          }
        });
      }

      // Función para validar todos los campos del formulario
      const validarFormularioCompleto = () => {
        const errores = [];

        // 1. Validar campos requeridos
        const camposRequeridos = [
          { id: 'procesoNombre', nombre: 'Nombre' },
          { id: 'procesoApellido1', nombre: 'Primer apellido' },
          { id: 'procesoTipoDocumento', nombre: 'Tipo documento identidad' },
          { id: 'procesoDocumento', nombre: 'Número documento identidad' }
        ];

        camposRequeridos.forEach(campo => {
          const element = document.getElementById(campo.id);
          if (element && !element.value.trim()) {
            errores.push({ element, mensaje: `${campo.nombre} es obligatorio` });
            element.classList.add('is-invalid');
            element.classList.remove('is-valid');
          }
        });

        // 2. Validar DNI/NIE si tiene valor
        const tipoDocField = document.getElementById('procesoTipoDocumento');
        const numeroDocField = document.getElementById('procesoDocumento');

        if (numeroDocField && numeroDocField.value.trim() && tipoDocField && tipoDocField.value) {
          const valor = numeroDocField.value.trim().toUpperCase();
          const tipo = tipoDocField.value;
          let esValido = false;

          if (tipo === 'DNI') {
            const regexDNI = /^(\d{1,8})([A-Z])$/;
            const match = valor.match(regexDNI);
            if (match) {
              const numeros = match[1].padStart(8, '0');
              const letrasDNI = 'TRWAGMYFPDXBNJZSQVHLCKE';
              const letraCorrecta = letrasDNI.charAt(parseInt(numeros, 10) % 23);
              esValido = match[2] === letraCorrecta;
            }
          } else if (tipo === 'NIE') {
            const regexNIE = /^([XYZ])(\d{7})([A-Z])$/;
            const match = valor.match(regexNIE);
            if (match) {
              const conversiones = { 'X': '0', 'Y': '1', 'Z': '2' };
              const numeroConvertido = conversiones[match[1]] + match[2];
              const letrasDNI = 'TRWAGMYFPDXBNJZSQVHLCKE';
              const letraCorrecta = letrasDNI.charAt(parseInt(numeroConvertido, 10) % 23);
              esValido = match[3] === letraCorrecta;
            }
          }

          if (!esValido) {
            errores.push({ element: numeroDocField, mensaje: `${tipo} inválido` });
            numeroDocField.classList.add('is-invalid');
            numeroDocField.classList.remove('is-valid');
          } else {
            numeroDocField.classList.remove('is-invalid');
            numeroDocField.classList.add('is-valid');
          }
        }

        // 3. Validar NASS si tiene valor
        const nassField = document.getElementById('procesoNAfiliacionSS');
        if (nassField && nassField.value.trim()) {
          const nass = nassField.value.replace(/[\s\-\/]/g, '');
          let nassValido = false;

          if (/^\d{12}$/.test(nass)) {
            const numeroBase = nass.substring(0, 10);
            const digitosControl = nass.substring(10, 12);
            const resto = parseInt(numeroBase, 10) % 97;
            const digitosCalculados = resto.toString().padStart(2, '0');
            nassValido = digitosControl === digitosCalculados;
          }

          if (!nassValido) {
            errores.push({ element: nassField, mensaje: 'Número de afiliación SS inválido' });
            nassField.classList.add('is-invalid');
            nassField.classList.remove('is-valid');
          } else {
            nassField.classList.remove('is-invalid');
            nassField.classList.add('is-valid');
          }
        }

        // 4. Validar teléfonos si tienen valor
        const telefonos = [
          { id: 'procesoTelefono1', nombre: 'Teléfono 1' },
          { id: 'procesoTelefono2', nombre: 'Teléfono 2' }
        ];

        telefonos.forEach(tel => {
          const field = document.getElementById(tel.id);
          if (field && field.value.trim()) {
            const telefono = field.value.replace(/[\s\-\(\)]/g, '');
            const regexMovil = /^[67]\d{8}$/;
            const regexFijo = /^[89]\d{8}$/;
            const regexInternacional = /^\+34[6-9]\d{8}$/;

            if (!(regexMovil.test(telefono) || regexFijo.test(telefono) || regexInternacional.test(telefono))) {
              errores.push({ element: field, mensaje: `${tel.nombre} inválido` });
              field.classList.add('is-invalid');
              field.classList.remove('is-valid');
            } else {
              field.classList.remove('is-invalid');
              field.classList.add('is-valid');
            }
          }
        });

        // 5. Validar emails si tienen valor
        const emails = [
          { id: 'procesoCorreoPersonal', nombre: 'Correo personal' },
          { id: 'procesoCorreoPlataforma', nombre: 'Correo plataforma' }
        ];

        const regexEmail = /^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/;

        emails.forEach(email => {
          const field = document.getElementById(email.id);
          if (field && field.value.trim()) {
            if (!regexEmail.test(field.value.trim())) {
              errores.push({ element: field, mensaje: `${email.nombre} inválido` });
              field.classList.add('is-invalid');
              field.classList.remove('is-valid');
            } else {
              field.classList.remove('is-invalid');
              field.classList.add('is-valid');
            }
          }
        });

        return errores;
      };

      if (procesoPublishButton && procesoForm) {
        procesoPublishButton.addEventListener('click', (event) => {
          event.preventDefault();

          // Realizar validación completa del formulario
          const errores = validarFormularioCompleto();

          if (errores.length > 0) {
            // Hay errores, mostrar mensaje y hacer scroll al primer campo con error
            const primerError = errores[0];

            // Hacer scroll suave hasta el primer campo con error
            if (primerError.element) {
              primerError.element.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
              });

              // Hacer focus después del scroll
              setTimeout(() => {
                primerError.element.focus();
              }, 500);
            }

            // Mostrar animación de shake en el formulario
            if (procesoFormCard) {
              procesoFormCard.classList.remove('modal-shake');
              void procesoFormCard.offsetWidth;
              procesoFormCard.classList.add('modal-shake');
            }

            // Mostrar mensaje con los errores
            const mensajesErrores = errores.map(e => e.mensaje).join(', ');
            console.warn('Errores de validación:', mensajesErrores);

            return;
          }

          // Si no hay errores, continuar con el proceso normal
          // Mostrar modal de confirmación
          const publicarModal = new bootstrap.Modal(document.getElementById('publicarConfirmModal'));
          publicarModal.show();
        });

        // Función para verificar si hay cambios en el formulario
        const checkFormChanges = () => {
          if (!originalConductorData) {
            // Si no hay datos originales, deshabilitar el botón
            procesoPublishButton.disabled = true;
            procesoPublishButton.classList.add('opacity-50');
            return;
          }

          const formData = Object.fromEntries(new FormData(procesoForm).entries());
          let hasChanges = false;

          // Comparar cada campo del formulario con los datos originales
          const changedFields = [];
          Object.keys(originalConductorData).forEach(key => {
            const currentValue = formData[key];
            const originalValue = originalConductorData[key];

            // Normalizar valores para comparación
            const normalizedCurrent = (currentValue == null || currentValue === '') ? '' : String(currentValue).trim();
            const normalizedOriginal = (originalValue == null || originalValue === '') ? '' : String(originalValue).trim();

            if (normalizedCurrent !== normalizedOriginal) {
              hasChanges = true;
              changedFields.push(key);
            }
          });

          if (changedFields.length > 0) {
            console.log('📝 Campos modificados:', changedFields.join(', '));
          }

          // Habilitar o deshabilitar el botón según si hay cambios
          if (hasChanges) {
            procesoPublishButton.disabled = false;
            procesoPublishButton.classList.remove('opacity-50');
            procesoPublishButton.style.cursor = '';
            procesoPublishButton.title = 'Hay cambios pendientes de publicar';
            console.log('✅ Botón Publicar HABILITADO - hay cambios detectados');
          } else {
            procesoPublishButton.disabled = true;
            procesoPublishButton.classList.add('opacity-50');
            procesoPublishButton.style.cursor = 'not-allowed';
            procesoPublishButton.title = 'No hay cambios para publicar';
            console.log('⛔ Botón Publicar DESHABILITADO - no hay cambios');
          }
        };

        // Escuchar cambios en todos los campos del formulario
        if (procesoForm) {
          // Detectar cambios en inputs y textareas
          procesoForm.addEventListener('input', (e) => {
            checkFormChanges(e);
            updateEmptyFieldsHighlight();
            updateWizardProgress();
          });

          // Detectar cambios en selects (incluyendo Select2)
          procesoForm.addEventListener('change', (e) => {
            checkFormChanges(e);
            updateEmptyFieldsHighlight();
            updateWizardProgress();
          });

          // Para Select2, también escuchar el evento específico
          if (window.jQuery) {
            window.jQuery(procesoForm).find('select').on('select2:select select2:unselect', () => {
              checkFormChanges();
              updateEmptyFieldsHighlight();
              updateWizardProgress();
            });
          }

          // Verificar el estado inicial cuando se carguen los datos
          // Esta función se llamará desde fillConductorForm después de cargar los datos
          window.checkFormChangesAfterLoad = () => {
            setTimeout(checkFormChanges, 100);
          };
        }

        // Manejar confirmación de publicación
        const publicarConfirmarButton = document.querySelector('[data-publicar-confirmar]');
        if (publicarConfirmarButton) {
          publicarConfirmarButton.addEventListener('click', async (event) => {
            event.preventDefault();

            // Verificar que tenemos el recordId del conductor
            if (!currentConductorRecordId) {
              console.error('No se puede publicar: falta el recordId del conductor');

              // Mostrar toast de error
              const errorToast = document.getElementById('publicarErrorToast');
              const errorMessage = document.getElementById('publicarErrorMessage');
              if (errorToast && errorMessage) {
                errorMessage.textContent = 'Error: No se puede identificar el conductor a actualizar.';
                const toast = new bootstrap.Toast(errorToast);
                toast.show();
              }
              return;
            }

            const formData = Object.fromEntries(new FormData(procesoForm).entries());
            console.log('📋 Datos del formulario capturados:', formData);
            console.log('🆔 UUID del conductor:', currentConductorId);
            console.log('🔢 RecordId de FileMaker:', currentConductorRecordId);
            console.log('💾 Datos originales (para comparación):', originalConductorData);

            const currentPageFields = WIZARD_PAGE_FIELDS[currentWizardPage] || [];
            console.log('📄 Página actual:', currentWizardPage);
            console.log('📋 Campos página actual:', currentPageFields);

            const pageFormData = {};
            currentPageFields.forEach(fieldName => {
              if (Object.prototype.hasOwnProperty.call(formData, fieldName)) {
                pageFormData[fieldName] = formData[fieldName];

                // Debug adicional para campos de fecha
                if (fieldName === 'fechaNacimiento' || fieldName === 'fechaFirma') {
                  const field = procesoForm.querySelector(`[name="${fieldName}"]`);
                  if (field && field._flatpickr) {
                    console.log(`🔍 Debug ${fieldName}:`, {
                      formDataValue: formData[fieldName],
                      fieldValue: field.value,
                      flatpickrValue: field._flatpickr.input.value,
                      altInputValue: field._flatpickr.altInput?.value,
                      selectedDates: field._flatpickr.selectedDates
                    });
                  }
                }
              }
            });
            console.log('📄 Datos página actual:', pageFormData);

            // Deshabilitar el botón durante el proceso
            const originalButtonText = publicarConfirmarButton.innerHTML;
            publicarConfirmarButton.disabled = true;
            publicarConfirmarButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Publicando...';

            try {
              // Incluir TODOS los campos de la página, incluso los vacíos
              // Esto permite que los campos borrados se guarden como vacíos en el backend
              const cleanedFormData = {};
              Object.entries(pageFormData).forEach(([key, value]) => {
                // Convertir null/undefined a string vacío
                cleanedFormData[key] = (value === null || value === undefined) ? '' : value;
              });

              console.log('🧹 Datos preparados para enviar (incluye campos vacíos):', cleanedFormData);
              console.log(`📊 Total: ${Object.keys(cleanedFormData).length} de ${currentPageFields.length} campos de la página`);

              // Preparar los datos para FileMaker (convertir fechas, etc.)
              console.log('🔧 Preparando datos para FileMaker...');
              const preparedFormData = prepareDataForFileMaker(cleanedFormData);

              // Verificar específicamente los campos de fecha
              console.log('🔍 Verificando campos de fecha en preparedFormData:');
              ['fechaNacimiento', 'fechaFirma'].forEach(field => {
                if (preparedFormData[field] !== undefined) {
                  console.log(`  - ${field}: "${preparedFormData[field]}" (tipo: ${typeof preparedFormData[field]})`);
                }
              });

              // Preparar el payload para actualizar el conductor
              const updatePayload = {
                fieldData: preparedFormData
              };

              console.log('📤 Enviando actualización al layout conductor.pdbconductor');
              console.log('📦 Payload completo:', JSON.stringify(updatePayload, null, 2));

              // Realizar la petición PATCH al backend
              const layoutName = 'conductor.pdbconductor';
              const encodedLayout = window.ApiClient.encodePathSegment(layoutName);
              const response = await window.ApiClient.patch(
                `layouts/${encodedLayout}/records/${encodeURIComponent(currentConductorRecordId)}`,
                updatePayload
              );

              console.log('📥 Respuesta del servidor, status:', response.status);

              if (!response.ok) {
                let errorDetails = '';
                try {
                  const errorJson = await response.json();
                  console.error('❌ Error JSON del servidor:', errorJson);
                  errorDetails = errorJson?.messages?.[0]?.message || JSON.stringify(errorJson);
                } catch {
                  const errorText = await response.text().catch(() => '');
                  console.error('❌ Error texto del servidor:', errorText);
                  errorDetails = errorText;
                }
                throw new Error(`Error del servidor: ${response.status} - ${errorDetails}`);
              }

              const responseData = await response.json();
              console.log('✅ Conductor actualizado exitosamente:', responseData);

              // Crear registro histórico solo con los campos modificados
              console.log('📝 Creando registro en histórico');
              console.log('🔍 Detectando campos modificados...');

              // Obtener solo los campos que han cambiado (usar los datos preparados)
              const modifiedFields = getModifiedFields(originalConductorData, preparedFormData);
              const modifiedFieldsCount = Object.keys(modifiedFields).length;
              const totalFieldsCount = Object.keys(preparedFormData).length;

              console.log(`📊 Campos modificados: ${modifiedFieldsCount} de ${totalFieldsCount} campos totales`);

              // Generar resumen legible de los cambios
              const resumen = generateModificationSummary(modifiedFields);
              console.log('📝 Resumen generado:', resumen);

              const historicoDatos = JSON.stringify(modifiedFields);
              const historicoPayload = {
                fieldData: {
                  accion: 'MODIFICACION',
                  datos: historicoDatos,
                  resumen: resumen,
                  idEntidad: currentConductorId
                }
              };

              // Agregar idProceso si está disponible
              if (currentProcesoId) {
                historicoPayload.fieldData.idProceso = currentProcesoId;
                console.log('  ✓ idProceso agregado al payload:', currentProcesoId);
              } else {
                console.warn('  ⚠️ currentProcesoId no está disponible, no se agregará al histórico');
              }

              console.log('📦 Payload del histórico (solo campos modificados):', JSON.stringify(historicoPayload, null, 2));

              const historicoResponse = await window.ApiClient.post(
                'layouts/historico/records',
                historicoPayload
              );

              console.log('📥 Respuesta de histórico, status:', historicoResponse.status);

              if (!historicoResponse.ok) {
                const errorText = await historicoResponse.text().catch(() => '');
                console.warn('Advertencia: No se pudo crear el registro histórico:', errorText);
                // No lanzamos error aquí, solo advertencia
              } else {
                const historicoData = await historicoResponse.json();
                console.log('✅ Registro histórico creado exitosamente:', historicoData);

                // Recargar la tabla de histórico para mostrar el nuevo registro
                if (currentConductorId) {
                  console.log('🔄 Recargando tabla de histórico...');
                  await initProcesoLogTable(null, currentConductorId, currentProcesoId);
                  console.log('✅ Tabla de histórico actualizada');
                }
              }

              // Cerrar la modal
              const publicarModal = bootstrap.Modal.getInstance(document.getElementById('publicarConfirmModal'));
              if (publicarModal) {
                publicarModal.hide();
              }

              // Recargar los datos del conductor para actualizar el panel de detalle
              console.log('🔄 Recargando datos del conductor para actualizar la vista...');
              try {
                const layout = 'conductor.pdbconductor';
                const reloadResponse = await window.ApiClient.get(
                  `layouts/${window.ApiClient.encodePathSegment(layout)}/records/${encodeURIComponent(currentConductorRecordId)}`
                );

                if (reloadResponse.ok) {
                  const reloadData = await reloadResponse.json();
                  const updatedRecord = reloadData?.response?.data?.[0];

                  if (updatedRecord) {
                    console.log('✅ Datos recargados exitosamente:', updatedRecord);

                    // Actualizar el formulario del panel izquierdo
                    const updatedFieldData = updatedRecord?.fieldData;
                    if (updatedFieldData) {
                      // Actualizar el título del encabezado
                      updatePageTitle(updatedFieldData);

                      fillConductorForm(updatedFieldData);
                      console.log('✅ Formulario del panel izquierdo actualizado');
                    }

                    // Actualizar el panel de detalle (derecho)
                    if (typeof renderDetail === 'function') {
                      console.log('🔄 Actualizando panel de detalle con registro:', updatedRecord);

                      // Usar setTimeout para asegurar que el DOM esté listo
                      setTimeout(() => {
                        renderDetail(updatedRecord);
                        console.log('✅ Panel de detalle actualizado');

                        // Reiniciar iconos de Lucide para el detalle
                        if (typeof lucide !== 'undefined') {
                          lucide.createIcons();
                        }
                      }, 200);
                    } else {
                      console.error('⚠️ renderDetail no está disponible');
                    }
                  }
                } else {
                  console.warn('⚠️ No se pudieron recargar los datos actualizados');
                }
              } catch (reloadError) {
                console.warn('⚠️ Error al recargar datos:', reloadError);
                // No mostramos error al usuario, ya que la publicación fue exitosa
              }

              // Mostrar toast de éxito
              const successToast = document.getElementById('publicarSuccessToast');
              if (successToast) {
                const toast = new bootstrap.Toast(successToast);
                toast.show();
                // Reiniciar iconos de Lucide después de mostrar el toast
                setTimeout(() => {
                  if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                  }
                }, 100);
              }

            } catch (error) {
              console.error('❌ Error al publicar conductor:', error);

              // Mostrar toast de error
              const errorToast = document.getElementById('publicarErrorToast');
              const errorMessage = document.getElementById('publicarErrorMessage');
              if (errorToast && errorMessage) {
                errorMessage.textContent = `Error al publicar el conductor: ${error.message}`;
                const toast = new bootstrap.Toast(errorToast);
                toast.show();
                // Reiniciar iconos de Lucide después de mostrar el toast
                setTimeout(() => {
                  if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                  }
                }, 100);
              }
            } finally {
              // Restaurar el botón
              publicarConfirmarButton.disabled = false;
              publicarConfirmarButton.innerHTML = originalButtonText;
            }
          });
        }
      }

      if (procesoCancelButton) {
        procesoCancelButton.addEventListener('click', (event) => {
          event.preventDefault();
          window.location.href = 'ListaConductores.html';
        });
      }

      const loadProcessSelectionFromStorage = () => {
        try {
          if (typeof window === 'undefined' || !window.sessionStorage) {
            return null;
          }
          const raw = window.sessionStorage.getItem(PROCESS_SELECTION_STORAGE_KEY);
          if (!raw) {
            return null;
          }
          const parsed = JSON.parse(raw);
          return parsed && typeof parsed === 'object' ? parsed : null;
        } catch (_) {
          return null;
        }
      };

      const navigateToProcessRoute = (nodeId) => {
        if (!nodeId) {
          return false;
        }
        const destination = TREEVIEW_PROCESS_ROUTES.get(nodeId);
        if (!destination) {
          return false;
        }
        window.location.href = destination;
        return true;
      };

      const getTreeviewElements = () => {
        const container = document.querySelector('[data-clientes-treeview]');
        if (!container) {
          return null;
        }
        return {
          container,
          body: container.querySelector('[data-treeview-body]'),
          status: container.querySelector('[data-treeview-status]')
        };
      };

      const getIconNameForType = (type) => {
        const normalized = String(type ?? '').toLowerCase();
        if (normalized === 'proceso') {
          return 'settings';
        }
        if (normalized === 'grupo' || normalized === 'subgrupo' || normalized === 'entidad') {
          return 'folder';
        }
        return 'circle';
      };

      const normalizeFieldKey = (value) => {
        return String(value ?? '')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-zA-Z0-9]+/g, '')
          .toLowerCase();
      };

      const getFieldValue = (record, aliases = []) => {
        if (!record || !Array.isArray(aliases) || !aliases.length) {
          return '';
        }
        const fieldData = record.fieldData ?? {};
        const normalizedMap = new Map();
        Object.entries(fieldData).forEach(([key, value]) => {
          const normalizedKey = normalizeFieldKey(key);
          if (!normalizedKey || normalizedMap.has(normalizedKey)) {
            return;
          }
          normalizedMap.set(normalizedKey, value);
        });
        for (const alias of aliases) {
          const normalizedAlias = normalizeFieldKey(alias);
          if (!normalizedAlias) {
            continue;
          }
          if (normalizedMap.has(normalizedAlias)) {
            const raw = normalizedMap.get(normalizedAlias);
            if (typeof raw === 'string') {
              const trimmed = raw.trim();
              if (trimmed) {
                return trimmed;
              }
            }
            if (raw !== null && raw !== undefined) {
              const coerced = String(raw).trim();
              if (coerced) {
                return coerced;
              }
            }
          }
        }
        return '';
      };

      const computeRecordDisplayLabel = (record) => {
        if (!record) {
          return '';
        }
        const preferred = getFieldValue(record, [
          'Nombre completo',
          'nombreCompleto',
          'NombreCompleto',
          'nombrecompleto',
          'nombre'
        ]);
        if (preferred) {
          return preferred;
        }
        const parts = [
          getFieldValue(record, ['nombre']),
          getFieldValue(record, ['apellido1', 'primerApellido']),
          getFieldValue(record, ['apellido2', 'segundoApellido'])
        ].filter(Boolean);
        if (parts.length) {
          return parts.join(' ');
        }
        if (record.recordId !== undefined && record.recordId !== null && String(record.recordId).trim()) {
          return `ID ${record.recordId}`;
        }
        return 'seleccionado';
      };

      const computeRecordDocumentId = (record) => {
        return getFieldValue(record, [
          'ndocumentoidentidad',
          'nDocumentoIdentidad',
          'NDocumentoIdentidad',
          'numeroDocumentoIdentidad',
          'documentoidentidad',
          'DocumentoIdentidad',
          'documentoIdentidad',
          'dni',
          'DNI'
        ]);
      };

      const updateProcessActionsName = (displayName, record) => {
        const nameTarget = document.querySelector('[data-clientes-actions-name]');
        if (!nameTarget) {
          return;
        }
        let finalName = typeof displayName === 'string' && displayName.trim() ? displayName.trim() : '';
        if (!finalName && record) {
          finalName = computeRecordDisplayLabel(record);
        }
        nameTarget.textContent = finalName || 'seleccionado';
      };

      const setCurrentRecordSummary = (record) => {
        if (!record) {
          currentRecordSummary = { fullName: null, dni: null };
          return currentRecordSummary;
        }
        currentRecordSummary = {
          fullName: computeRecordDisplayLabel(record) || null,
          dni: computeRecordDocumentId(record) || null
        };
        return currentRecordSummary;
      };

      const updatePageHeaderFromRecord = (record) => {
        setCurrentRecordSummary(record);
        updatePageHeader();
      };

      const processPreBuiltHierarchy = (hierarchyArray) => {
        const nodes = new Map();

        const processNode = (node, nivel = 0) => {
          const normalizedId = String(node?.id ?? '').trim();
          if (!normalizedId) {
            return null;
          }

          const processedNode = {
            ...node,
            id: normalizedId,
            idPadre: String(node?.idPadre ?? '').trim(),
            nivel: nivel,
            orden: Number.parseInt(node?.orden ?? '0', 10) || 0,
            children: []
          };

          nodes.set(normalizedId, processedNode);

          if (Array.isArray(node.children) && node.children.length > 0) {
            node.children.forEach((child) => {
              const processedChild = processNode(child, nivel + 1);
              if (processedChild) {
                processedNode.children.push(processedChild);
              }
            });
          }

          return processedNode;
        };

        const roots = hierarchyArray
          .map(node => processNode(node, 0))
          .filter(Boolean);

        return { roots, nodes };
      };

      const buildHierarchy = (records) => {
        const nodes = new Map();
        const roots = [];

        records.forEach((record) => {
          const normalizedId = String(record?.id ?? '').trim();
          if (!normalizedId) {
            return;
          }
          nodes.set(normalizedId, {
            ...record,
            id: normalizedId,
            idPadre: String(record?.idPadre ?? '').trim(),
            nivel: Number.parseInt(record?.nivel ?? '0', 10) || 0,
            orden: Number.parseInt(record?.orden ?? '0', 10) || 0,
            children: []
          });
        });

        nodes.forEach((node) => {
          if (node.idPadre && nodes.has(node.idPadre)) {
            nodes.get(node.idPadre).children.push(node);
          } else {
            roots.push(node);
          }
        });

        const sortNodes = (list) => {
          list.sort((a, b) => {
            if (a.orden !== b.orden) {
              return a.orden - b.orden;
            }
            return String(a.nombre ?? '').localeCompare(String(b.nombre ?? ''), 'es', { sensitivity: 'base' });
          });
          list.forEach((child) => sortNodes(child.children));
        };

        sortNodes(roots);
        return { roots, nodes };
      };

      const createTreeItem = (node) => {
        const hasChildren = Array.isArray(node.children) && node.children.length > 0;
        const isRoot = !node.idPadre;
        const listItem = document.createElement('li');
        listItem.className = 'treeview-item';
        listItem.setAttribute('role', 'treeitem');
        listItem.dataset.nodeId = node.id || '';
        listItem.dataset.defaultExpanded = 'false';
        listItem.setAttribute('aria-label', node.nombre ?? 'Elemento');
        if (hasChildren) {
          listItem.dataset.treeItem = '';
        }
        if (node.nivel > 0) {
          listItem.setAttribute('aria-level', String(node.nivel));
        }

        const nodeWrapper = document.createElement('div');
        nodeWrapper.className = `treeview-node${hasChildren ? '' : ' treeview-node--leaf'}`;

        const toggle = document.createElement(hasChildren ? 'button' : 'span');
        toggle.className = hasChildren ? 'treeview-toggle' : 'treeview-toggle treeview-toggle--placeholder';
        if (hasChildren) {
          toggle.type = 'button';
          toggle.dataset.treeToggle = '';
          toggle.setAttribute('aria-label', `Alternar ${node.nombre ?? 'elemento'}`);
        } else {
          toggle.setAttribute('aria-hidden', 'true');
        }

        const icon = document.createElement('span');
        icon.className = 'treeview-icon';
        const iconName = getIconNameForType(node.tipo);
        icon.innerHTML = `<i data-lucide="${iconName}"></i>`;

        const isProcessNode = String(node.tipo ?? '').toLowerCase() === 'proceso';
        const label = document.createElement(isProcessNode ? 'button' : 'span');
        label.className = 'treeview-label';
        label.textContent = node.nombre || 'Elemento';
        if (label.tagName === 'BUTTON') {
          label.type = 'button';
        }
        if (isProcessNode) {
          label.dataset.treeAction = 'navigate';
        }

        nodeWrapper.append(toggle, icon, label);
        listItem.appendChild(nodeWrapper);

        if (hasChildren) {
          const childList = document.createElement('ul');
          childList.className = 'treeview-list';
          childList.setAttribute('role', 'group');
          const shouldExpand = isRoot;
          listItem.dataset.defaultExpanded = String(shouldExpand);
          listItem.setAttribute('aria-expanded', String(shouldExpand));
          if (!shouldExpand) {
            listItem.dataset.treeCollapsed = 'true';
            childList.setAttribute('hidden', '');
          } else {
            listItem.classList.remove('is-collapsed');
          }
          node.children.forEach((child) => {
            childList.appendChild(createTreeItem(child));
          });
          listItem.appendChild(childList);
        }

        return listItem;
      };

      function initTreeview() {
        const treeRoot = document.querySelector('[data-clientes-treeview] .treeview-list');
        if (!treeRoot) {
          return;
        }

        const setTreeItemState = (item, expanded) => {
          const childList = item.querySelector(':scope > .treeview-list');
          const toggle = item.querySelector(':scope > .treeview-node [data-tree-toggle]');
          item.setAttribute('aria-expanded', String(expanded));
          item.classList.toggle('is-collapsed', !expanded);
          if (toggle) {
            toggle.setAttribute('aria-expanded', String(expanded));
          }
          if (childList) {
            if (expanded) {
              childList.removeAttribute('hidden');
            } else {
              childList.setAttribute('hidden', '');
            }
          }
        };

        const items = treeRoot.querySelectorAll('[data-tree-item]');
        items.forEach((item) => {
          const collapsed = item.dataset.treeCollapsed === 'true' || item.getAttribute('aria-expanded') === 'false';
          setTreeItemState(item, !collapsed);
        });

        treeRoot.addEventListener('click', (event) => {
          const toggle = event.target.closest('[data-tree-toggle]');
          if (!toggle || !treeRoot.contains(toggle)) {
            return;
          }
          event.preventDefault();
          const item = toggle.closest('[data-tree-item]');
          if (!item) {
            return;
          }
          const expanded = item.getAttribute('aria-expanded') === 'true';
          setTreeItemState(item, !expanded);
        });

        treeRoot.addEventListener('keydown', (event) => {
          if (event.key !== 'Enter' && event.key !== ' ') {
            return;
          }
          const toggle = event.target.closest('[data-tree-toggle]');
          if (!toggle || !treeRoot.contains(toggle)) {
            return;
          }
          event.preventDefault();
          toggle.click();
        });

        treeRoot.addEventListener('click', (event) => {
          const label = event.target.closest('.treeview-label');
          if (!label || !treeRoot.contains(label)) {
            return;
          }
          if (event.target.closest('[data-tree-toggle]')) {
            return;
          }
          const item = label.closest('.treeview-item');
          if (!item) {
            return;
          }
          const nodeId = item.dataset.nodeId;
          const record = treeviewCache.nodesById.get(nodeId);
          if (!record || String(record?.tipo ?? '').toLowerCase() !== 'proceso') {
            return;
          }
          if (navigateToProcessRoute(record.id)) {
            event.preventDefault();
            event.stopPropagation();
          }
        });

        treeRoot.addEventListener('keydown', (event) => {
          if (event.key !== 'Enter' && event.key !== ' ') {
            return;
          }
          if (event.target.closest('[data-tree-toggle]')) {
            return;
          }
          const label = event.target.closest('.treeview-label');
          if (!label || !treeRoot.contains(label)) {
            return;
          }
          const item = label.closest('.treeview-item');
          if (!item) {
            return;
          }
          const nodeId = item.dataset.nodeId;
          const record = treeviewCache.nodesById.get(nodeId);
          if (!record || String(record?.tipo ?? '').toLowerCase() !== 'proceso') {
            return;
          }
          if (navigateToProcessRoute(record.id)) {
            event.preventDefault();
            event.stopPropagation();
          }
        });
      }

      let treeviewCache = {
        nodesById: new Map(),
        rootList: null,
        searchInput: null
      };

      const applyDefaultTreeState = () => {
        if (!treeviewCache.rootList) {
          return;
        }
        const items = treeviewCache.rootList.querySelectorAll('.treeview-item');
        items.forEach((item) => {
          item.hidden = false;
          item.classList.remove('treeview-item--match');
          const childList = item.querySelector(':scope > .treeview-list');
          if (childList) {
            const defaultExpanded = item.dataset.defaultExpanded === 'true';
            item.setAttribute('aria-expanded', String(defaultExpanded));
            if (defaultExpanded) {
              childList.removeAttribute('hidden');
              item.classList.remove('is-collapsed');
            } else {
              childList.setAttribute('hidden', '');
              item.classList.add('is-collapsed');
            }
          }
        });
        window.lucide?.createIcons?.();
      };

      const filterTree = (query) => {
        const elements = getTreeviewElements();
        if (!elements || !treeviewCache.rootList) {
          return;
        }

        const normalized = query.trim().toLowerCase();
        const showAll = normalized.length === 0;

        if (showAll) {
          applyDefaultTreeState();
          return;
        }

        const matchesQuery = (node) => {
          return String(node?.nombre ?? '').toLowerCase().includes(normalized);
        };

        applyDefaultTreeState();

        const walk = (element) => {
          const item = element;
          const nodeId = item.dataset.nodeId;
          const nodeData = treeviewCache.nodesById.get(nodeId);
          const hasChildren = item.querySelector(':scope > .treeview-list') !== null;
          let selfMatches = false;
          let childrenMatch = false;

          if (hasChildren) {
            const childItems = Array.from(item.querySelectorAll(':scope > .treeview-list > .treeview-item'));
            childrenMatch = childItems.some((child) => walk(child));
          }

          if (nodeData && matchesQuery(nodeData)) {
            selfMatches = true;
          }

          const shouldShow = selfMatches || childrenMatch;
          item.hidden = !shouldShow;

          if (hasChildren) {
            const childList = item.querySelector(':scope > .treeview-list');
            if (childList) {
              const expanded = shouldShow && (selfMatches || childrenMatch);
              item.setAttribute('aria-expanded', String(expanded));
              if (expanded) {
                item.classList.remove('is-collapsed');
                childList.removeAttribute('hidden');
              } else {
                childList.setAttribute('hidden', '');
                item.classList.add('is-collapsed');
              }
            }
          }

          if (selfMatches) {
            item.classList.add('treeview-item--match');
          } else {
            item.classList.remove('treeview-item--match');
          }

          return shouldShow;
        };

        const roots = Array.from(treeviewCache.rootList.children);
        roots.forEach((root) => walk(root));

        window.lucide?.createIcons?.();
      };

      const loadTreeviewMenu = async () => {
        const elements = getTreeviewElements();
        if (!elements || !elements.body) {
          return;
        }

        const { body, status } = elements;
        const setStatus = (message, isError = false) => {
          if (!status) {
            return;
          }
          status.textContent = message || '';
          status.classList.toggle('text-danger', Boolean(message) && isError);
          status.classList.toggle('d-none', !message);
        };

        setStatus('Cargando menú…');
        body.querySelectorAll('.treeview-list').forEach((list) => list.remove());

        try {
          const response = await fetch(TREEVIEW_DATA_URL, { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`Error ${response.status}`);
          }
          const payload = await response.json();
          const records = Array.isArray(payload?.data) ? payload.data : (Array.isArray(payload) ? payload : []);
          const activeRecords = records.filter((record) => {
            const isActive = record?.activado ?? record?.isActivo;
            return String(isActive ?? '0') !== '0';
          });

          // Detectar si es una jerarquía pre-construida (tiene children) o un array plano
          const isPreBuilt = activeRecords.length > 0 && activeRecords.some(record =>
            Array.isArray(record?.children) && record.children.length > 0
          );

          const { roots, nodes } = isPreBuilt
            ? processPreBuiltHierarchy(activeRecords)
            : buildHierarchy(activeRecords);
          if (!roots.length) {
            setStatus('Sin procesos disponibles.');
            return;
          }

          // Extraer los hijos del nivel 1, omitiendo el nodo raíz (nivel 0)
          const level1Nodes = [];
          roots.forEach((root) => {
            if (Array.isArray(root.children) && root.children.length > 0) {
              level1Nodes.push(...root.children);
            }
          });

          if (!level1Nodes.length) {
            setStatus('Sin procesos disponibles.');
            return;
          }

          const rootList = document.createElement('ul');
          rootList.className = 'treeview-list';
          rootList.setAttribute('role', 'tree');

          level1Nodes.forEach((node) => {
            const treeItem = createTreeItem(node);
            rootList.appendChild(treeItem);
          });

          treeviewCache = {
            nodesById: nodes,
            rootList,
            searchInput: null
          };

          const { container } = elements;
          const searchInput = container.querySelector('[data-treeview-search]');
          if (searchInput) {
            searchInput.value = '';
            searchInput.addEventListener('input', (event) => {
              filterTree(event.target.value || '');
            });
            treeviewCache.searchInput = searchInput;
          }

          body.appendChild(rootList);
          setStatus('');
          window.lucide?.createIcons?.();
          initTreeview();
          applyDefaultTreeState();
        } catch (error) {
          console.error('No se pudo cargar el menú de procesos', error);
          setStatus('No se pudo cargar el menú de procesos.', true);
        }
      };

      loadTreeviewMenu();

      document.addEventListener('clientesTable:select', () => {
        if (!treeviewCache.rootList) {
          return;
        }
        if (treeviewCache.searchInput) {
          treeviewCache.searchInput.value = '';
        }
        applyDefaultTreeState();
      });

      const wrapper = document.querySelector('[data-resizable-wrapper]');
      if (!wrapper) return;

      const topPanel = wrapper.querySelector('[data-resizable-top]');
      const bottomPanel = wrapper.querySelector('[data-resizable-bottom]');
      const handle = wrapper.querySelector('[data-resizable-handle]');
      if (!topPanel || !bottomPanel || !handle) return;
      handle.setAttribute('aria-expanded', 'true');

      const detailContainer = bottomPanel.querySelector('[data-clientes-detail-container]');
      const detailTabsWrapper = bottomPanel.querySelector('[data-clientes-detail-tabs-wrapper]');
      const detailForm = bottomPanel.querySelector('[data-clientes-detail-form]');
      const detailGrid = bottomPanel.querySelector('[data-clientes-detail-grid]');
      const detailLayout = bottomPanel.querySelector('[data-clientes-detail-layout]');
      const detailContent = bottomPanel.querySelector('[data-clientes-detail-content]');
      const detailCategoryNav = bottomPanel.querySelector('[data-clientes-detail-category-nav]');
      const detailSearchWrapper = bottomPanel.querySelector('[data-clientes-detail-search]');
      const detailSearchInput = bottomPanel.querySelector('[data-clientes-detail-search-input]');
      const detailEmpty = bottomPanel.querySelector('[data-clientes-detail-empty]');
      const viewSelect = document.querySelector('[data-clientes-view-select]');
      const detailSelectOption = viewSelect?.querySelector('option[value="detail"]') ?? null;
      const columnsWrapper = document.querySelector('[data-clientes-columns-wrapper]');
      const tableSearchWrapper = document.querySelector('[data-clientes-table-search-wrapper]');
      const tableSearchInput = document.querySelector('[data-clientes-table-search]');
      const viewPresetsGroup = document.querySelector('[data-clientes-view-presets]');
      const viewPresetAddButton = document.querySelector('[data-clientes-view-preset-add]');
      const viewPresetDropdownToggle = document.querySelector('[data-clientes-view-presets-toggle]');
      const viewPresetList = document.querySelector('[data-clientes-view-preset-list]');
      const viewPresetEmpty = document.querySelector('[data-clientes-view-preset-empty]');
      const pageTitleEl = document.querySelector('[data-clientes-title]');
      const pageSubtitleEl = document.querySelector('[data-clientes-subtitle]');
      const defaultPageTitle = pageTitleEl?.textContent?.trim() || 'Conductores';
      const defaultPageSubtitle = pageSubtitleEl?.textContent?.trim() || 'Gestiona y analiza la lista de conductores.';
      const allowedViewModes = ['split-vertical'];
      const initialViewMode = viewSelect && allowedViewModes.includes(viewSelect.value) ? viewSelect.value : 'split-vertical';
      let currentViewMode = initialViewMode;
      let hasActiveRecord = false;
      let currentRecordSummary = {
        fullName: null,
        dni: null
      };
      const resizableViewModes = new Set(['split-vertical']);
      const isResizableMode = (mode = currentViewMode) => resizableViewModes.has(mode);
      const isVerticalSplitMode = (mode = currentViewMode) => mode === 'split-vertical';
      const detailGridTwoColumnMinWidth = 720;
      const detailNavBreakpoint = typeof window.matchMedia === 'function'
        ? window.matchMedia('(max-width: 1199.98px)')
        : null;
      const updateDetailGridColumns = () => {
        if (!detailGrid) {
          return;
        }
        if (!isVerticalSplitMode()) {
          detailGrid.removeAttribute('data-layout-columns');
          return;
        }
        const width = detailGrid.getBoundingClientRect().width || detailGrid.offsetWidth || 0;
        const desired = width >= detailGridTwoColumnMinWidth ? '2' : '1';
        detailGrid.setAttribute('data-layout-columns', desired);
      };
      let detailGridResizeObserver = null;
      let detailSectionObserver = null;
      let detailNavItems = [];
      let detailSearchIndex = [];
      if (typeof ResizeObserver === 'function' && detailGrid) {
        detailGridResizeObserver = new ResizeObserver(() => {
          updateDetailGridColumns();
        });
        detailGridResizeObserver.observe(bottomPanel);
      }

      const setActiveDetailNavItem = (sectionId) => {
        detailNavItems.forEach(({ button, id }) => {
          const isActive = id === sectionId;
          button.classList.toggle('active', isActive);
          button.setAttribute('aria-current', isActive ? 'true' : 'false');
        });
      };

      const getDetailScrollContainer = () => detailForm ?? detailContent ?? detailContainer;

      const scrollToDetailSection = (sectionId, { behavior = 'smooth' } = {}) => {
        const scrollContainer = getDetailScrollContainer();
        if (!scrollContainer || !sectionId) {
          return;
        }
        const target = scrollContainer.querySelector?.(`#${sectionId}`) ?? detailContent?.querySelector?.(`#${sectionId}`);
        if (!target) {
          return;
        }
        const contentRect = scrollContainer.getBoundingClientRect();
        const targetRect = target.getBoundingClientRect();
        const offset = targetRect.top - contentRect.top + scrollContainer.scrollTop - 12;
        scrollContainer.scrollTo({
          top: offset > 0 ? offset : 0,
          behavior,
        });
        setActiveDetailNavItem(sectionId);
      };

      const scrollToDetailFieldElement = (element, { behavior = 'smooth' } = {}) => {
        const scrollContainer = getDetailScrollContainer();
        if (!scrollContainer || !element) {
          return;
        }
        const contentRect = scrollContainer.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();
        const offset = elementRect.top - contentRect.top + scrollContainer.scrollTop - 16;
        scrollContainer.scrollTo({
          top: offset > 0 ? offset : 0,
          behavior,
        });
      };

      const clearDetailFieldHighlights = () => {
        detailSearchIndex.forEach(({ element }) => {
          element.classList.remove('detail-field-highlight');
        });
      };

      const applyFieldHighlight = (element) => {
        if (!element) return;
        element.classList.remove('detail-field-highlight');
        void element.offsetWidth;
        element.classList.add('detail-field-highlight');
      };

      const syncDetailCategoryNavVisibility = (mode = currentViewMode) => {
        if (!detailCategoryNav) {
          return;
        }
        const isCompact = detailNavBreakpoint?.matches ?? false;
        const shouldShow = mode === 'split-vertical' && detailNavItems.length > 0 && !isCompact;
        detailCategoryNav.classList.toggle('d-none', !shouldShow);
        detailCategoryNav.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
      };

      if (detailCategoryNav) {
        detailCategoryNav.addEventListener('click', (event) => {
          const trigger = event.target instanceof HTMLElement ? event.target.closest('[data-detail-nav-target]') : null;
          if (!trigger) {
            return;
          }
          event.preventDefault();
          const targetId = trigger.getAttribute('data-detail-nav-target');
          if (targetId) {
            scrollToDetailSection(targetId);
          }
        });
      }

      if (detailSearchInput) {
        detailSearchInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
          }
        });
        detailSearchInput.addEventListener('input', (event) => {
          const term = String(event.target.value ?? '').trim();
          clearDetailFieldHighlights();
          if (!term) {
            return;
          }
          const normalizedTerm = normalizeDetailFieldName(term);
          if (!normalizedTerm) {
            return;
          }
          const matches = detailSearchIndex.filter(
            ({ normalizedLabel }) => typeof normalizedLabel === 'string' && normalizedLabel.includes(normalizedTerm)
          );
          if (!matches.length) {
            return;
          }
          matches.forEach(({ element }) => applyFieldHighlight(element));
          const primary = matches[0];
          if (primary?.element) {
            if (primary.sectionId) {
              setActiveDetailNavItem(primary.sectionId);
            }
            scrollToDetailFieldElement(primary.element);
          }
        });
      }
      const syncViewSelect = (mode) => {
        if (!viewSelect) {
          return;
        }
        viewSelect.value = allowedViewModes.includes(mode) ? mode : 'split-vertical';
      };

      const setDetailOptionEnabled = (enabled) => {
        if (!detailSelectOption) {
          return;
        }
        detailSelectOption.disabled = !enabled;
        detailSelectOption.hidden = !enabled;
        if (!enabled) {
          detailSelectOption.selected = false;
          if (viewSelect && viewSelect.value === 'detail') {
            viewSelect.value = 'split-vertical';
          }
        }
      };

      const updateTableSearchVisibility = () => {
        if (!tableSearchWrapper) {
          return;
        }
        const shouldHide = currentViewMode === 'detail';
        tableSearchWrapper.classList.toggle('d-none', shouldHide);
        tableSearchWrapper.setAttribute('aria-hidden', shouldHide ? 'true' : 'false');
        if (tableSearchInput) {
          if (shouldHide && document.activeElement === tableSearchInput) {
            tableSearchInput.blur();
          }
          tableSearchInput.disabled = shouldHide;
        }
      };

      const escapeHtml = (value) => {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      };

      const getViewModeLabel = (mode) => {
        switch (mode) {
          case 'split':
            return 'Horizontal';
          case 'split-vertical':
            return 'Vertical';
          case 'detail':
            return 'Detalle';
          case 'list':
            return 'Listado';
          default:
            return 'Vista';
        }
      };

      const getPresetStorage = (() => {
        let cached = undefined;
        return () => {
          if (cached !== undefined) {
            return cached;
          }
          cached = null;
          try {
            if (typeof window !== 'undefined' && window.localStorage) {
              const testKey = '__vp_test__';
              window.localStorage.setItem(testKey, '1');
              window.localStorage.removeItem(testKey);
              cached = window.localStorage;
            }
          } catch (_) {
            cached = null;
          }
          return cached;
        };
      })();

      const getPresetStorageKey = () => {
        const rawUser = window.AuthStorage?.getUser?.();
        const normalizedUser = typeof rawUser === 'string' && rawUser.trim()
          ? rawUser.trim().toLowerCase().replace(/[^a-z0-9_-]+/gi, '_')
          : 'anonimo';
        return `clientes.view-presets:${normalizedUser}`;
      };

      const generatePresetId = () => {
        const fallback = `vp-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        try {
          if (typeof window !== 'undefined' && window.crypto?.randomUUID) {
            return `vp-${window.crypto.randomUUID()}`;
          }
        } catch (_) {
          // Ignore and use fallback.
        }
        return fallback;
      };

      let viewPresets = [];
      let isTableReady = false;
      let pendingTablePreset = null;
      let pendingHandleRestore = null;

      const loadViewPresets = () => {
        const storage = getPresetStorage();
        if (!storage) {
          viewPresets = [];
          return;
        }
        try {
          const raw = storage.getItem(getPresetStorageKey());
          if (!raw) {
            viewPresets = [];
            return;
          }
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) {
            viewPresets = [];
            return;
          }
          viewPresets = parsed
            .filter((item) => item && typeof item === 'object' && typeof item.name === 'string')
            .map((item) => ({
              id: typeof item.id === 'string' ? item.id : generatePresetId(),
              name: item.name,
              viewMode: typeof item.viewMode === 'string' ? item.viewMode : 'split-vertical',
              table: item.table && typeof item.table === 'object' ? item.table : {},
              handle: item.handle && typeof item.handle === 'object' ? item.handle : null
            }));
        } catch (_) {
          viewPresets = [];
        }
      };

      const saveViewPresets = () => {
        const storage = getPresetStorage();
        if (!storage) {
          return;
        }
        try {
          storage.setItem(getPresetStorageKey(), JSON.stringify(viewPresets));
        } catch (_) {
          // Ignore storage issues (quota, privacy mode, etc.).
        }
      };

      const renderViewPresetMenu = () => {
        if (!viewPresetList || !viewPresetEmpty) {
          return;
        }
        viewPresetList.innerHTML = '';
        if (!Array.isArray(viewPresets) || !viewPresets.length) {
          viewPresetEmpty.classList.remove('d-none');
          window.lucide?.createIcons?.();
          return;
        }
        viewPresetEmpty.classList.add('d-none');
        viewPresets.forEach((preset) => {
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'dropdown-item d-flex align-items-center justify-content-between gap-2';
          item.dataset.clientesViewPresetItem = preset.id;
          item.innerHTML = `
            <span class="flex-grow-1 text-start text-truncate">${escapeHtml(preset.name)}</span>
            <span class="badge bg-light text-body-secondary border">${escapeHtml(getViewModeLabel(preset.viewMode))}</span>
          `;
          viewPresetList.appendChild(item);
        });
        window.lucide?.createIcons?.();
      };

      const updateViewPresetControlsAvailability = () => {
        const shouldDisableAdd = !isTableReady;
        if (viewPresetAddButton) {
          viewPresetAddButton.disabled = shouldDisableAdd;
          viewPresetAddButton.setAttribute('aria-disabled', shouldDisableAdd ? 'true' : 'false');
        }
        if (viewPresetsGroup) {
          viewPresetsGroup.dataset.disabled = shouldDisableAdd ? 'true' : 'false';
        }
      };

      const captureHandleState = () => {
        if (!isResizableMode()) {
          return null;
        }
        const wrapperRect = wrapper.getBoundingClientRect();
        const axisSize = isVerticalSplitMode() ? wrapperRect.width : wrapperRect.height;
        const primarySize = getPanelCurrentSize(topPanel);
        const ratio = axisSize ? primarySize / axisSize : null;
        return {
          mode: currentViewMode,
          orientation: isVerticalSplitMode() ? 'vertical' : 'horizontal',
          primarySize: Number.isFinite(primarySize) ? primarySize : null,
          axisSize: Number.isFinite(axisSize) ? axisSize : null,
          ratio: Number.isFinite(ratio) ? ratio : null
        };
      };

      const captureCurrentPresetSnapshot = () => {
        const getTableState = window.ClientesTable?.getState;
        if (typeof getTableState !== 'function') {
          return null;
        }
        const tableState = getTableState();
        if (!tableState) {
          return null;
        }
        return {
          viewMode: currentViewMode,
          handle: captureHandleState(),
          table: tableState
        };
      };

      const applyPendingHandleRestore = () => {
        if (!pendingHandleRestore) {
          return;
        }
        if (!isResizableMode() || !pendingHandleRestore || !isResizableMode(pendingHandleRestore.mode)) {
          pendingHandleRestore = null;
          return;
        }
        const orientationMatches =
          (pendingHandleRestore.orientation === 'vertical') === isVerticalSplitMode();
        if (!orientationMatches) {
          pendingHandleRestore = null;
          return;
        }
        const bounds = getBounds();
        if (!bounds) {
          return;
        }
        let desired = null;
        if (Number.isFinite(pendingHandleRestore.ratio) && Number.isFinite(bounds.axisSize)) {
          desired = pendingHandleRestore.ratio * bounds.axisSize;
        } else if (Number.isFinite(pendingHandleRestore.primarySize)) {
          desired = pendingHandleRestore.primarySize;
        }
        if (Number.isFinite(desired)) {
          scheduleApplySizes(desired);
        }
        pendingHandleRestore = null;
      };

      const closeViewPresetDropdown = () => {
        if (!viewPresetDropdownToggle || typeof bootstrap === 'undefined') {
          return;
        }
        const instance = bootstrap.Dropdown.getOrCreateInstance(viewPresetDropdownToggle);
        instance?.hide?.();
      };

      const applyTablePresetState = (preset) => {
        if (!preset || !preset.table) {
          return;
        }
        const applyTableState = window.ClientesTable?.applyState;
        if (typeof applyTableState !== 'function') {
          return;
        }
        applyTableState(preset.table);
      };

      const applyViewPreset = (preset) => {
        if (!preset) {
          return;
        }
        pendingHandleRestore = preset.handle ?? null;
        setViewMode(preset.viewMode ?? 'split-vertical', { force: true });
        if (isTableReady) {
          applyTablePresetState(preset);
        } else {
          pendingTablePreset = preset;
        }
        requestAnimationFrame(() => applyPendingHandleRestore());
        closeViewPresetDropdown();
      };

      const handleViewPresetAdd = () => {
        const snapshot = captureCurrentPresetSnapshot();
        if (!snapshot) {
          window.alert?.('La tabla todavía no está disponible para guardar la visualización.');
          return;
        }
        const suggestedName = `Vista ${viewPresets.length + 1}`;
        const rawName = window.prompt?.('Introduce un nombre para la visualización:', suggestedName) ?? '';
        const name = rawName.trim();
        if (!name) {
          return;
        }
        const preset = {
          id: generatePresetId(),
          name,
          viewMode: snapshot.viewMode,
          handle: snapshot.handle,
          table: snapshot.table
        };
        viewPresets.push(preset);
        saveViewPresets();
        renderViewPresetMenu();
      };

      const handleViewPresetSelection = (event) => {
        const target = event.target;
        const option = target?.closest?.('[data-clientes-view-preset-item]');
        if (!option) {
          return;
        }
        const presetId = option.dataset.clientesViewPresetItem;
        const preset = viewPresets.find((item) => item.id === presetId);
        if (preset) {
          applyViewPreset(preset);
        }
      };

      loadViewPresets();
      renderViewPresetMenu();
      updateViewPresetControlsAvailability();

      const updatePageHeader = () => {
        if (!pageTitleEl || !pageSubtitleEl) {
          return;
        }
        pageSubtitleEl.classList.remove('text-muted', 'text-secondary');
        if (hasActiveRecord && (currentRecordSummary.fullName || currentRecordSummary.dni)) {
          const name = currentRecordSummary.fullName || defaultPageTitle;
          const subtitle = currentRecordSummary.dni || '';
          pageTitleEl.textContent = name;
          if (subtitle) {
            pageSubtitleEl.textContent = subtitle;
            pageSubtitleEl.classList.add('text-secondary');
          } else {
            pageSubtitleEl.textContent = defaultPageSubtitle;
            pageSubtitleEl.classList.add('text-secondary');
          }
          return;
        }
        pageTitleEl.textContent = defaultPageTitle;
        pageSubtitleEl.textContent = defaultPageSubtitle;
        pageSubtitleEl.classList.add('text-secondary');
      };

      syncViewSelect(currentViewMode);
      updateTableSearchVisibility();

      const copyToastEl = document.getElementById('clientesCopyToast');
      const copyToastBodyEl = copyToastEl ? copyToastEl.querySelector('.toast-body') : null;
      const copyToastInstance = copyToastEl && typeof bootstrap !== 'undefined'
        ? bootstrap.Toast.getOrCreateInstance(copyToastEl)
        : null;

      const copyTextToClipboard = async (text) => {
        const value = String(text ?? '');
        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          try {
            await navigator.clipboard.writeText(value);
            return true;
          } catch (error) {
            // Fallback to legacy approach below.
          }
        }

        const helper = document.createElement('textarea');
        helper.value = value;
        helper.setAttribute('readonly', '');
        helper.style.position = 'fixed';
        helper.style.opacity = '0';
        helper.style.pointerEvents = 'none';
        helper.style.zIndex = '-1';
        document.body.appendChild(helper);
        helper.select();
        helper.setSelectionRange(0, helper.value.length);
        let success = false;
        try {
          success = typeof document.execCommand === 'function' ? document.execCommand('copy') : false;
        } catch (error) {
          success = false;
        }
        document.body.removeChild(helper);
        return success;
      };

      const formatDetailLabel = (label) => {
        const raw = String(label ?? '').trim();
        if (!raw) {
          return '';
        }
        const spaced = raw
          .replace(/[_\-]+/g, ' ')
          .replace(/([a-z])([A-Z])/g, '$1 $2')
          .replace(/\s+/g, ' ')
          .trim();
        if (!spaced) {
          return '';
        }
        return spaced.charAt(0).toUpperCase() + spaced.slice(1);
      };

      const formatDetailValue = (value) => {
        if (value === null || value === undefined) {
          return '—';
        }
        if (Array.isArray(value)) {
          const parts = value
            .map((item) => formatDetailValue(item))
            .filter((part) => part !== null && part !== undefined && part !== '');
          if (!parts.length) {
            return '—';
          }
          if (parts.every((part) => part === '—')) {
            return '—';
          }
          return parts.join(', ');
        }
        if (typeof value === 'object') {
          try {
            return JSON.stringify(value);
          } catch (error) {
            return String(value);
          }
        }
        const text = String(value);
        return text.trim() === '' ? '—' : text;
      };

      const stringifyRecordValue = (value) => {
        if (value === null || value === undefined) {
          return '';
        }
        if (typeof value === 'object') {
          try {
            return JSON.stringify(value);
          } catch (error) {
            return String(value);
          }
        }
        return String(value);
      };

      const normalizeDetailFieldName = (name) => {
        const raw = String(name ?? '').trim();
        const withoutPrefix = raw.includes('::') ? raw.split('::').pop() : raw;
        const ascii = withoutPrefix.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        return ascii.replace(/[^a-z0-9]/gi, '').toLowerCase();
      };

      const isHiddenDetailField = (fieldName) => {
        if (!fieldName) return false;

        // Normalizar el nombre del campo para la comparación (eliminar espacios y a minúsculas)
        const normalizedFieldName = String(fieldName).toLowerCase().replace(/\s+/g, '');

        console.log('🔍 Verificando si ocultar campo:', fieldName, '→ normalizado:', normalizedFieldName);

        // Lista de campos exactos que queremos ocultar
        const exactHiddenFields = [
          'telefonobolt',           // Teléfono Bolt (sin completo)
          'prefijotelefonobolt',    // Prefijo Teléfono Bolt
          'prefijobolt',            // Prefijo Bolt
          'prefijotelefono',        // Prefijo Teléfono
          'id',                     // ID interno del conductor
          '__recordid',             // Record ID de FileMaker (con __)
          'recordid',               // Record ID de FileMaker
          'idinversorasignado'      // ID del inversor asignado
        ];

        // Verificar coincidencia exacta
        if (exactHiddenFields.includes(normalizedFieldName)) {
          console.log('  ❌ Campo OCULTO (coincidencia exacta)');
          return true;
        }

        // Si contiene "completo", NUNCA ocultar
        if (normalizedFieldName.includes('completo')) {
          console.log('  ✅ Campo VISIBLE (contiene "completo")');
          return false;
        }

        // Ocultar cualquier campo que contenga "prefijo"
        if (normalizedFieldName.includes('prefijo')) {
          console.log('  ❌ Campo OCULTO (contiene "prefijo")');
          return true;
        }

        console.log('  ✅ Campo VISIBLE (no coincide con reglas de ocultación)');
        return false;
      };

      const DETAIL_GROUPS = [
        {
          title: 'Datos básicos',
          icon: 'user',
          fields: [
            'nombre',
            'apellido1',
            'apellido2',
            'nombreCompleto',
            'fechaNacimiento',
            'edad',
            ['ndocumentoidentidad', 'nDocumentoIdentidad'],
            'tipoDocumentoIdentidad',
            'nacionalidad',
            'nivelFormativoTrabajador',
            'aniosCarnetConducir',
            'numeroPuntosDGT',
            'estado'
          ]
        },
        {
          title: 'Dirección',
          icon: 'home',
          fields: [
            'direccionConcatenada',
            'tipoVia',
            'nombreVia',
            'numero',
            'pisoYLetra',
            'cp',
            'codigoLocalidad',
            'localidad',
            'provincia',
            'paisNacimiento'
          ]
        },
        {
          title: 'Datos de contacto',
          icon: 'phone',
          fields: [
            'telefono1',
            'telefono2',
            'telefonoBoltCompleto',
            'correoPersonal',
            'correoPlataforma'
          ]
        },
        {
          title: 'Datos laborales y contractuales',
          icon: 'briefcase',
          fields: [
            'codigoContrato',
            'tipoContrato',
            'fechaContrato',
            'fechaFirma',
            'fechaAltaSS',
            'nAfiliacionSS',
            'altaEnGestion'
          ]
        },
        {
          title: 'Datos del vehículo',
          icon: 'car',
          fields: [
            'matriculaVehiculoAsignado',
            'fechaAsignacionVehiculo'
          ]
        },
        {
          title: 'Datos de tarjeta de combustible',
          icon: 'fuel',
          fields: [
            ['numeroTarjetaCombustible', 'nTarjetaCombustible', 'ntarjetaCombustible'],
            'estadoTarjetaCombustible',
            'contraseniaTarjetaCombustible',
            'fechaAsignacionTarjetaCombustible'
          ]
        },
        {
          title: 'Datos de tarjeta de efectivo',
          icon: 'credit-card',
          fields: [
            ['numeroTarjetaEfectivo', 'nTarjetaEfectivo', 'ntarjetaEfectivo'],
            'estadoTarjetaEfectivo',
            'fechaAsignacionTarjetaEfectivo'
          ]
        },
        {
          title: 'Datos de inversor',
          icon: 'users',
          fields: [
            'nombreInversor'
          ]
        },
        {
          title: 'Datos bancarios',
          icon: 'banknote',
          fields: [
            'iban',
            'ibanEntidad',
            'ibanOficina',
            'ibanDC',
            'ibanNumeroCuenta'
          ]
        },
        {
          title: 'Documentación',
          icon: 'file-text',
          fields: [
            'fechaExpedicionCarnetConducir',
            'fechaCaducidadCarnetConducir',
            'fechaExpedicionCartillaVTC',
            'fechaRenovacionCartillaVTC',
            'fechaExpedicionDelitosSexuales',
            'fechaRenovacionDelitosSexuales',
            'fechaExpedicionVidaLaboral',
            'fechaCaducidadDocumento'
          ]
        },
        {
          title: 'Control interno y sistema',
          icon: 'settings',
          fields: [
            'creadoEl',
            'creadoPor',
            'modificadoEl',
            'modificadoPor'
          ]
        }
      ];

      const flattenRecordFieldsForDetail = (record) => {
        const aggregated = {};
        const ensureKey = (key) => {
          if (!aggregated[key]) {
            aggregated[key] = [];
          }
          return aggregated[key];
        };
        const appendValue = (key, rawValue, prefix = '') => {
          const bucket = ensureKey(key);
          const value = stringifyRecordValue(rawValue);
          const trimmedPrefix = prefix.trim();
          if (trimmedPrefix && value) {
            bucket.push(`${trimmedPrefix} ${value}`.trim());
          } else if (trimmedPrefix && !value) {
            bucket.push(trimmedPrefix);
          } else {
            bucket.push(value);
          }
        };

        const fieldData = record?.fieldData ?? {};
        console.log('🔍 [renderDetail] Total campos en fieldData:', Object.keys(fieldData).length);
        console.log('🔍 [renderDetail] Campos:', Object.keys(fieldData));

        Object.entries(fieldData).forEach(([fieldName, value]) => {
          const shouldHide = isHiddenDetailField(fieldName);
          console.log(`🔍 [renderDetail] Campo "${fieldName}": shouldHide=${shouldHide}`);

          if (shouldHide) {
            console.log(`  ⏭️ Saltando campo "${fieldName}" (oculto)`);
            return;
          }
          appendValue(fieldName, value);
        });

        const portalData = record?.portalData ?? {};
        Object.entries(portalData).forEach(([portalName, rows]) => {
          if (!Array.isArray(rows)) {
            return;
          }
          const multipleRows = rows.length > 1;
          rows.forEach((portalRow, index) => {
            const rowFieldData = portalRow?.fieldData ?? {};
            const rowPrefix = multipleRows ? `[${index + 1}]` : '';
            Object.entries(rowFieldData).forEach(([fieldName, value]) => {
              const combinedName = `${portalName}::${fieldName}`;
              if (isHiddenDetailField(combinedName)) {
                return;
              }
              appendValue(combinedName, value, rowPrefix);
            });
          });
        });

        if (record?.recordId !== undefined && record?.recordId !== null && record?.recordId !== '') {
          appendValue('__recordId', record.recordId);
        }

        return aggregated;
      };

      const renderDetail = (record, order = []) => {
        if (!detailForm || !detailGrid || !detailEmpty || !detailTabsWrapper) {
          return;
        }

        if (detailCategoryNav) {
          detailCategoryNav.innerHTML = '';
        }
        detailNavItems = [];
        if (detailSectionObserver) {
          detailSectionObserver.disconnect();
          detailSectionObserver = null;
        }
        syncDetailCategoryNavVisibility(currentViewMode);
        detailSearchIndex = [];
        if (detailSearchInput) {
          detailSearchInput.value = '';
        }
        if (detailSearchWrapper) {
          detailSearchWrapper.classList.add('d-none');
          detailSearchWrapper.setAttribute('aria-hidden', 'true');
          if (detailSearchInput) {
            detailSearchInput.disabled = true;
          }
        }

        const createFieldControl = (label, rawValue, options = {}) => {
          const displayLabel = formatDetailLabel(label) || label || 'Campo';
          const displayValueRaw = formatDetailValue(rawValue);
          const isMeaningful =
            typeof displayValueRaw === 'string'
              ? displayValueRaw.trim().length > 0 && displayValueRaw.trim() !== '—'
              : displayValueRaw !== '—';
          const displayValue = isMeaningful ? displayValueRaw : '';
          const item = document.createElement('div');
          item.className = 'detail-grid-item';
          const normalizedLabel = normalizeDetailFieldName(displayLabel);
          item.dataset.detailFieldLabel = displayLabel;
          item.dataset.detailFieldNormalized = normalizedLabel;
          if (options.fieldName) {
            item.dataset.detailFieldName = options.fieldName;
          }
          if (options.sectionId) {
            item.dataset.detailSection = options.sectionId;
          }

          const labelEl = document.createElement('label');
          labelEl.className = 'form-label text-secondary fw-semibold text-uppercase small mb-0';
          labelEl.textContent = displayLabel;
          item.appendChild(labelEl);

          const requiresTextarea = displayValue !== '—' && (displayValue.length > 120 || displayValue.includes('\n'));
          if (requiresTextarea) {
            const textarea = document.createElement('textarea');
            textarea.className = 'form-control';
            textarea.readOnly = true;
            textarea.setAttribute('aria-readonly', 'true');
            textarea.value = displayValue;
            textarea.rows = Math.min(6, Math.max(3, Math.ceil(displayValue.length / 60)));
            textarea.style.resize = 'none';
            item.appendChild(textarea);
          } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.readOnly = true;
            input.setAttribute('aria-readonly', 'true');
            input.value = displayValue;
            item.appendChild(input);
          }

          return item;
        };

        const createGroupCard = (title, iconName) => {
          const card = document.createElement('div');
          card.className = 'detail-card card shadow-sm';
          if (title) {
            const header = document.createElement('div');
            header.className = 'card-header bg-transparent border-0 pb-0';
            if (iconName) {
              const iconWrapper = document.createElement('span');
              iconWrapper.className = 'detail-card-icon';
              iconWrapper.innerHTML = `<i data-lucide=\"${iconName}\"></i>`;
              header.appendChild(iconWrapper);
            }
            const titleEl = document.createElement('h3');
            titleEl.className = 'card-title h6 mb-0';
            titleEl.textContent = title;
            header.appendChild(titleEl);
            card.appendChild(header);
          }
          const body = document.createElement('div');
          body.className = 'card-body';
          const grid = document.createElement('div');
          grid.className = 'detail-group-grid';
          body.appendChild(grid);
          card.appendChild(body);
          return { card, grid };
        };

        const sectionIds = new Set();
        const detailSections = [];
        const createSectionId = (title) => {
          const normalizedTitle = normalizeDetailFieldName(title);
          const base = (normalizedTitle && normalizedTitle.length ? normalizedTitle : `seccion${sectionIds.size + 1}`).replace(/-+/g, '');
          let candidate = `detail-section-${base}`;
          let suffix = 1;
          while (sectionIds.has(candidate)) {
            suffix += 1;
            candidate = `detail-section-${base}-${suffix}`;
          }
          sectionIds.add(candidate);
          return candidate;
        };

        const appendGroupCard = (title, items, context, iconName) => {
          if (!items.length) {
            return;
          }
          const { card, grid } = createGroupCard(title, iconName);
          const controls = [];
          items.forEach((item, index) => {
            const rawValue = item.fieldName ? context.fields[item.fieldName] ?? null : null;
            const controlLabel = item.label ?? item.fieldName ?? 'Campo';
            const control = createFieldControl(controlLabel, rawValue, {
              fieldName: item.fieldName
            });
            grid.appendChild(control);
            controls.push({ control, controlLabel, fieldName: item.fieldName, index });
            if (item.fieldName) {
              context.seen.add(item.fieldName);
            }
          });
          if (controls.length) {
            const sectionTitle = title || 'Sección';
            const sectionId = createSectionId(sectionTitle);
            card.id = sectionId;
            card.setAttribute('data-detail-section', sectionId);
            controls.forEach(({ control, controlLabel, index }) => {
              control.dataset.detailSection = sectionId;
              const normalizedLabel = control.dataset.detailFieldNormalized || normalizeDetailFieldName(controlLabel);
              const fieldSlug = normalizedLabel || `campo${index + 1}`;
              const controlId = `${sectionId}-${fieldSlug}-${index}`;
              control.id = controlId;
              detailSearchIndex.push({
                element: control,
                label: controlLabel,
                normalizedLabel,
                sectionId,
                controlId
              });
            });
            const order = detailSections.length;
            detailSections.push({
              id: sectionId,
              title: sectionTitle,
              icon: iconName || null,
              order
            });
            detailGrid.appendChild(card);
          }
        };

        const appendConfiguredGroup = (group, context) => {
          const items = [];
          const canonicalSeen = new Set();
          group.fields.forEach((entry) => {
            const aliases = Array.isArray(entry) ? entry : [entry];
            if (!aliases.length) {
              return;
            }
            const canonicalAlias = aliases[0];
            const canonicalNormalized = normalizeDetailFieldName(canonicalAlias);
            if (canonicalSeen.has(canonicalNormalized)) {
              return;
            }
            canonicalSeen.add(canonicalNormalized);

            let actualFieldName = null;
            for (const alias of aliases) {
              const normalized = normalizeDetailFieldName(alias);
              const candidates = context.normalizedToActual.get(normalized);
              if (!candidates) {
                continue;
              }
              const candidate = candidates.find((name) => !context.seen.has(name));
              if (candidate) {
                actualFieldName = candidate;
                break;
              }
            }

            items.push({
              fieldName: actualFieldName,
              label: canonicalAlias
            });
          });
          if (items.length) {
            appendGroupCard(group.title, items, context, group.icon);
          }
        };

        if (!record) {
          hasActiveRecord = false;
          setCurrentRecordSummary(null);
          setDetailOptionEnabled(false);
          if (currentViewMode === 'detail') {
            setViewMode('split-vertical', { force: true });
          }
          detailGrid.innerHTML = '';
          detailForm.classList.add('d-none');
          detailTabsWrapper.classList.add('d-none');
          detailEmpty.classList.remove('d-none');
          const scrollContainer = getDetailScrollContainer();
          if (scrollContainer) {
            scrollContainer.scrollTop = 0;
          }
          updatePageHeader();
          updateDetailGridColumns();
          updateTableSearchVisibility();
          return;
        }

        hasActiveRecord = true;
        setCurrentRecordSummary(record);
        setDetailOptionEnabled(true);
        updatePageHeader();
        const flattenedFields = flattenRecordFieldsForDetail(record);
        const flattenedFieldNames = Object.keys(flattenedFields);

        detailGrid.innerHTML = '';

        const normalizedToActual = new Map();
        flattenedFieldNames.forEach((fieldName) => {
          const normalized = normalizeDetailFieldName(fieldName);
          if (!normalizedToActual.has(normalized)) {
            normalizedToActual.set(normalized, []);
          }
          normalizedToActual.get(normalized).push(fieldName);
        });

        const context = {
          fields: flattenedFields,
          normalizedToActual,
          seen: new Set()
        };

        DETAIL_GROUPS.forEach((group) => appendConfiguredGroup(group, context));

        const normalizedOrder = Array.isArray(order)
          ? order.map((name) => normalizeDetailFieldName(name))
          : [];
        const leftover = [];

        normalizedOrder.forEach((normalizedName) => {
          const candidates = normalizedToActual.get(normalizedName);
          if (!candidates) {
            return;
          }
          candidates.forEach((candidate) => {
            if (!context.seen.has(candidate) && !leftover.includes(candidate)) {
              leftover.push(candidate);
            }
          });
        });

        flattenedFieldNames.forEach((fieldName) => {
          if (!context.seen.has(fieldName) && !leftover.includes(fieldName)) {
            leftover.push(fieldName);
          }
        });

        if (leftover.length) {
          const leftoverItems = leftover.map((name) => ({
            fieldName: name,
            label: name
          }));
          appendGroupCard('Otros datos', leftoverItems, context, 'info');
        }

        if (detailCategoryNav) {
          detailCategoryNav.innerHTML = '';
          if (detailSections.length) {
            const fragment = document.createDocumentFragment();
            const heading = document.createElement('div');
            heading.className = 'detail-category-nav-heading text-secondary text-uppercase small fw-semibold';
            heading.textContent = 'Categorías';
            fragment.appendChild(heading);

            const list = document.createElement('ul');
            list.className = 'detail-category-nav-list';
            const navItems = [];

            detailSections.forEach((section) => {
              const item = document.createElement('li');
              const button = document.createElement('button');
              button.type = 'button';
              button.className = 'detail-category-nav-button';
              button.setAttribute('data-detail-nav-target', section.id);
              button.setAttribute('aria-current', 'false');

              if (section.icon) {
                const iconSpan = document.createElement('span');
                iconSpan.className = 'detail-category-nav-icon';
                iconSpan.innerHTML = `<i data-lucide="${section.icon}"></i>`;
                button.appendChild(iconSpan);
              }

              const labelSpan = document.createElement('span');
              labelSpan.className = 'detail-category-nav-label';
              labelSpan.textContent = section.title;
              button.appendChild(labelSpan);

              item.appendChild(button);
              list.appendChild(item);
              navItems.push({ button, id: section.id, order: section.order });
            });

            fragment.appendChild(list);
            detailCategoryNav.appendChild(fragment);
            detailNavItems = navItems;
            syncDetailCategoryNavVisibility(currentViewMode);
            if (detailSections.length) {
              setActiveDetailNavItem(detailSections[0].id);
            }
            if (detailSectionObserver) {
              detailSectionObserver.disconnect();
            }

            const scrollContainer = getDetailScrollContainer();
            if (typeof IntersectionObserver === 'function' && scrollContainer) {
              const orderLookup = new Map(detailSections.map((section) => [section.id, section.order]));
              detailSectionObserver = new IntersectionObserver(
                (entries) => {
                  const intersecting = entries
                    .filter((entry) => entry.isIntersecting)
                    .sort(
                      (a, b) => (orderLookup.get(a.target.id) ?? 0) - (orderLookup.get(b.target.id) ?? 0)
                    );

                  if (intersecting.length > 0) {
                    const activeId = intersecting[0].target.id;
                    setActiveDetailNavItem(activeId);
                    return;
                  }

                  const scrollTop = scrollContainer.scrollTop;
                  let fallbackId = null;
                  for (const section of detailSections) {
                    const element = scrollContainer.querySelector(`#${section.id}`);
                    if (!element) {
                      continue;
                    }
                    const elementTop = element.offsetTop;
                    if (elementTop - 24 <= scrollTop) {
                      fallbackId = section.id;
                      continue;
                    }
                    if (fallbackId === null) {
                      fallbackId = section.id;
                    }
                    break;
                  }
                  if (fallbackId) {
                    setActiveDetailNavItem(fallbackId);
                  }
                },
                {
                  root: scrollContainer,
                  threshold: 0.35,
                  rootMargin: '-10% 0px -45% 0px'
                }
              );

              detailSections.forEach(({ id }) => {
                const element = scrollContainer.querySelector(`#${id}`);
                if (element) {
                  detailSectionObserver.observe(element);
                }
              });
            }

            if (scrollContainer) {
              if (detailSections.length) {
                scrollToDetailSection(detailSections[0].id, { behavior: 'auto' });
              } else {
                scrollContainer.scrollTop = 0;
              }
            }
          } else {
            detailNavItems = [];
            syncDetailCategoryNavVisibility(currentViewMode);
          }
        }

        if (!detailGrid.children.length) {
          const placeholderCard = document.createElement('div');
          placeholderCard.className = 'detail-card card shadow-sm';
          const placeholderBody = document.createElement('div');
          placeholderBody.className = 'card-body text-secondary';
          placeholderBody.textContent = 'No hay datos disponibles.';
          placeholderCard.appendChild(placeholderBody);
          detailGrid.appendChild(placeholderCard);
        }

        detailEmpty.classList.add('d-none');
        detailTabsWrapper.classList.remove('d-none');
        detailForm.classList.remove('d-none');
        if (detailSearchWrapper) {
          const hasSearchableFields = detailSearchIndex.length > 0;
          detailSearchWrapper.classList.toggle('d-none', !hasSearchableFields);
          detailSearchWrapper.setAttribute('aria-hidden', hasSearchableFields ? 'false' : 'true');
          if (detailSearchInput) {
            detailSearchInput.disabled = !hasSearchableFields;
          }
        }
        const resetScrollContainer = getDetailScrollContainer();
        if (resetScrollContainer) {
          resetScrollContainer.scrollTop = 0;
          if (detailSections.length) {
            scrollToDetailSection(detailSections[0].id, { behavior: 'auto' });
          }
        }
        updatePageHeader();
        updateDetailGridColumns();
        window.lucide?.createIcons?.();
      };

      if (detailForm) {
        detailForm.addEventListener('dblclick', async (event) => {
          const target = event.target;
          const isInput = target instanceof HTMLInputElement;
          const isTextarea = target instanceof HTMLTextAreaElement;
          if (!isInput && !isTextarea) {
            return;
          }
          const isReadOnly = target.hasAttribute('readonly') || target.getAttribute('aria-readonly') === 'true';
          if (!isReadOnly) {
            return;
          }
          const rawValue = typeof target.value === 'string' ? target.value : '';
          const success = await copyTextToClipboard(rawValue);
          if (success) {
            if (copyToastBodyEl) {
              const normalizedValue = rawValue.trim().replace(/\s+/g, ' ');
              const preview = normalizedValue.length > 64 ? `${normalizedValue.slice(0, 64)}…` : normalizedValue;
              copyToastBodyEl.textContent = preview
                ? `Copiado al portapapeles: ${preview}`
                : 'Valor vacío copiado al portapapeles.';
            }
            if (copyToastInstance) {
              copyToastInstance.show();
            }
          } else {
            console.warn('No se pudo copiar el texto al portapapeles.');
          }
        });
      }

      const minSecondarySize = 0;
      const collapseThreshold = 32;
      const keyboardStep = 32;
      const mobileQuery = window.matchMedia('(max-width: 991.98px)');

      const supportsPointerEvents = 'PointerEvent' in window;
      let isResizing = false;
      let pointerId = null;
      let activeResizeMode = null;
      let startCoordinate = 0;
      let startPrimarySize = 0;
      let resizeRAF = null;
      let lastAppliedPrimarySize = null;

      const getClientCoordinate = (event) => {
        const axis = isVerticalSplitMode() ? 'X' : 'Y';
        if (event.touches && event.touches.length > 0) {
          return event.touches[0][`client${axis}`];
        }
        if (event.changedTouches && event.changedTouches.length > 0) {
          return event.changedTouches[0][`client${axis}`];
        }
        if (typeof event[`client${axis}`] === 'number') {
          return event[`client${axis}`];
        }
        return null;
      };

      const getComputedMinSize = (element) => {
        const styles = window.getComputedStyle(element);
        const property = isVerticalSplitMode() ? 'minWidth' : 'minHeight';
        const parsed = parseFloat(styles[property]);
        return Number.isFinite(parsed) ? parsed : 0;
      };

      const getPanelCurrentSize = (panel) => {
        const rect = panel.getBoundingClientRect();
        return isVerticalSplitMode() ? rect.width : rect.height;
      };

      const getBounds = () => {
        const rect = wrapper.getBoundingClientRect();
        const axisSize = isVerticalSplitMode() ? rect.width : rect.height;
        if (!axisSize) {
          return null;
        }
        const minPrimary = Math.max(getComputedMinSize(topPanel), isVerticalSplitMode() ? 200 : 160);
        const minSecondary = Math.max(getComputedMinSize(bottomPanel), minSecondarySize);
        const maxPrimary = Math.max(axisSize - minSecondary, minPrimary);
        return {
          axisSize,
          minPrimary,
          minSecondary,
          maxPrimary
        };
      };

      const computeLayout = (desiredPrimarySize) => {
        const bounds = getBounds();
        if (!bounds) {
          return null;
        }

        const primary = Math.min(Math.max(desiredPrimarySize, bounds.minPrimary), bounds.maxPrimary);
        const secondary = Math.max(bounds.axisSize - primary, bounds.minSecondary);
        return {
          primary,
          secondary
        };
      };

      const applySizes = (desiredPrimarySize) => {
        if (mobileQuery.matches || !isResizableMode()) {
          return;
        }
        const layout = computeLayout(desiredPrimarySize);
        if (!layout) {
          return;
        }

        lastAppliedPrimarySize = layout.primary;
        const primaryValue = `${layout.primary}px`;
        const secondaryValue = `${layout.secondary}px`;

        topPanel.style.flexBasis = primaryValue;
        bottomPanel.style.flexBasis = secondaryValue;

        if (isVerticalSplitMode()) {
          topPanel.style.width = primaryValue;
          bottomPanel.style.width = secondaryValue;
          topPanel.style.height = '';
          bottomPanel.style.height = '';
        } else {
          topPanel.style.height = primaryValue;
          bottomPanel.style.height = secondaryValue;
          topPanel.style.width = '';
          bottomPanel.style.width = '';
        }

        const isCollapsed = layout.secondary <= collapseThreshold;
        bottomPanel.classList.toggle('is-collapsed', isCollapsed);
        handle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
        updateDetailGridColumns();
      };

      const scheduleApplySizes = (size) => {
        if (!isResizableMode()) {
          return;
        }
        cancelAnimationFrame(resizeRAF);
        resizeRAF = requestAnimationFrame(() => applySizes(size));
      };

      const stopResizing = () => {
        if (!isResizing) {
          return;
        }
        isResizing = false;
        if (activeResizeMode === 'pointer' && pointerId !== null && typeof handle.releasePointerCapture === 'function') {
          handle.releasePointerCapture(pointerId);
        }
        pointerId = null;
        activeResizeMode = null;
        document.body.classList.remove('user-select-none');
        cancelAnimationFrame(resizeRAF);
        resizeRAF = null;
        if (lastAppliedPrimarySize !== null && isResizableMode()) {
          applySizes(lastAppliedPrimarySize);
        }
      };

      const onDragMove = (event) => {
        if (!isResizing) {
          return;
        }
        const coordinate = getClientCoordinate(event);
        if (coordinate === null) {
          return;
        }
        scheduleApplySizes(startPrimarySize + (coordinate - startCoordinate));
        if (activeResizeMode === 'touch') {
          event.preventDefault();
        }
      };

      const startResizing = (event, mode) => {
        if (mobileQuery.matches || !isResizableMode()) {
          return;
        }
        if ((mode === 'pointer' || mode === 'mouse') && typeof event.button === 'number' && event.button !== 0) {
          return;
        }
        const coordinate = getClientCoordinate(event);
        if (coordinate === null) {
          return;
        }
        activeResizeMode = mode;
        isResizing = true;
        pointerId = mode === 'pointer' ? event.pointerId ?? null : null;
        startCoordinate = coordinate;
        const currentSize = getPanelCurrentSize(topPanel);
        const layout = computeLayout(currentSize || lastAppliedPrimarySize || ((getBounds()?.axisSize ?? 0) * 0.55));
        startPrimarySize = layout?.primary ?? 0;
        if (mode === 'pointer' && pointerId !== null && typeof handle.setPointerCapture === 'function') {
          handle.setPointerCapture(pointerId);
        }
        document.body.classList.add('user-select-none');
        event.preventDefault();
      };

      const snapToMinimum = () => {
        if (!isResizableMode()) {
          return;
        }
        const bounds = getBounds();
        if (!bounds) {
          return;
        }
        scheduleApplySizes(bounds.minPrimary);
      };

      const snapToMaximum = () => {
        if (!isResizableMode()) {
          return;
        }
        const bounds = getBounds();
        if (!bounds) {
          return;
        }
        scheduleApplySizes(bounds.maxPrimary);
      };

      const adjustPrimarySizeByPixels = (delta) => {
        if (mobileQuery.matches || !isResizableMode()) {
          return;
        }
        const currentSize = getPanelCurrentSize(topPanel) || lastAppliedPrimarySize;
        const fallback = getBounds()?.minPrimary ?? 0;
        scheduleApplySizes((currentSize ?? fallback) + delta);
      };

      const resetPanelSizes = () => {
        topPanel.style.flexBasis = '';
        bottomPanel.style.flexBasis = '';
        topPanel.style.width = '';
        topPanel.style.height = '';
        bottomPanel.style.width = '';
        bottomPanel.style.height = '';
      };

      const handleLayoutChange = () => {
        cancelAnimationFrame(resizeRAF);
        resizeRAF = null;

        if (mobileQuery.matches || !isResizableMode()) {
          stopResizing();
          resetPanelSizes();
          bottomPanel.classList.remove('is-collapsed');
          handle.setAttribute('aria-expanded', 'true');
          lastAppliedPrimarySize = null;
          updateDetailGridColumns();
          pendingHandleRestore = null;
          return;
        }

        const currentSize = getPanelCurrentSize(topPanel) || lastAppliedPrimarySize;
        const bounds = getBounds();
        const fallbackSize = bounds
          ? Math.min(Math.max(bounds.axisSize * 0.55, bounds.minPrimary), bounds.maxPrimary)
          : null;
        const desired = currentSize ?? fallbackSize;
        if (desired !== null) {
          applySizes(desired);
        } else {
          updateDetailGridColumns();
        }
        applyPendingHandleRestore();
      };

      function applyViewModeLayout(mode) {
        const targetMode = allowedViewModes.includes(mode) ? mode : 'split-vertical';

        if (isResizableMode(targetMode)) {
          wrapper.classList.remove('view-detail-only', 'view-list-only');
          wrapper.classList.toggle('view-split-vertical', isVerticalSplitMode(targetMode));
          topPanel.classList.remove('d-none');
          bottomPanel.classList.remove('d-none');
          handle.classList.remove('d-none');
          handle.setAttribute('aria-orientation', isVerticalSplitMode(targetMode) ? 'vertical' : 'horizontal');
          if (columnsWrapper) {
            columnsWrapper.classList.remove('d-none');
          }
          handleLayoutChange();
          updateDetailGridColumns();
          updateTableSearchVisibility();
          updatePageHeader();
          syncDetailCategoryNavVisibility(targetMode);
          return;
        }

        stopResizing();
        cancelAnimationFrame(resizeRAF);
        resizeRAF = null;
        resetPanelSizes();
        bottomPanel.classList.remove('is-collapsed');
        lastAppliedPrimarySize = null;
        handle.setAttribute('aria-expanded', 'true');
        wrapper.classList.remove('view-split-vertical');

        if (targetMode === 'detail') {
          topPanel.classList.add('d-none');
          bottomPanel.classList.remove('d-none');
          handle.classList.add('d-none');
          handle.setAttribute('aria-orientation', 'horizontal');
          wrapper.classList.add('view-detail-only');
          wrapper.classList.remove('view-list-only');
          if (columnsWrapper) {
            columnsWrapper.classList.add('d-none');
          }
        } else {
          topPanel.classList.remove('d-none');
          bottomPanel.classList.add('d-none');
          handle.classList.add('d-none');
          handle.setAttribute('aria-orientation', 'horizontal');
          wrapper.classList.add('view-list-only');
          wrapper.classList.remove('view-detail-only');
          if (columnsWrapper) {
            columnsWrapper.classList.remove('d-none');
          }
        }

        updateTableSearchVisibility();
        updateDetailGridColumns();
        updatePageHeader();
        syncDetailCategoryNavVisibility(targetMode);
      }

      function setViewMode(mode, { force = false } = {}) {
        if (!allowedViewModes.includes(mode)) {
          mode = 'split-vertical';
        }
        if (mode === 'detail' && !hasActiveRecord) {
          mode = isResizableMode(currentViewMode) ? currentViewMode : 'split-vertical';
        }
        const changed = currentViewMode !== mode;
        if (!changed && !force) {
          syncViewSelect(currentViewMode);
          updateTableSearchVisibility();
          return;
        }
        currentViewMode = mode;
        syncViewSelect(currentViewMode);
        applyViewModeLayout(currentViewMode);
      }

      if (viewSelect) {
        viewSelect.addEventListener('change', () => {
          setViewMode(viewSelect.value);
        });
      }

      if (viewPresetAddButton) {
        viewPresetAddButton.addEventListener('click', () => handleViewPresetAdd());
      }

      if (viewPresetList) {
        viewPresetList.addEventListener('click', handleViewPresetSelection);
      }

      setViewMode(currentViewMode, { force: true });

      if (supportsPointerEvents) {
        handle.addEventListener('pointerdown', (event) => startResizing(event, 'pointer'));
        document.addEventListener('pointermove', onDragMove);
        document.addEventListener('pointerup', stopResizing);
        document.addEventListener('pointercancel', stopResizing);
      } else {
        handle.addEventListener('mousedown', (event) => startResizing(event, 'mouse'));
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', stopResizing);
        handle.addEventListener('touchstart', (event) => startResizing(event, 'touch'), { passive: false });
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', stopResizing);
        document.addEventListener('touchcancel', stopResizing);
      }

      handle.addEventListener('keydown', (event) => {
        const isVertical = isVerticalSplitMode();
        if ((event.key === 'ArrowUp' && !isVertical) || (event.key === 'ArrowLeft' && isVertical)) {
          event.preventDefault();
          adjustPrimarySizeByPixels(-keyboardStep);
        } else if ((event.key === 'ArrowDown' && !isVertical) || (event.key === 'ArrowRight' && isVertical)) {
          event.preventDefault();
          adjustPrimarySizeByPixels(keyboardStep);
        } else if (event.key === 'Home') {
          event.preventDefault();
          snapToMinimum();
        } else if (event.key === 'End') {
          event.preventDefault();
          snapToMaximum();
        }
      });

      document.addEventListener('clientesTable:select', (event) => {
        const detail = event.detail ?? {};
        const record = detail.record ?? null;
        renderDetail(record, detail.fieldOrder ?? []);
        updateProcessActionsName(detail.displayName ?? null, record);
      });

      document.addEventListener('clientesTable:ready', () => {
        isTableReady = true;
        updateViewPresetControlsAvailability();
        if (pendingTablePreset) {
          const presetToApply = pendingTablePreset;
          pendingTablePreset = null;
          applyTablePresetState(presetToApply);
          requestAnimationFrame(() => applyPendingHandleRestore());
        }
      });

      document.addEventListener('clientesTable:destroy', () => {
        isTableReady = false;
        updateViewPresetControlsAvailability();
        updateProcessActionsName(null, null);
        updatePageHeaderFromRecord(null);
      });

      const applyInitialProcessSelection = () => {
        // Si hay un conductorId en la URL, no renderizar el caché
        // porque loadConductorData() se encargará de renderizar los datos frescos
        const urlParams = new URLSearchParams(window.location.search);
        const conductorId = urlParams.get('conductorId');

        if (conductorId) {
          console.log('🔄 Saltando renderizado de caché porque hay conductorId en la URL');
          renderDetail(null, []);
          return;
        }

        const selectionLoader = window.ClientesProcessSelection?.load;
        let selection = typeof selectionLoader === 'function' ? selectionLoader() : null;
        if (!selection || typeof selection !== 'object' || !selection.record) {
          selection = loadProcessSelectionFromStorage();
        }
        if (selection && typeof selection === 'object' && selection.record) {
          const order = Array.isArray(selection.fieldOrder) ? selection.fieldOrder : [];
          updateProcessActionsName(selection.displayName ?? null, selection.record);
          renderDetail(selection.record, order);
          return;
        }
        renderDetail(null, []);
        updateProcessActionsName(null, null);
      };

      applyInitialProcessSelection();
      mobileQuery.addEventListener('change', handleLayoutChange);
      if (detailNavBreakpoint) {
        detailNavBreakpoint.addEventListener('change', () => syncDetailCategoryNavVisibility(currentViewMode));
      }
      window.addEventListener('resize', handleLayoutChange);

      handleLayoutChange();

      // Cargar datos del conductor si hay conductorId en la URL
      const loadConductorData = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const conductorId = urlParams.get('conductorId');
        const procesoId = urlParams.get('procesoId');

        // Guardar el procesoId si existe
        if (procesoId) {
          currentProcesoId = procesoId;
          console.log('ID del proceso actual:', currentProcesoId);
        }

        if (!conductorId) {
          console.log('No se proporcionó conductorId en la URL');
          return;
        }

        try {
          console.log('Cargando datos del conductor con ID:', conductorId);

          // Obtener datos del conductor desde FileMaker
          const layout = 'conductor.pdbconductor';
          const response = await window.ApiClient.get(`layouts/${window.ApiClient.encodePathSegment(layout)}/records/${conductorId}`);

          if (!response.ok) {
            throw new Error(`Error al cargar conductor: ${response.status}`);
          }

          const data = await response.json();
          const record = data?.response?.data?.[0];
          const conductorData = record?.fieldData;

          if (!conductorData) {
            console.error('No se encontraron datos del conductor');
            return;
          }

          console.log('Datos del conductor cargados:', conductorData);

          // Guardar el UUID del conductor actual
          if (conductorData.id) {
            currentConductorId = conductorData.id;
            console.log('UUID del conductor guardado:', currentConductorId);
          }

          // Guardar el recordId de FileMaker
          if (record?.recordId) {
            currentConductorRecordId = record.recordId;
            console.log('RecordId de FileMaker guardado:', currentConductorRecordId);
          }

          // Actualizar el título del encabezado
          updatePageTitle(conductorData);

          // Rellenar el formulario con los datos
          fillConductorForm(conductorData);

          // Renderizar el panel de detalle (derecho) con los datos del conductor
          if (typeof renderDetail === 'function' && record) {
            console.log('🔄 Renderizando panel de detalle con datos del conductor');
            renderDetail(record);

            // Reiniciar iconos de Lucide
            setTimeout(() => {
              if (typeof lucide !== 'undefined') {
                lucide.createIcons();
              }
            }, 100);
          }

          // Cargar el histórico filtrado por conductor y proceso
          if (currentConductorId) {
            console.log('🔍 Cargando histórico con filtros:');
            console.log('  - idEntidad (conductor):', currentConductorId);
            console.log('  - idProceso:', currentProcesoId || 'Sin filtro');
            await initProcesoLogTable(null, currentConductorId, currentProcesoId);
          }

        } catch (error) {
          console.error('Error al cargar datos del conductor:', error);
        }
      };

      // Función para convertir fechas a formato MM/DD/YYYY para FileMaker
      const convertDateForFileMaker = (dateString) => {
        if (!dateString || typeof dateString !== 'string') {
          console.log(`  ⏩ Fecha vacía o no es string, devolviendo sin cambios:`, dateString);
          return dateString;
        }

        console.log(`  🔍 Analizando fecha: "${dateString}"`);

        // Detectar si es formato YYYY-MM-DD (año-mes-día) - típico de input type="date"
        const yyyymmddPattern = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
        const yyyymmddMatch = dateString.match(yyyymmddPattern);

        if (yyyymmddMatch) {
          const [, year, month, day] = yyyymmddMatch;
          // Convertir a MM/DD/YYYY
          const converted = `${month}/${day}/${year}`;
          console.log(`  🔄 Fecha convertida YYYY-MM-DD → MM/DD/YYYY: "${dateString}" → "${converted}"`);
          return converted;
        }

        // Detectar si tiene formato con barras X/Y/ZZZZ
        const slashPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
        const slashMatch = dateString.match(slashPattern);

        if (slashMatch) {
          const [, first, second, year] = slashMatch;

          // Determinar si es DD/MM/YYYY o MM/DD/YYYY
          // Si el primer número es > 12, entonces es DD/MM/YYYY (día en primera posición)
          // Si el segundo número es > 12, entonces es MM/DD/YYYY (día en segunda posición)
          const firstNum = parseInt(first, 10);
          const secondNum = parseInt(second, 10);

          if (firstNum > 12) {
            // Es DD/MM/YYYY porque el día está en primera posición
            const converted = `${second}/${first}/${year}`;
            console.log(`  🔄 Fecha convertida DD/MM/YYYY → MM/DD/YYYY: "${dateString}" → "${converted}"`);
            return converted;
          } else if (secondNum > 12) {
            // Ya es MM/DD/YYYY (día > 12 en segunda posición)
            console.log(`  ✅ Fecha ya está en formato MM/DD/YYYY: "${dateString}"`);
            return dateString;
          } else {
            // Ambiguo: ambos números son <= 12
            // Asumir que ya está en formato MM/DD/YYYY (formato de FileMaker)
            console.log(`  ⚠️ Fecha ambigua, asumiendo formato MM/DD/YYYY: "${dateString}"`);
            return dateString;
          }
        }

        // Si no coincide con ningún patrón, devolver sin cambios
        console.log(`  ⚠️ Fecha NO coincide con patrones conocidos, devolviendo sin cambios: "${dateString}"`);
        return dateString;
      };

      // Función para preparar datos del formulario para FileMaker
      const prepareDataForFileMaker = (formData) => {
        const prepared = {};
        const dateFields = ['fechaNacimiento', 'fechaFirma']; // Lista de campos de fecha

        console.log('🔧 prepareDataForFileMaker - Entrada:', formData);

        Object.entries(formData).forEach(([key, value]) => {
          // Si es un campo de fecha, convertir el formato
          if (dateFields.includes(key) && value) {
            console.log(`  📅 Campo de fecha detectado: ${key} = "${value}"`);
            const converted = convertDateForFileMaker(value);
            prepared[key] = converted;
            console.log(`  ✓ Resultado: ${key} = "${converted}"`);
          } else {
            prepared[key] = value;
          }
        });

        console.log('🔧 prepareDataForFileMaker - Salida:', prepared);
        return prepared;
      };

      // Función para generar un resumen legible de los campos modificados
      const generateModificationSummary = (modifiedFields) => {
        if (!modifiedFields || Object.keys(modifiedFields).length === 0) {
          return 'Sin cambios';
        }

        // Mapeo de nombres técnicos a nombres legibles
        const fieldNamesMap = {
          nombre: 'nombre',
          apellido1: 'primer apellido',
          apellido2: 'segundo apellido',
          tipoDocumentoIdentidad: 'tipo de documento',
          nDocumentoIdentidad: 'número de documento',
          fechaNacimiento: 'fecha de nacimiento',
          edad: 'edad',
          nAfiliacionSS: 'número de afiliación a la seguridad social',
          nacionalidad: 'nacionalidad',
          nivelFormativoTrabajador: 'nivel formativo',
          telefono1: 'teléfono principal',
          telefono2: 'teléfono alternativo',
          correoPersonal: 'correo personal',
          correoPlataforma: 'correo de plataforma',
          telefonoBoltCompleto: 'teléfono de Bolt',
          tipoVia: 'tipo de vía',
          nombreVia: 'nombre de vía',
          numero: 'número',
          pisoYLetra: 'piso y letra',
          cp: 'código postal',
          localidad: 'localidad',
          provincia: 'provincia',
          fechaFirma: 'fecha de firma',
          estado: 'estado'
        };

        // Obtener los nombres legibles de los campos modificados
        const fieldNames = Object.keys(modifiedFields).map(key => {
          return fieldNamesMap[key] || key;
        });

        // Construir el resumen
        if (fieldNames.length === 1) {
          return `Cambio en ${fieldNames[0]}`;
        } else if (fieldNames.length === 2) {
          return `Cambios en ${fieldNames[0]} y ${fieldNames[1]}`;
        } else if (fieldNames.length <= 5) {
          // Para 3-5 campos, listar todos
          const lastField = fieldNames.pop();
          return `Cambios en ${fieldNames.join(', ')} y ${lastField}`;
        } else {
          // Para más de 5 campos, mostrar los primeros 3 y el total
          const firstThree = fieldNames.slice(0, 3).join(', ');
          const remaining = fieldNames.length - 3;
          return `Cambios en ${firstThree} y ${remaining} campos más`;
        }
      };

      // Función para obtener solo los campos que han sido modificados
      const getModifiedFields = (originalData, currentFormData) => {
        if (!originalData) {
          // Si no hay datos originales, devolver todos los datos actuales
          return currentFormData;
        }

        const modifiedFields = {};
        let hasChanges = false;

        // Comparar cada campo del formulario con los datos originales
        Object.keys(currentFormData).forEach(key => {
          const currentValue = currentFormData[key];
          const originalValue = originalData[key];

          // Normalizar valores para comparación (tratar null, undefined y '' como equivalentes)
          const normalizedCurrent = (currentValue == null || currentValue === '') ? '' : String(currentValue).trim();
          const normalizedOriginal = (originalValue == null || originalValue === '') ? '' : String(originalValue).trim();

          // Si los valores son diferentes, agregar al objeto de cambios
          if (normalizedCurrent !== normalizedOriginal) {
            modifiedFields[key] = currentValue;
            hasChanges = true;
            console.log(`  📝 Campo modificado: ${key}`);
            console.log(`     - Original: "${normalizedOriginal}"`);
            console.log(`     - Nuevo: "${normalizedCurrent}"`);
          }
        });

        if (!hasChanges) {
          console.log('  ℹ️ No se detectaron cambios en los campos');
        }

        return hasChanges ? modifiedFields : currentFormData;
      };

      // Función para actualizar el título del encabezado con el nombre del conductor
      const updatePageTitle = (data) => {
        if (!data || !pageTitleEl) {
          return;
        }

        // Construir el nombre completo
        const nombre = data.nombre || '';
        const apellido1 = data.apellido1 || '';
        const apellido2 = data.apellido2 || '';
        const nombreCompleto = [nombre, apellido1, apellido2].filter(Boolean).join(' ').trim();

        if (nombreCompleto) {
          pageTitleEl.textContent = nombreCompleto.toUpperCase();
          console.log('✅ Título de página actualizado:', nombreCompleto);
        }

        // Actualizar el subtítulo con el documento
        if (pageSubtitleEl && data.nDocumentoIdentidad) {
          pageSubtitleEl.textContent = data.nDocumentoIdentidad;
          console.log('✅ Subtítulo de página actualizado:', data.nDocumentoIdentidad);
        }
      };

      // Función para rellenar el formulario con los datos del conductor
      const fillConductorForm = (data) => {
        if (!data) {
          console.warn('⚠️ fillConductorForm: No hay datos para rellenar');
          return;
        }

        console.log('🔧 Rellenando formulario con datos:', data);

        // Mapeo de campos del formulario a campos de FileMaker
        const fieldMapping = {
          'procesoNombre': 'nombre',
          'procesoApellido1': 'apellido1',
          'procesoApellido2': 'apellido2',
          'procesoTipoDocumento': 'tipoDocumentoIdentidad',
          'procesoDocumento': 'nDocumentoIdentidad',
          'procesoFechaNacimiento': 'fechaNacimiento',
          'procesoEdad': 'edad',
          'procesoNAfiliacionSS': 'nAfiliacionSS',
          'procesoNacionalidad': 'nacionalidad',
          'procesoNivelFormativo': 'nivelFormativoTrabajador',
          'procesoTelefono1': 'telefono1',
          'procesoTelefono2': 'telefono2',
          'procesoCorreoPersonal': 'correoPersonal',
          'procesoCorreoPlataforma': 'correoPlataforma',
          'procesoTelefonoBolt': 'telefonoBoltCompleto',
          'procesoTipoVia': 'tipoVia',
          'procesoNombreVia': 'nombreVia',
          'procesoNumero': 'numero',
          'procesoPisoLetra': 'pisoYLetra',
          'procesoCP': 'cp',
          'procesoLocalidad': 'localidad',
          'procesoProvincia': 'provincia',
          'procesoFechaFirma': 'fechaFirma',
          'procesoEstado': 'estado'
        };

        // Guardar datos originales usando los nombres de los campos de FileMaker
        // que coinciden con los atributos 'name' del formulario
        originalConductorData = {};
        Object.entries(fieldMapping).forEach(([fieldId, dataKey]) => {
          // Usar directamente dataKey ya que coincide con el atributo 'name' del formulario
          originalConductorData[dataKey] = data[dataKey] ?? '';
        });
        console.log('💾 Datos originales guardados para comparación:', originalConductorData);

        let fieldsFound = 0;
        let fieldsFilled = 0;

        // Rellenar cada campo
        Object.entries(fieldMapping).forEach(([fieldId, dataKey]) => {
          const field = document.getElementById(fieldId);

          if (!field) {
            console.warn(`  ⚠️ Campo ${fieldId} no encontrado en el DOM`);
            return;
          }

          fieldsFound++;

          if (data[dataKey] !== undefined && data[dataKey] !== null && data[dataKey] !== '') {
            const value = data[dataKey];
            console.log(`  ✓ Rellenando ${fieldId} con valor:`, value);

            // Para campos Select2, usar jQuery para establecer el valor
            if (field.classList.contains('select2-hidden-accessible')) {
              // Caso especial: Select de Teléfono Bolt
              // Si el valor no existe como opción, añadirlo antes de establecerlo
              if (fieldId === 'procesoTelefonoBolt' && value) {
                const optionExists = Array.from(field.options).some(opt => opt.value === value);
                if (!optionExists) {
                  console.log(`  ℹ️ Añadiendo opción faltante al select: ${value}`);
                  const newOption = document.createElement('option');
                  newOption.value = value;
                  newOption.textContent = value;
                  field.appendChild(newOption);
                }
              }

              jQuery(field).val(value).trigger('change');
            }
            // Para campos de fecha con Flatpickr
            else if (field._flatpickr) {
              // Convertir fecha de formato d/m/Y a objeto Date
              const dateParts = value.split('/');
              if (dateParts.length === 3) {
                const [day, month, year] = dateParts;
                const dateObj = new Date(year, month - 1, day);
                field._flatpickr.setDate(dateObj, false);
              }
            }
            else {
              field.value = value;
            }
            fieldsFilled++;
          } else {
            console.log(`  - Campo ${fieldId} sin datos (${dataKey}):`, data[dataKey]);
          }
        });

        console.log(`✅ Formulario procesado: ${fieldsFound} campos encontrados, ${fieldsFilled} campos rellenados`);

        // Actualizar resaltado de campos vacíos
        updateEmptyFieldsHighlight();

        // Actualizar progreso del wizard después de un pequeño delay para asegurar
        // que Flatpickr y Select2 estén completamente inicializados
        setTimeout(() => {
          console.log('🔄 Actualizando progreso del wizard tras inicialización de campos...');
          updateWizardProgress();
        }, 100);

        // Verificar el estado del botón publicar después de cargar los datos
        if (typeof window.checkFormChangesAfterLoad === 'function') {
          window.checkFormChangesAfterLoad();
        }
      };

      // Inicializar el select de nacionalidad en el formulario del proceso
      const procesoNationalitySelect = document.querySelector('[data-proceso-nacionalidad]');
      if (procesoNationalitySelect && !procesoNationalitySelect.dataset.optionsLoaded) {
        const existingValues = new Set(Array.from(procesoNationalitySelect.options).map((option) => option.value));
        COUNTRIES.forEach((country) => {
          if (!existingValues.has(country)) {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            procesoNationalitySelect.appendChild(option);
          }
        });
        procesoNationalitySelect.dataset.optionsLoaded = 'true';

        // Inicializar Select2 si está disponible
        if (window.jQuery?.fn?.select2) {
          const $procesoNationalitySelect = window.jQuery(procesoNationalitySelect);
          $procesoNationalitySelect.select2({
            width: '100%',
            placeholder: procesoNationalitySelect.dataset.placeholder || 'Selecciona un país',
            allowClear: true,
            language: {
              noResults: () => 'Sin resultados',
              searching: () => 'Buscando...',
              removeAllItems: () => 'Eliminar selección'
            }
          });
        }
      }

      // Cargar datos del conductor al iniciar
      loadConductorData();

      // Validación y cálculo automático de letra para DNI y NIE
      const setupDocumentoValidation = () => {
        const tipoDocField = document.getElementById('procesoTipoDocumento');
        const numeroDocField = document.getElementById('procesoDocumento');

        if (!tipoDocField || !numeroDocField) {
          return;
        }

        // Tabla de letras para DNI/NIE
        const letrasDNI = 'TRWAGMYFPDXBNJZSQVHLCKE';

        // Calcular letra de DNI
        const calcularLetraDNI = (numero) => {
          const num = parseInt(numero, 10);
          if (isNaN(num)) return null;
          return letrasDNI.charAt(num % 23);
        };

        // Calcular letra de NIE
        const calcularLetraNIE = (nie) => {
          // Convertir la primera letra a número: X=0, Y=1, Z=2
          const conversiones = { 'X': '0', 'Y': '1', 'Z': '2' };
          const primeraLetra = nie.charAt(0).toUpperCase();

          if (!conversiones[primeraLetra]) {
            return null;
          }

          const numeroConvertido = conversiones[primeraLetra] + nie.substring(1, nie.length - 1);
          const num = parseInt(numeroConvertido, 10);

          if (isNaN(num)) return null;
          return letrasDNI.charAt(num % 23);
        };

        // Validar y autocompletar letra
        const validarDocumento = () => {
          const tipo = tipoDocField.value;
          const valor = numeroDocField.value.trim().toUpperCase();

          if (!tipo || !valor) {
            numeroDocField.classList.remove('is-valid', 'is-invalid');
            return;
          }

          if (tipo === 'DNI') {
            // Formato DNI: 8 dígitos + letra (ej: 12345678Z)
            const regexDNI = /^(\d{1,8})([A-Z]?)$/;
            const match = valor.match(regexDNI);

            if (!match) {
              numeroDocField.classList.remove('is-valid');
              numeroDocField.classList.add('is-invalid');
              return;
            }

            const numeros = match[1].padStart(8, '0'); // Asegurar 8 dígitos
            const letraIntroducida = match[2];
            const letraCorrecta = calcularLetraDNI(numeros);

            if (letraIntroducida === '') {
              // Autocompletar la letra
              numeroDocField.value = numeros + letraCorrecta;
              numeroDocField.classList.remove('is-invalid');
              numeroDocField.classList.add('is-valid');
            } else if (letraIntroducida === letraCorrecta) {
              // Letra correcta
              numeroDocField.value = numeros + letraCorrecta;
              numeroDocField.classList.remove('is-invalid');
              numeroDocField.classList.add('is-valid');
            } else {
              // Letra incorrecta
              numeroDocField.classList.remove('is-valid');
              numeroDocField.classList.add('is-invalid');
            }

          } else if (tipo === 'NIE') {
            // Formato NIE: X/Y/Z + 7 dígitos + letra (ej: X1234567L)
            const regexNIE = /^([XYZ])(\d{1,7})([A-Z]?)$/;
            const match = valor.match(regexNIE);

            if (!match) {
              numeroDocField.classList.remove('is-valid');
              numeroDocField.classList.add('is-invalid');
              return;
            }

            const letraInicial = match[1];
            const numeros = match[2].padStart(7, '0'); // Asegurar 7 dígitos
            const letraIntroducida = match[3];
            const nieCompleto = letraInicial + numeros;
            const letraCorrecta = calcularLetraNIE(nieCompleto + 'A'); // Temporal para calcular

            if (letraIntroducida === '') {
              // Autocompletar la letra
              numeroDocField.value = nieCompleto + letraCorrecta;
              numeroDocField.classList.remove('is-invalid');
              numeroDocField.classList.add('is-valid');
            } else if (letraIntroducida === letraCorrecta) {
              // Letra correcta
              numeroDocField.value = nieCompleto + letraCorrecta;
              numeroDocField.classList.remove('is-invalid');
              numeroDocField.classList.add('is-valid');
            } else {
              // Letra incorrecta
              numeroDocField.classList.remove('is-valid');
              numeroDocField.classList.add('is-invalid');
            }
          }
        };

        // Eventos
        numeroDocField.addEventListener('blur', validarDocumento);
        numeroDocField.addEventListener('input', () => {
          // Limpiar estados mientras escribe
          if (numeroDocField.value.trim() === '') {
            numeroDocField.classList.remove('is-valid', 'is-invalid');
          }
        });
        tipoDocField.addEventListener('change', () => {
          // Re-validar cuando cambie el tipo
          numeroDocField.classList.remove('is-valid', 'is-invalid');
          if (numeroDocField.value.trim() !== '') {
            validarDocumento();
          }
        });
      };

      // Inicializar validación de documento
      setupDocumentoValidation();

      // Validación del número de afiliación a la Seguridad Social
      const setupNASSValidation = () => {
        const nassField = document.getElementById('procesoNAfiliacionSS');

        if (!nassField) {
          return;
        }

        const validarNASS = () => {
          const valor = nassField.value.trim();

          // Si está vacío, no validar (campo no obligatorio)
          if (valor === '') {
            nassField.classList.remove('is-valid', 'is-invalid');
            return;
          }

          // Eliminar espacios y barras si los hubiera
          const nass = valor.replace(/[\s\-\/]/g, '');

          // El NASS debe tener exactamente 12 dígitos
          if (!/^\d{12}$/.test(nass)) {
            nassField.classList.remove('is-valid');
            nassField.classList.add('is-invalid');
            return;
          }

          // Validar dígitos de control
          // Los dos últimos dígitos son de control
          const numeroBase = nass.substring(0, 10);
          const digitosControl = nass.substring(10, 12);

          // Calcular dígitos de control: módulo 97 del número base
          const resto = parseInt(numeroBase, 10) % 97;
          const digitosCalculados = resto.toString().padStart(2, '0');

          if (digitosControl === digitosCalculados) {
            nassField.classList.remove('is-invalid');
            nassField.classList.add('is-valid');
            // Formatear el número con espacios o barras si se desea
            // nassField.value = nass;
          } else {
            nassField.classList.remove('is-valid');
            nassField.classList.add('is-invalid');
          }
        };

        // Validar al perder el foco
        nassField.addEventListener('blur', validarNASS);

        // Limpiar validación mientras escribe
        nassField.addEventListener('input', () => {
          nassField.classList.remove('is-valid', 'is-invalid');
        });
      };

      // Inicializar validación de NASS
      setupNASSValidation();

      // Validación de números de teléfono
      const setupPhoneValidation = () => {
        const phoneFields = [
          document.getElementById('procesoTelefono1'),
          document.getElementById('procesoTelefono2')
        ];

        const validarTelefono = (field) => {
          const valor = field.value.trim();

          // Si está vacío, no validar
          if (valor === '') {
            field.classList.remove('is-valid', 'is-invalid');
            return;
          }

          // Eliminar espacios, guiones y paréntesis
          const telefono = valor.replace(/[\s\-\(\)]/g, '');

          // Validar teléfonos españoles:
          // - Móviles: 9 dígitos que empiezan por 6 o 7
          // - Fijos: 9 dígitos que empiezan por 8 o 9
          // - Con prefijo internacional: +34 seguido de 9 dígitos
          const regexMovil = /^[67]\d{8}$/;
          const regexFijo = /^[89]\d{8}$/;
          const regexInternacional = /^\+34[6-9]\d{8}$/;

          if (regexMovil.test(telefono) || regexFijo.test(telefono) || regexInternacional.test(telefono)) {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
          } else {
            field.classList.remove('is-valid');
            field.classList.add('is-invalid');
          }
        };

        phoneFields.forEach(field => {
          if (field) {
            // Validar al perder el foco
            field.addEventListener('blur', () => validarTelefono(field));

            // Limpiar validación mientras escribe
            field.addEventListener('input', () => {
              field.classList.remove('is-valid', 'is-invalid');
            });
          }
        });
      };

      // Validación de emails
      const setupEmailValidation = () => {
        const emailFields = [
          document.getElementById('procesoCorreoPersonal'),
          document.getElementById('procesoCorreoPlataforma')
        ];

        const validarEmail = (field) => {
          const valor = field.value.trim();

          // Si está vacío, no validar
          if (valor === '') {
            field.classList.remove('is-valid', 'is-invalid');
            return;
          }

          // Regex para validar email
          const regexEmail = /^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/;

          if (regexEmail.test(valor)) {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
          } else {
            field.classList.remove('is-valid');
            field.classList.add('is-invalid');
          }
        };

        emailFields.forEach(field => {
          if (field) {
            // Validar al perder el foco
            field.addEventListener('blur', () => validarEmail(field));

            // Limpiar validación mientras escribe
            field.addEventListener('input', () => {
              field.classList.remove('is-valid', 'is-invalid');
            });
          }
        });
      };

      // Inicializar validaciones de teléfono y email
      setupPhoneValidation();
      setupEmailValidation();

      // Autocompletado de Localidad y Provincia por Código Postal
      const setupPostalCodeAutocomplete = () => {
        const cpField = document.getElementById('procesoCP');
        const localidadField = document.getElementById('procesoLocalidad');
        const provinciaField = document.getElementById('procesoProvincia');

        if (!cpField || !localidadField || !provinciaField) {
          return;
        }

        // Mapa de provincias españolas por código postal (dos primeros dígitos)
        const provinciasMap = {
          '01': 'Álava', '02': 'Albacete', '03': 'Alicante', '04': 'Almería',
          '05': 'Ávila', '06': 'Badajoz', '07': 'Islas Baleares', '08': 'Barcelona',
          '09': 'Burgos', '10': 'Cáceres', '11': 'Cádiz', '12': 'Castellón',
          '13': 'Ciudad Real', '14': 'Córdoba', '15': 'A Coruña', '16': 'Cuenca',
          '17': 'Girona', '18': 'Granada', '19': 'Guadalajara', '20': 'Guipúzcoa',
          '21': 'Huelva', '22': 'Huesca', '23': 'Jaén', '24': 'León',
          '25': 'Lleida', '26': 'La Rioja', '27': 'Lugo', '28': 'Madrid',
          '29': 'Málaga', '30': 'Murcia', '31': 'Navarra', '32': 'Ourense',
          '33': 'Asturias', '34': 'Palencia', '35': 'Las Palmas', '36': 'Pontevedra',
          '37': 'Salamanca', '38': 'Santa Cruz de Tenerife', '39': 'Cantabria', '40': 'Segovia',
          '41': 'Sevilla', '42': 'Soria', '43': 'Tarragona', '44': 'Teruel',
          '45': 'Toledo', '46': 'Valencia', '47': 'Valladolid', '48': 'Vizcaya',
          '49': 'Zamora', '50': 'Zaragoza', '51': 'Ceuta', '52': 'Melilla'
        };

        let debounceTimer;

        const lookupPostalCode = async (cp) => {
          // Validar formato de código postal español (5 dígitos)
          if (!/^\d{5}$/.test(cp)) {
            return;
          }

          // Obtener provincia por los dos primeros dígitos
          const codigoProvincia = cp.substring(0, 2);
          const provincia = provinciasMap[codigoProvincia];

          try {
            // Usar API pública de códigos postales de España para obtener la localidad
            const response = await fetch(`https://api.zippopotam.us/es/${cp}`);

            if (response.ok) {
              const data = await response.json();

              if (data && data.places && data.places.length > 0) {
                const place = data.places[0];

                // Autocompletar campos
                localidadField.value = place['place name'] || '';
                provinciaField.value = provincia || '';

                // Añadir feedback visual sutil
                localidadField.classList.add('border-success');
                provinciaField.classList.add('border-success');

                setTimeout(() => {
                  localidadField.classList.remove('border-success');
                  provinciaField.classList.remove('border-success');
                }, 2000);
              }
            } else {
              // Si la API no responde pero tenemos la provincia, al menos completamos eso
              if (provincia) {
                provinciaField.value = provincia;
                provinciaField.classList.add('border-success');
                setTimeout(() => {
                  provinciaField.classList.remove('border-success');
                }, 2000);
              }
              console.log('Código postal no encontrado en API:', cp);
            }
          } catch (error) {
            console.error('Error al buscar código postal:', error);
            // En caso de error con la API, al menos completamos la provincia si la conocemos
            if (provincia) {
              provinciaField.value = provincia;
            }
          }
        };

        // Listener con debounce
        cpField.addEventListener('input', (e) => {
          clearTimeout(debounceTimer);
          const value = e.target.value.trim();

          if (value.length === 5) {
            debounceTimer = setTimeout(() => {
              lookupPostalCode(value);
            }, 500);
          }
        });

        // También buscar al perder el foco
        cpField.addEventListener('blur', (e) => {
          const value = e.target.value.trim();
          if (value.length === 5) {
            lookupPostalCode(value);
          }
        });
      };

      // Inicializar autocompletado de CP
      setupPostalCodeAutocomplete();

      // Inicializar Flatpickr para los campos de fecha
      const setupDatePickers = () => {
        const fechaNacimientoField = document.getElementById('procesoFechaNacimiento');
        const fechaFirmaField = document.getElementById('procesoFechaFirma');
        const edadField = document.getElementById('procesoEdad');

        // Función para calcular la edad
        const calcularEdad = (fechaNacimiento) => {
          if (!fechaNacimiento) return '';

          const hoy = new Date();
          const nacimiento = new Date(fechaNacimiento);

          let edad = hoy.getFullYear() - nacimiento.getFullYear();
          const mes = hoy.getMonth() - nacimiento.getMonth();

          // Si aún no ha cumplido años este año, restar 1
          if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
            edad--;
          }

          return edad;
        };

        if (fechaNacimientoField && window.flatpickr) {
          // Guardar el valor que ya está en el campo (si lo hay) antes de inicializar Flatpickr
          const existingValue = fechaNacimientoField.value || '';

          const flatpickrInstance = window.flatpickr(fechaNacimientoField, {
            dateFormat: 'd/m/Y',
            locale: 'es',
            allowInput: true,
            altInput: true,
            altFormat: 'd/m/Y',
            maxDate: 'today',
            yearRange: [1920, new Date().getFullYear()],
            disableMobile: true,
            onChange: function(selectedDates, dateStr, instance) {
              // Calcular y actualizar la edad cuando cambie la fecha
              if (selectedDates.length > 0 && edadField) {
                const edad = calcularEdad(selectedDates[0]);
                edadField.value = edad;
              } else if (edadField) {
                // Si se limpia la fecha, limpiar también la edad
                edadField.value = '';
              }
            },
            onReady: function(selectedDates, dateStr, instance) {
              // Si había un valor antes de inicializar, establecerlo en Flatpickr
              if (existingValue) {
                console.log('🔄 Restableciendo valor de fecha en Flatpickr:', existingValue);
                const dateParts = existingValue.split('/');
                if (dateParts.length === 3) {
                  const [day, month, year] = dateParts;
                  const dateObj = new Date(year, month - 1, day);
                  instance.setDate(dateObj, false);

                  // Actualizar también la edad
                  if (edadField) {
                    const edad = calcularEdad(dateObj);
                    edadField.value = edad;
                  }
                }
              }

              // Personalizar el botón de limpiar
              const clearBtn = document.createElement('div');
              clearBtn.className = 'flatpickr-clear';
              clearBtn.innerHTML = '<i class="link-icon" data-feather="x"></i> Limpiar';
              clearBtn.addEventListener('click', () => {
                instance.clear();
                // Limpiar también la edad al limpiar la fecha
                if (edadField) {
                  edadField.value = '';
                }
              });
              instance.calendarContainer.appendChild(clearBtn);

              // Actualizar el progreso del wizard después de inicializar Flatpickr
              if (typeof updateWizardProgress === 'function') {
                console.log('🔄 Actualizando progreso del wizard después de inicializar Flatpickr de fecha nacimiento');
                updateWizardProgress();
              }
            }
          });

          // Listener adicional para cuando el usuario escribe manualmente la fecha
          if (fechaNacimientoField && edadField) {
            // Obtener el input alternativo (el que muestra el formato legible)
            const altInput = fechaNacimientoField.nextElementSibling;

            if (altInput) {
              altInput.addEventListener('blur', () => {
                // Dar tiempo a flatpickr para procesar la fecha escrita
                setTimeout(() => {
                  if (flatpickrInstance.selectedDates.length > 0) {
                    const edad = calcularEdad(flatpickrInstance.selectedDates[0]);
                    edadField.value = edad;
                  } else if (altInput.value === '') {
                    edadField.value = '';
                  }
                }, 100);
              });
            }
          }
        }

        if (fechaFirmaField && window.flatpickr) {
          // Guardar el valor que ya está en el campo (si lo hay) antes de inicializar Flatpickr
          const existingValue = fechaFirmaField.value || '';

          window.flatpickr(fechaFirmaField, {
            dateFormat: 'd/m/Y',
            locale: 'es',
            allowInput: true,
            altInput: true,
            altFormat: 'd/m/Y',
            disableMobile: true,
            onReady: function(selectedDates, dateStr, instance) {
              // Si había un valor antes de inicializar, establecerlo en Flatpickr
              if (existingValue) {
                console.log('🔄 Restableciendo valor de fecha firma en Flatpickr:', existingValue);
                const dateParts = existingValue.split('/');
                if (dateParts.length === 3) {
                  const [day, month, year] = dateParts;
                  const dateObj = new Date(year, month - 1, day);
                  instance.setDate(dateObj, false);
                }
              }

              // Personalizar el botón de limpiar
              const clearBtn = document.createElement('div');
              clearBtn.className = 'flatpickr-clear';
              clearBtn.innerHTML = '<i class="link-icon" data-feather="x"></i> Limpiar';
              clearBtn.addEventListener('click', () => {
                instance.clear();
              });
              instance.calendarContainer.appendChild(clearBtn);

              // Actualizar el progreso del wizard después de inicializar Flatpickr
              if (typeof updateWizardProgress === 'function') {
                console.log('🔄 Actualizando progreso del wizard después de inicializar Flatpickr de fecha firma');
                updateWizardProgress();
              }
            }
          });
        }
      };

      // Inicializar date pickers
      setupDatePickers();

      // Guardar referencia para inicializar Select2 después
      window.initBoltPhoneSelect = async () => {
        const selectElement = document.querySelector('[data-bolt-phone-select]');
        if (!selectElement) {
          return;
        }

        // Guardar el valor que ya estaba seleccionado antes de reinicializar
        const existingValue = selectElement.value || '';

        try {
          // Cargar datos desde FileMaker
          const layoutName = 'conductor.boltDatosConductor';
          const response = await window.ApiClient.get(`layouts/${window.ApiClient.encodePathSegment(layoutName)}/records?_limit=1000`);

          if (!response.ok) {
            throw new Error(`Error al cargar datos: ${response.status}`);
          }

          const data = await response.json();
          const records = data?.response?.data || [];

          // Limpiar opciones existentes
          selectElement.innerHTML = '<option value="">Selecciona un teléfono</option>';

          // Agregar opciones con formato: "Nombre (Teléfono)" pero valor solo teléfono
          records.forEach((record) => {
            const fieldData = record.fieldData || {};
            const nombre = fieldData.nombre || '';
            const telefono = fieldData.telefono || '';

            if (telefono) {
              const option = document.createElement('option');
              option.value = telefono;
              option.textContent = nombre ? `${nombre} (${telefono})` : telefono;
              selectElement.appendChild(option);
            }
          });

          // Si había un valor seleccionado y no existe en las opciones, añadirlo
          if (existingValue && !Array.from(selectElement.options).some(opt => opt.value === existingValue)) {
            console.log('🔄 Añadiendo opción de teléfono Bolt que no existía:', existingValue);
            const option = document.createElement('option');
            option.value = existingValue;
            option.textContent = existingValue;
            selectElement.appendChild(option);
          }

          // Inicializar Select2 con configuración personalizada
          if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
            jQuery(selectElement).select2({
              placeholder: 'Buscar por nombre o teléfono...',
              allowClear: true,
              language: {
                noResults: function() {
                  return 'No se encontraron resultados';
                },
                searching: function() {
                  return 'Buscando...';
                }
              },
              width: '100%',
              templateSelection: function(data) {
                // Mostrar solo el valor (teléfono) cuando está seleccionado
                if (data.id) {
                  return data.id;
                }
                return data.text;
              }
            });

            // Restaurar el valor si lo había
            if (existingValue) {
              console.log('🔄 Restableciendo valor de teléfono Bolt en Select2:', existingValue);
              jQuery(selectElement).val(existingValue).trigger('change');
            }

            // Actualizar el progreso del wizard después de inicializar Select2
            setTimeout(() => {
              if (typeof updateWizardProgress === 'function') {
                console.log('🔄 Actualizando progreso del wizard después de inicializar Select2 de teléfono Bolt');
                updateWizardProgress();
              }
            }, 50);
          }

        } catch (error) {
          console.error('Error al cargar datos de Bolt:', error);
          selectElement.innerHTML = '<option value="">Error al cargar datos</option>';
        }
      };

      // Inicializar Select2 para Tipo de Vía
      window.initTipoViaSelect = () => {
        const selectElement = document.querySelector('[data-tipo-via-select]');
        if (!selectElement) {
          return;
        }

        // Lista completa de tipos de vía en España (ordenada alfabéticamente)
        const tiposVia = [
          'Acceso',
          'Alameda',
          'Aldea',
          'Apartamentos',
          'Avenida',
          'Bajada',
          'Barranquera',
          'Barrio',
          'Bloque',
          'Calle',
          'Calleja',
          'Callejón',
          'Calzada',
          'Camino',
          'Carrera',
          'Carretera',
          'Caserío',
          'Chalet',
          'Colegio',
          'Colonia',
          'Complejo',
          'Conjunto',
          'Convento',
          'Cooperativa',
          'Corredor',
          'Cortijo',
          'Costanilla',
          'Cuesta',
          'Edificio',
          'Entrada',
          'Escalera',
          'Escalinata',
          'Explanada',
          'Extramuros',
          'Extrarradio',
          'Finca',
          'Glorieta',
          'Gran Vía',
          'Grupo',
          'Jardines',
          'Malecón',
          'Manzana',
          'Mercado',
          'Mirador',
          'Monasterio',
          'Muelle',
          'Núcleo',
          'Palacio',
          'Paraje',
          'Parque',
          'Particular',
          'Partida',
          'Pasadizo',
          'Pasaje',
          'Paseo',
          'Patio',
          'Plaza',
          'Plazoleta',
          'Plazuela',
          'Poblado',
          'Polígono',
          'Portal',
          'Pórtico',
          'Prolongación',
          'Pueblo',
          'Puente',
          'Puerta',
          'Puerto',
          'Rambleta',
          'Rambla',
          'Ramal',
          'Rampla',
          'Residencial',
          'Rincón',
          'Rinconada',
          'Ronda',
          'Rúa',
          'Salida',
          'Sector',
          'Sendero',
          'Subida',
          'Torrente',
          'Travesía',
          'Urbanización',
          'Vecindario',
          'Vereda',
          'Viaducto',
          'Vía',
          'Villa'
        ];

        // Limpiar y agregar opciones
        selectElement.innerHTML = '<option value="">Selecciona un tipo de vía</option>';

        tiposVia.forEach(tipo => {
          const option = document.createElement('option');
          option.value = tipo;
          option.textContent = tipo;
          selectElement.appendChild(option);
        });

        // Inicializar Select2
        if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
          jQuery(selectElement).select2({
            placeholder: 'Buscar tipo de vía...',
            allowClear: true,
            language: {
              noResults: function() {
                return 'No se encontraron resultados';
              },
              searching: function() {
                return 'Buscando...';
              }
            },
            width: '100%'
          });
        }
      };
    });
  </script>

  <!-- Plugin js for this page -->
  <script src="./assets/vendors/datatables.net/dataTables.js"></script>
  <script src="./assets/vendors/datatables.net-bs5/dataTables.bootstrap5.js"></script>
  <!-- End plugin js for this page -->

  <script src="./assets/js/dashboard.js"></script>
  <script src="./assets/js/clientes-table.js"></script>

  <script>
    // Inicializar Select2 para teléfono Bolt después de que jQuery esté disponible
    jQuery(document).ready(function() {
      console.log('jQuery disponible:', typeof jQuery !== 'undefined');
      console.log('Select2 disponible:', typeof jQuery.fn.select2 !== 'undefined');
      console.log('Función initBoltPhoneSelect disponible:', typeof window.initBoltPhoneSelect === 'function');

      if (typeof window.initBoltPhoneSelect === 'function') {
        console.log('Ejecutando initBoltPhoneSelect...');
        window.initBoltPhoneSelect().then(() => {
          console.log('Select2 inicializado correctamente');

          // Verificar si Select2 se aplicó correctamente
          const selectElement = document.querySelector('[data-bolt-phone-select]');
          if (selectElement) {
            console.log('Elemento select encontrado:', selectElement);
            console.log('¿Tiene clase select2-hidden-accessible?', selectElement.classList.contains('select2-hidden-accessible'));
          }
        }).catch(err => {
          console.error('Error al inicializar Select2:', err);
        });
      }

      // Inicializar Select2 para Tipo de Vía
      if (typeof window.initTipoViaSelect === 'function') {
        console.log('Ejecutando initTipoViaSelect...');
        window.initTipoViaSelect();
        console.log('Select2 de Tipo de Vía inicializado correctamente');
      }
    });
  </script>

</body>
</html>
